#!/bin/sh

if [ "$SRB2BLDDEBUG" = 1 ]; then

    set -e -x

else

    set -e

fi

# Set environment variables.
if [ "$(uname)" = "Darwin" ]; then

    PRINTF="printf"

else

    PRINTF=$(which -a printf | gawk '/bin/ {print}' | head -n1)

fi

ARCH=$(uname -m)
OS=$(uname)

if [ "$OS" = "Linux" ]; then

    OSID=$(gawk -F'=' '/^ID_LIKE=/ {gsub("\"","");print $NF}' /etc/os-release)
    OSNAME=$(gawk -F'=' '/^NAME=/ {gsub("\"","");print $NF}' /etc/os-release)

fi

IS64=$($PRINTF "%s\n" "$ARCH" | gawk 'match($0, /64/) {print substr($0, RSTART, RLENGTH)}')
USER=$(whoami)

if [ "$OS" = "Darwin" ]; then

    SRB2BLDROOT="$HOME/Library/srb2bld"

elif [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

    SRB2BLDROOT="$HOME/AppData/Roaming/srb2bld"

else

    SRB2BLDROOT="$HOME/.local/share/srb2bld"

fi

if [ -x "$(which doas 2> /dev/null)" ]; then

    SUDO="doas"

else

    SUDO="sudo"

fi

# Determine installation prefix from user's input.
if [ -n "$($PRINTF "%s\n" "$*" | gawk 'match($0, /-u/) {print substr($0, RSTART, RLENGTH)}')" ] || [ -n "$($PRINTF "%s\n" "$*" | gawk 'match($0, /--user/) {print substr($0, RSTART, RLENGTH)}')" ]; then

    if [ "$OS" = "Linux" ]; then

        SRB2BLDPREFIX="$HOME/.local"

    elif [ "$OS" = "Darwin" ]; then

        SRB2BLDPREFIX="$HOME/Local"

    else

        SRB2BLDPREFIX="/usr/local"

    fi

else

    SRB2BLDPREFIX="/usr/local"

fi

BUILDPATH="$SRB2BLDROOT/builds"
DEBVER="jessie"
UBUVER="18.04"
UBUSOFTVER="22.04"
SRB2RPHYSASSETURL="https://mb.srb2.org/addons/4008/download"
SRB2PERSONAASSETURL="https://mb.srb2.org/addons/166/download"
MINGWCCVER="gcc-10-win32"
MINGWOLDCCVER="gcc-4.9-win32"
MINGWCXXVER="g++-10-win32"

if [ "$(ldd --version 2>&1 | gawk 'match($0, /musl/) {print substr($0, RSTART, RLENGTH)}' | gawk '!a[$0]++ {print}')" = "musl" ]; then

    GCCVER="gcc"
    GCCOLDVER="gcc-6"
    GXXVER="g++"

else

    GCCVER="gcc-11"
    GCCOLDVER="gcc-4.9"
    GXXVER="g++-11"

fi

if [ "$OSID" = "debian" ] || [ "$OSID" = "ubuntu" ] || [ "$OSNAME" = "Debian GNU/Linux" ] || [ "$OSNAME" = "Fedora Linux" ] || [ "$OSNAME" = "openSUSE Leap" ]; then

    UBUSOFTVER="20.04"

fi

LNXFMODVER="fmodapi375linux"
LNXPNG12VER="libpng12"
LNXSDL2MIXERXVER="master"
LNXOPENMPTVER="0.6.3"
LNXGMEVER="0.6.3"
LNXDISCORDRPCVER="master"
LNXOPENVRVER="1.10.30"
LNXLZFVER="master"

if [ "$OS" = "Darwin" ]; then

    MACOSVER="10.9"
    MACOSVERSLADE="11"
    MACOSPNGVER="1.6.37"
    MACOSOGGVER="1.3.5"
    MACOSVORBISVER="1.3.7"
    MACOSMPG123VER="3ebf75d28649b6"
    MACOSMODPLUGVER="master"
    MACOSSDL2VER="2.0.18"
    MACOSSDL2MIXERVER="2.0.4"
    MACOSSDL2MIXERXVER="2.5.0"
    MACOSOPENMPTVER="0.4.12"
    MACOSGMEVER="0.6.2"
    MACOSDISCORDRPCVER="master"
    MACOSOPENVRVER="1.10.30"

    if [ -x "$(which brew 2> /dev/null)" ]; then

        HOMEBREWPREFIX=$(brew --prefix)

    fi

    MACPORTPREFIX="/opt/local"

fi

COMPTABLEURL="https://gist.githubusercontent.com/Bijman/dae1e123800af25ef28689bd644a4516/raw"
FAILURE="\e[1;91m"
SUCCESS="\e[1;92m"
NOTICE="\e[1;93m"
MESSAGE="\e[1;94m"
PROMPT="\e[1;97m"

checkuserid() {
    # Check id of login running this script.
    if [ "$(id -u)" -eq 0 ]; then

        $PRINTF "$NOTICE%s\n\e\n[0m" "WARNING: It is not recommended to run srb2bld as root. Press ctrl+c to quit and run again script as user in \"docker\" group or continue."

    fi
}

appbundle() {
    clear

    # Blocking access to this option for users that uses OS other than macOS since App Bundles are macOS exclusive.
    if [ "$OS" != "Darwin" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Currently building App Bundles is only available for macOS. Exiting."
        exit

    fi

    # We have to set this in order to make App Bundle in installtomacos function.
    APPBUNDLE=1

    # Set current working directory.
    MACOSPWD="$(pwd)"

    choosebuild

    buildname

    choosebranch

    preparebuild

    settrap

    installtomacos

    # Set name of App Bundle in message.
    APPBUNDLENAME=$(find "$BUILD/build" -name "*.dmg" 2> /dev/null | gawk -F'/' '{print $NF}' | sort | head -n1)

    # Rename App Bundle and move it to working directory.
    if [ -d "$BUILD/build/package" ]; then

        mv -f "$BUILD/build/package/$APPBUNDLENAME" "$MACOSPWD/$($PRINTF "%s\n" "$BUILDNAME" | gawk '{gsub(" ","_");print}')-$GITVER-$COMREV.dmg"

    else

        mv -f "$BUILD/build/$APPBUNDLENAME" "$MACOSPWD/$($PRINTF "%s\n" "$BUILDNAME" | gawk '{gsub(" ","_");print}')-$GITVER-$COMREV.dmg"

    fi

    $PRINTF "$SUCCESS\n%s\n\e[0m\a" "App Bundle for $BUILDNAME is done. Look for $($PRINTF "%s\n" "$BUILDNAME" | gawk '{gsub(" ","_");print}')-$GITVER-$COMREV.dmg in $MACOSPWD path."
}

appimage() {
    clear

    # Blocking access to this option for users that have OS other than Linux since AppImages are Linux exclusive.
    if [ "$OS" != "Linux" ] || [ -z "$(ldd --version 2>&1 | gawk '/Free Software Foundation/ {print}')" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Currently building AppImages is only available for Linux with glibc. Exiting."
        exit

    fi

    # We have to set this in order to make AppImage in Docker container.
    APPIMAGE=1

    # Set current working directory.
    LNXPWD="$(pwd)"

    choosebuild

    buildname

    choosebranch

    preparebuild

    settrap

    sudo_ping

    dockerentry

    dockerrun

    # Export commit revision name before creating AppImage.
    export VERSION="$GITVER-$(git -C "$BUILD" rev-parse --short HEAD)"

    # Create AppImage from prepared AppDir.
    cd "$BUILD" || exit
    "$BUILD/appimagetool" -n "$BUILD/build/AppDir" 2> /dev/null

    # Set name of AppImage in message.
    APPIMAGENAME=$(find "$BUILD" -name "*.AppImage" 2> /dev/null | gawk -F'/' '{print $NF}')

    # Move created AppImage to working directory.
    mv -f "$BUILD/"*.AppImage "$LNXPWD" 2> /dev/null

    $PRINTF "$SUCCESS\n%s\n\e[0m\a" "AppImage for $BUILDNAME is done. Look for $APPIMAGENAME in $LNXPWD path."
}

buildname() {
    # Setting names for fancy display in messages.
    if [ "$BUILD" = "$BUILDPATH/srb2" ]; then

        export BUILDNAME="Sonic Robo Blast 2"

    elif [ "$BUILD" = "$BUILDPATH/srb2-uncapped-plus" ]; then

        export BUILDNAME="Sonic Robo Blast 2 Uncapped PLUS"

    elif [ "$BUILD" = "$BUILDPATH/srb2-netplus" ]; then

        export BUILDNAME="Sonic Robo Blast 2 NetPlus"

    elif [ "$BUILD" = "$BUILDPATH/srb2-rphys" ]; then

        export BUILDNAME="Sonic Robo Blast 2 rphys"

    elif [ "$BUILD" = "$BUILDPATH/srb2-vr" ]; then

        export BUILDNAME="Sonic Robo Blast 2 VR"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.1-legacy" ]; then

        export BUILDNAME="Sonic Robo Blast 2 v2.1 Legacy"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.0" ]; then

        export BUILDNAME="Sonic Robo Blast 2 v2.0"

    elif [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

        export BUILDNAME="Sonic Robo Blast 2 Final Demo"

    elif [ "$BUILD" = "$BUILDPATH/srb2-persona" ]; then

        export BUILDNAME="Sonic Robo Blast 2 Persona"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart" ]; then

        export BUILDNAME="Sonic Robo Blast 2 Kart"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart-moe-mansion" ]; then

        export BUILDNAME="Sonic Robo Blast 2 Kart Moe Mansion"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]; then

        export BUILDNAME="Sonic Robo Blast 2 Kart VR"

    elif [ "$(dirname $BUILD)" = "$BUILDPATH/srb2-custom" ]; then

        export BUILDNAME="Sonic Robo Blast 2 Custom $CUSTOMDIR"

    elif [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

        export BUILDNAME="wadcli"

    elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

        export BUILDNAME="SLADE"

    fi
}

choosebranch() {
    ISNET=$(curl -vI https://github.com 2>&1 | gawk '/> Host:/ {gsub("\r","");print $NF}')

    # Download or update build's source code.
    if [ ! -d "$BUILD/.git" ] && [ -n "$ISNET" ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading $BUILDNAME's source code. Please wait..."
        $GIT "$BUILD"

    elif [ -d "$BUILD/.git" ]; then

        if [ "$SRB2BLDDEVMODE" != 1 ]; then

            $PRINTF "$MESSAGE\n\n%s\n\e[0m" "Cleaning up source code. Please wait..."
            cleansource

        fi

        GITCURVER=$(git -C "$BUILD" rev-parse --abbrev-ref HEAD)

        if [ -n "$GITVER" ]; then

            git -C "$BUILD" checkout -q "$GITVER"

        fi

        if [ -n "$ISNET" ]; then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating $BUILDNAME's source code. Please wait..."
            git -C "$BUILD" pull --recurse-submodules --rebase --autostash

        fi

        git -C "$BUILD" checkout -q "$GITCURVER"

    fi

    GITDEFVER=$($PRINTF "%s\n" "$GITVER" | gawk '{gsub("--branch| ","");print}')
    GITVER="$GITDEFVER"

    # Choose Git branch.
    $PRINTF "$MESSAGE\n%s\n\e[0m" "Please choose branch by typing number and then pressing enter, or just press enter to continue with default branch, which is \"$GITVER\". To quit, press ctrl+c."
    $PRINTF "$NOTICE%s\n\e[0m" "WARNING: By choosing different branch other than default, compilation or running compiled build may fail."
    array=$(git -C "$BUILD" branch -a | gawk -F'/' '!/->/ {print $NF}' | sort -u | gawk '!/^ / {gsub("^* ",""); print}')
    arrayname=$($PRINTF "$(git -C "$BUILD" branch -a | gawk -F'/' '!/->/ {print $NF}' | sort -u | gawk '!/^ / {gsub("^* ","\\e[1;92m* \\e[0m"); print}')\n")
    count="$($PRINTF "%s\n" "$array" | wc -l)"
    n=""
    $PRINTF "%s\n" "$arrayname" | gawk '{print NR")", $0}'
    while true; do

        $PRINTF "#? "
        read -r n

        if [ -n "$n" ] && [ "$n" -eq "$n" ] && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then

            GITVER=$($PRINTF "%s\n" "$array" | gawk NR=="${n}")
            if [ -d "$BUILD/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Switching to branch \"$GITVER\"."

                if [ -n "$GITVER" ]; then

                    git -C "$BUILD" checkout -q "$GITVER"

                fi

            fi
            break

        else

            if [ -d "$BUILD/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Switching to branch \"$GITVER\"."

                if [ -n "$GITVER" ]; then

                    git -C "$BUILD" checkout -q "$GITVER"

                fi

            fi
            break

        fi

    done
}

choosebuild() {
    clear
    checkuserid

    # Choose and download build.
    while

        $PRINTF "$MESSAGE%s\n\e[0m" "Please choose by typing number and then pressing enter. Press enter or ctrl+c to quit."
        for loop in "Build SRB2" "Build SRB2 Uncapped Plus" "Build SRB2 NetPlus" "Build SRB2 rphys" "Build SRB2 VR" "Build SRB2 v2.1 Legacy" "Build SRB2 v2.0" "Build SRB2 Final Demo" "Build SRB2 Persona" "Build SRB2 Kart" "Build SRB2 Kart Moe Mansion" "Build SRB2 Kart VR" "Build SRB2 Custom" "Build wadcli" "Build SLADE"; do $PRINTF "%s\n" "$((i += 1))) $loop"; done
        $PRINTF "#? "
        read -r choose
    do

        unset i
        case "$choose" in

            "1")

                BUILD="$BUILDPATH/srb2"
                GITDEFVER="master"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/STJr/SRB2.git --recursive --branch $GITVER"
                break

                ;;

            "2")

                BUILD="$BUILDPATH/srb2-uncapped-plus"
                GITDEFVER="uncapped-plus"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/X.organic/SRB2-modified.git --recursive --branch $GITVER"
                break

                ;;

            "3")

                BUILD="$BUILDPATH/srb2-netplus"
                GITDEFVER="master"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/JohnFrostFox/netplus.git --recursive --branch $GITVER"
                break

                ;;

            "4")

                BUILD="$BUILDPATH/srb2-rphys"
                GITDEFVER="rphys-uncapped"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/katsy/SRB2.git --recursive --branch $GITVER"
                break

                ;;

            "5")

                BUILD="$BUILDPATH/srb2-vr"
                GITDEFVER="openvr"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/chreas/SRB2.git --recursive --branch $GITVER"
                break

                ;;

            "6")

                BUILD="$BUILDPATH/srb2-2.1-legacy"
                GITDEFVER="master"
                GITVER="$GITDEFVER"
                GIT="git clone https://github.com/PandaSRC/srb2-legacy.git --recursive --branch $GITVER"
                break

                ;;

            "7")

                BUILD="$BUILDPATH/srb2-2.0"
                GITDEFVER="master"
                GITVER="$GITDEFVER"
                GIT="git clone https://github.com/STJr/SRB2-Public.git --recursive --branch $GITVER"
                break

                ;;

            "8")

                BUILD="$BUILDPATH/srb2-final-demo"
                GITDEFVER="master"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/SteelT/SRB2-OLD.git --recursive --branch $GITVER"
                break

                ;;

            "9")

                BUILD="$BUILDPATH/srb2-persona"
                GITDEFVER="srb2p_22"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/SinnamonLat/SRB2.git --recursive --branch $GITVER"
                break

                ;;

            "10")

                BUILD="$BUILDPATH/srb2-kart"
                GITDEFVER="master"
                GITVER="$GITDEFVER"
                GIT="git clone https://git.do.srb2.org/KartKrew/Kart-Public.git --recursive --branch $GITVER"
                break

                ;;

            "11")

                BUILD="$BUILDPATH/srb2-kart-moe-mansion"
                GITDEFVER="moe-mansion"
                GITVER="$GITDEFVER"
                GIT="git clone https://gitlab.com/himie/kart-public.git --recursive --branch $GITVER"
                break

                ;;

            "12")

                BUILD="$BUILDPATH/srb2-kart-vr"
                GITDEFVER="very-cool-renderer"
                GITVER="$GITDEFVER"
                GIT="git clone https://gitlab.com/cschoenig/kart-public.git --recursive --branch $GITVER"
                break

                ;;

            "13")

                BUILD="$BUILDPATH/srb2-custom"

                mkdir -p "$BUILD"

                if [ -z "$SRB2BLDGITPATH" ]; then

                    $PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter valid Git local or remote path."
                    read -r SRB2BLDGITPATH

                fi

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter name of custom build (it will be written as subdirectory in srb2-custom folder)."
                read -r CUSTOMDIR

                while printf "%s\n" "$CUSTOMDIR"; do

                    if [ -z "$CUSTOMDIR" ]; then

                        $PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter again."

                        read -r CUSTOMDIR

                    else

                        break

                    fi

                done

                BUILD="$BUILDPATH/srb2-custom/$CUSTOMDIR"

                # Check whether SRB2BLDGITPATH environment variable is set or not.
                if [ -z "$SRB2BLDGITPATH" ]; then

                    $PRINTF "$FAILURE%s\n\e[0m" "ERROR: No SRB2BLDGITPATH is set. Add SRB2BLDGITPATH environment variable to valid Git local or remote path in shell configuration file (for example \".bash_profile\" or \".zshrc\" or \".bashrc\").
                EXAMPLE:
			1. export SRB2BLDGITPATH=\"https://github.com/STJr/SRB2\"

			2. export SRB2BLDGITPATH=\"https://git.do.srb2.org/TehRealSalt/SRB2\"

			3. export SRB2BLDGITPATH=\"\$HOME/Builds/SRB2\"

			4. export SRB2BLDGITPATH=\"C:\Builds\SRB2\"
                "
                    exit

                fi

                if [ -z "$(find "$SRB2BLDGITPATH" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | head -n1)" ] && [ -z "$(curl -vI "$SRB2BLDGITPATH" 2>&1 | gawk '/> Host:/ {gsub("\r","");print $NF}')" ]; then

                    $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find path to custom SRB2's source code at $SRB2BLDGITPATH path. Exiting."
                    exit

                fi

                # Check if directory srb2-custom exits in script's data path.
                if ([ -d "$BUILD/.git" ] && [ -n "$(git -C "$SRB2BLDGITPATH" diff --shortstat 2> /dev/null)" ]) || ([ -d "$BUILD/.git" ] && [ "$(git -C "$BUILD" remote show origin 2> /dev/null | gawk '/Fetch URL/ {print $NF}')" != "$(git -C "$SRB2BLDGITPATH" remote show origin 2> /dev/null | gawk '/Fetch URL/ {print $NF}')" ]) && ([ -d "$BUILD/.git" ] && [ "$(git -C "$BUILD" remote show origin 2> /dev/null | gawk '/Fetch URL/ {print $NF}')" != "$($PRINTF "$SRB2BLDGITPATH" | gawk '{gsub(".git$","");print}').git" ]); then

                    $PRINTF "$MESSAGE\n%s\n\e[0m" "Found existing directory with source code in $BUILD path. Are you sure you want to remove it? Enter \"yes/Yes\" or \"no/No\" (\"y/Y\" or \"n/N\"). If you choose \"no/No\", \"n/N\" or just press enter, script will continue with current source code's directory in $BUILD path. Press ctrl+c to quit."
                    $PRINTF "$PROMPT\n%s\e[0m" "> "
                    read -r CONFIRM

                    if [ "$CONFIRM" = y ] || [ "$CONFIRM" = Y ] || [ "$CONFIRM" = yes ] || [ "$CONFIRM" = Yes ]; then

                        $PRINTF "$MESSAGE\n%s\n\e[0m" "Removing existing source at $BUILD path."
                        sleep 1
                        rm -rf "$BUILD"

                    fi

                fi

                # Fixing Windows path to source code to be found by script.
                if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

                    SRB2BLDGITPATH=$($PRINTF "%s\n" "$SRB2BLDGITPATH" | gawk 'gsub("\\\\","\\\\");{print}' | gawk '!a[$0]++ {print}')

                fi

                # Copy directory with source code to script's data path.
                if [ -n "$(find "$SRB2BLDGITPATH" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | head -n1)" ] && [ ! -d "$BUILD/.git" ]; then

                    $PRINTF "$MESSAGE\n%s\n\e[0m" "Copying source code. Please wait..."
                    sleep 1
                    cp -rf "$SRB2BLDGITPATH" "$BUILDPATH/srb2-custom"

                fi

                # Set proper default branch.
                if [ -n "$SRB2BLDGITVER" ] && [ ! -d "$BUILD/.git" ] || [ -n "$ISNET" ]; then

                    GITDEFVER="--branch $SRB2BLDGITVER"

                elif [ -z "$SRB2BLDGITVER" ] && [ ! -d "$BUILD/.git" ] || [ -n "$ISNET" ]; then

                    GITDEFVER="--branch $(git ls-remote --refs $($PRINTF $SRB2BLDGITPATH | gawk '{gsub(".git$","");print}').git | gawk -F'/' '/'$(git ls-remote $($PRINTF $SRB2BLDGITPATH | gawk '{gsub(".git$","");print}').git --symref HEAD | gawk '{print $1}')'/ {print $NF}' | head -n1)"

                elif [ -n "$SRB2BLDGITVER" ] && [ -d "$BUILD/.git" ]; then

                    GITDEFVER="$SRB2BLDGITVER"

                else

                    GITDEFVER=$(gawk -F'/' '{print $NF}' "$BUILD/.git/refs/remotes/origin/HEAD" 2> /dev/null)

                fi

                GITVER="$GITDEFVER"
                GITVERCONF=$($PRINTF "$GITDEFVER" | gawk '{print $NF}')
                GIT="git clone $($PRINTF $SRB2BLDGITPATH | gawk '{gsub(".git$","");print}').git --recursive $GITVER"
                break

                ;;

            "14")

                BUILD="$BUILDPATH/wadcli"
                GITDEFVER="main"
                GITVER="$GITDEFVER"
                GIT="git clone https://github.com/JugadorXEI/wadcli.git --recursive --branch $GITVER"
                break

                ;;

            "15")

                BUILD="$BUILDPATH/slade"
                GITDEFVER="master"
                GITVER="$GITDEFVER"
                GIT="git clone https://github.com/sirjuddington/SLADE.git --recursive --branch $GITVER"
                break

                ;;

            *)

                $PRINTF "$NOTICE\n%s\n\e[0m" "No option has been chosen."
                exit

                ;;

        esac

    done
}

chooseinstall() {
    clear

    # Install build.
    if [ "$OS" != "Linux" ] && [ "$OS" != "Darwin" ] && [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" != "MINGW64" ] && [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" != "MINGW32" ] && [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" != "MINGW" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Currently building and installing is only available for Linux, macOS and Windows. Exiting."
        exit

    fi

    choosebuild

    buildname

    choosebranch

    preparebuild

    # Check whether SDKROOT environment variable is set or not.
    if [ "$OS" = "Darwin" ]; then

        if [ -z "$SDKROOT" ]; then

            $PRINTF "$FAILURE%s\n\e[0m" "ERROR: No SDKROOT is set. Add SDKROOT environment variable to macOS SDK full path. Usually macOS .sdk file is located in /Library/Developer/CommandLineTools/SDKs path, if you installed Homebrew. Exiting."
            exit

        fi

        settrap

        installtomacos

        installtolist

    else

        if [ "$OS" = "Linux" ]; then

            sudo_ping

        fi

        dockerentry

        settrap

        dockerrun

    fi

    if ([ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]) && ([ -f "$(find "$BUILD/bin" -name "*.exe" 2> /dev/null | head -n1)" ] || [ -f "$(find "$BUILD/build" -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ] || [ -f "$(find "$BUILD" -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ]); then

        installtowindows

        installtolist

    elif [ "$OS" = "Linux" ] && ([ -f "$(find "$BUILD/build/AppDir/usr/bin" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ] || [ -f "$(find $BUILD/build -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ] || [ -f "$(find "$BUILD" -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ]); then

        installtolinux

    fi
}

chooseremoveasset() {
    if [ -z "$(find "$SRB2BLDROOT/assets" -mindepth 1 -maxdepth 1 -type f 2> /dev/null)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find assets."
        exit

    fi

    # Remove asset.
    while true; do

        clear
        $PRINTF "$MESSAGE%s\n\e[0m" "Please choose asset by typing number and then pressing enter. Press enter or ctrl+c to quit."
        array=$(find "$SRB2BLDROOT/assets" -mindepth 1 -maxdepth 1 -type f 2> /dev/null | sort)
        arrayname=$($PRINTF "%s\n" "$array" | gawk -F'/' '{print $NF}')
        count="$($PRINTF "%s\n" "$array" | wc -l)"
        n=""
        $PRINTF "%s\n" "$arrayname" | gawk '{print NR")", $0}'
        $PRINTF "#? "
        read -r n

        if [ -n "$n" ] && [ "$n" -eq "$n" ] && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Are you sure you want to remove this asset? Enter \"yes/Yes\" or \"no/No\" (\"y/Y\" or \"n/N\")."
            $PRINTF "$PROMPT\n%s\e[0m" "> "
            read -r CONFIRM

            if [ "$CONFIRM" = y ] || [ "$CONFIRM" = Y ] || [ "$CONFIRM" = yes ] || [ "$CONFIRM" = Yes ]; then

                SRB2ASSETLNXPATH=$($PRINTF "%s\n" "$array" | gawk NR=="${n}")
                SRB2ASSETLNXNAME=$($PRINTF "%s\n" "$arrayname" | gawk NR=="${n}")
                rm -fv "$SRB2ASSETLNXPATH"
                $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Removing $SRB2ASSETLNXNAME is successful."

            fi

            exec "$0" --removeasset

        else

            $PRINTF "$NOTICE\n%s\n\e[0m" "No option has been chosen."
            exit

        fi

    done
}

chooseremovebuild() {
    if [ -z "$(find "$SRB2BLDROOT/builds" -mindepth 1 -maxdepth 1 -type d 2> /dev/null)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find builds."
        exit

    fi

    # Remove build.
    while true; do

        clear
        $PRINTF "$MESSAGE%s\n\e[0m" "Please choose build by typing number and then pressing enter. Press enter or ctrl+c to quit."
        array=$(find "$SRB2BLDROOT/builds" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | sort)
        arrayname=$($PRINTF "%s\n" "$array" | gawk -F'/' '{print $NF}')
        count="$($PRINTF "%s\n" "$array" | wc -l)"
        n=""
        $PRINTF "%s\n" "$arrayname" | gawk '{print NR")", $0}'
        $PRINTF "#? "
        read -r n

        if [ -n "$n" ] && [ "$n" -eq "$n" ] && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then

            if [ "$($PRINTF "%s\n" "$array" | gawk NR=="${n}" | gawk -F'/' '{print $NF}')" = "srb2-custom" ]; then

                while true; do

                    clear
                    $PRINTF "$MESSAGE\n%s\n\e[0m" "Please choose custom build by typing number and then pressing enter. Press enter or ctrl+c to quit."
                    array=$($PRINTF "$(find "$SRB2BLDROOT/builds/srb2-custom" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | sort)\nBack" | gawk 'NF{print}')
                    arrayname=$($PRINTF "$array" | gawk -F'/' '{print $NF}')
                    count="$($PRINTF "%s\n" "$array" | wc -l)"
                    n=""
                    $PRINTF "%s\n" "$arrayname" | gawk '{print NR")", $0}'
                    $PRINTF "#? "
                    read -r n

                    if [ -n "$n" ] && [ "$n" -eq "$n" ] && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then

                        if [ "$($PRINTF "%s\n" "$array" | gawk NR=="${n}" | gawk -F'/' '{print $NF}')" = "Back" ]; then

                            exec "$0" --removebuild

                        fi

                        $PRINTF "$MESSAGE\n%s\n\e[0m" "Are you sure you want to remove this build's directory? Enter \"yes/Yes\" or \"no/No\" (\"y/Y\" or \"n/N\")."
                        $PRINTF "$PROMPT\n%s\e[0m" "> "
                        read -r CONFIRM

                        if [ "$CONFIRM" = y ] || [ "$CONFIRM" = Y ] || [ "$CONFIRM" = yes ] || [ "$CONFIRM" = Yes ]; then

                            BUILDPATH=$($PRINTF "%s\n" "$array" | gawk NR=="${n}")
                            BUILDNAME=$($PRINTF "%s\n" "$arrayname" | gawk NR=="${n}")
                            rm -rfv "$BUILDPATH"
                            unset BUILDPATH

                            if [ -z "$(find "$SRB2BLDROOT/builds/srb2-custom" -mindepth 1 -maxdepth 1 -type d 2> /dev/null)" ]; then

                                rm -rfv "$SRB2BLDROOT/builds/srb2-custom"

                            fi

                            $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Removing $BUILDNAME is successful."

                        fi

                    else

                        $PRINTF "$NOTICE\n%s\n\e[0m" "No option has been chosen."
                        exit

                    fi

                done

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Are you sure you want to remove this build's directory? Enter \"yes/Yes\" or \"no/No\" (\"y/Y\" or \"n/N\")."
            $PRINTF "$PROMPT\n%s\e[0m" "> "
            read -r CONFIRM

            if [ "$CONFIRM" = y ] || [ "$CONFIRM" = Y ] || [ "$CONFIRM" = yes ] || [ "$CONFIRM" = Yes ]; then

                BUILDPATH=$($PRINTF "%s\n" "$array" | gawk NR=="${n}")
                BUILDNAME=$($PRINTF "%s\n" "$arrayname" | gawk NR=="${n}")
                rm -rfv "$BUILDPATH"
                $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Removing $BUILDNAME is successful."

            fi

            exec "$0" --removebuild

        else

            $PRINTF "$NOTICE\n%s\n\e[0m" "No option has been chosen."
            exit

        fi

    done
}

chooseuninstall() {
    if [ -z "$(find "$SRB2BLDROOT/installed" -mindepth 1 -maxdepth 1 -type f 2> /dev/null)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find installed builds."
        exit

    fi

    # Uninstall build from the system.
    while true; do

        clear
        $PRINTF "$MESSAGE%s\n\e[0m" "Please choose installed package by typing number and then pressing enter. Press enter or ctrl+c to quit."
        array=$(find "$SRB2BLDROOT/installed" -mindepth 1 -maxdepth 1 -type f 2> /dev/null | sort)
        arrayname=$($PRINTF "%s\n" "$array" | gawk -F'/' '{print $NF}')
        count="$($PRINTF "%s\n" "$array" | wc -l)"
        n=""
        $PRINTF "%s\n" "$arrayname" | gawk '{print NR")", $0}'
        $PRINTF "#? "
        read -r n

        if [ -n "$n" ] && [ "$n" -eq "$n" ] && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then

            BUILDINSTALLED=$($PRINTF "%s\n" "$array" | gawk NR=="${n}")
            INSTALLEDFILES=$(gawk '/\/usr\/local|\/home\/'$USER'\/.local|\/home\/'$USER'\/Local|\/home\/'$USER'\/SRB2 Games|\/Start Menu\/Programs/ {print}' "$BUILDINSTALLED")
            $PRINTF "$PROMPT\n%s\n\e[0m" "$INSTALLEDFILES"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Above files will be uninstalled. Are you sure you want to that? Enter \"yes/Yes\" or \"no/No\" (\"y/Y\" or \"n/N\")."
            $PRINTF "$PROMPT\n%s\e[0m" "> "
            read -r CONFIRM

            if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ] && ([ "$CONFIRM" = y ] || [ "$CONFIRM" = Y ] || [ "$CONFIRM" = yes ] || [ "$CONFIRM" = Yes ]); then

                gawk -i inplace -v RS= '{gsub("---------------\n[A-Z]*=1|---------------","");print}' "$BUILDINSTALLED"

                while read -r FILE; do
                    rm -rfv "$FILE"
                done < "$BUILDINSTALLED"

                rm -f "$BUILDINSTALLED"

                if [ -z "$(find "$HOME/SRB2 Games" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ]; then

                    rm -rfv "$HOME/SRB2 Games"

                fi

                $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Uninstallation of $($PRINTF "%s\n" "$BUILDINSTALLED" | gawk -F'/' '{print $NF}') is successful."

            elif [ "$CONFIRM" = y ] || [ "$CONFIRM" = Y ] || [ "$CONFIRM" = yes ] || [ "$CONFIRM" = Yes ]; then

                gawk -i inplace -v RS= '{gsub("---------------\n[A-Z]*=1|---------------","");print}' "$BUILDINSTALLED"

                while read -r FILE; do
                    $SUDO rm -rfv "$FILE"
                done < "$BUILDINSTALLED"

                rm -f "$BUILDINSTALLED"

                if [ -z "$(find $SRB2BLDPREFIX/opt/srb2-apps -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ]; then

                    $SUDO rm -rfv $SRB2BLDPREFIX/opt/srb2-apps

                fi

                # Refreshing menu icons.
                if [ -x "$(which gtk-update-icon-cache 2> /dev/null)" ]; then

                    $SUDO gtk-update-icon-cache -qft "$SRB2BLDPREFIX/share/icons/hicolor"

                elif [ -x "$(find /usr/bin -name "kbuildsycoca*" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ]; then

                    $SUDO "$(find /usr/bin -name "kbuildsycoca*" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" --noincremental

                fi

                $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Uninstallation of $($PRINTF "%s\n" "$BUILDINSTALLED" | gawk -F'/' '{print $NF}') is successful."

            fi

            exec "$0" --uninstall

        else

            $PRINTF "$NOTICE\n%s\n\e[0m" "No option has been chosen."
            exit

        fi

    done
}

cleansource() {
    # Clean build's directory after compiling.
    if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

        git -C "$BUILD" clean -qdffx -e .comrev
        git -C "$BUILD" reset -q --hard

    else

        if [ "$OS" != "Darwin" ]; then

            $SUDO find "$SRB2BLDROOT" ! -user 1000 -exec chown -R $(stat -c "%U:%G" "$HOME") {} \;

        fi

        git -C "$BUILD" clean -qdffx -e .comrev
        git -C "$BUILD" reset -q --hard

    fi
}

compatibility() {
    clear

    # Show compatibility table for compiling SRB2 builds for each OS.
    curl -sL "$COMPTABLEURL"
    $PRINTF "%s\n"
}

defaultmessage() {
    $PRINTF "$NOTICE%s\n\e[0m" "Use srb2bld --help to check usage of this shell script."
}

dockerentry() {
    # Prepare containers path.
    if [ ! -d "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" ]; then

        mkdir -p "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker"

    fi

    # Create entrypoint shell script for Docker container.
    cat > "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker/Entrypoint" << ENTRYPOINT
#!/bin/sh

    if [ "$SRB2BLDDEBUG" = 1 ]; then

        set -e -x

    else

        set -e

    fi

    # Added environment variables for Docker container.
    export PRINTF=\$(which -a printf | gawk '/bin/ {print}' | head -n1)
    export ARCH="$ARCH"
    export OS="$OS"
    export IS64="$IS64"
    export ISNET="$ISNET"
    export SRB2BLDROOT="$SRB2BLDROOT"
    export BUILDPATH="$BUILDPATH"
    export BUILD="$BUILD"
    export CUSTOMDIR="$CUSTOMDIR"
    export GITVERCONF="$GITVERCONF"
    export GITVER="$GITVER"
    export GITDEFVER="$GITDEFVER"
    export FILETYPE="$FILETYPE"
    export SRB2RPHYSASSETURL="$SRB2RPHYSASSETURL"
    export SRB2PERSONAASSETURL="$SRB2PERSONAASSETURL"
    export SRB2BLDDEVMODE="$SRB2BLDDEVMODE"
    export SRB2BLDASSETPATH="$SRB2BLDASSETPATH"
    export ASSETAPPDIR="$ASSETAPPDIR"
    export APPIMAGE="$APPIMAGE"
    export UPGRADE="$UPGRADE"
    export STOW_DIR="$SRB2BLDPREFIX/stow"
    export LIBRARY_PATH="$SRB2BLDPREFIX/lib"
    export PKG_CONFIG_PATH="$SRB2BLDPREFIX/lib/pkgconfig"
    export PATH="$SRB2BLDPREFIX/bin:\$PATH"

    # Set prefix path to /usr to make sure files within AppImage can be found.
    if [ "\$APPIMAGE" = 1 ]; then

        export SRB2BLDPREFIX="/usr"

    else

        export SRB2BLDPREFIX="$SRB2BLDPREFIX"

    fi

    # Some old Docker images don't have up-to-date SSL certifications, so this is workaround.
    # export GIT_SSL_NO_VERIFY=1

    # Added repository to safe directories since Git v2.35.
    git config --global --add safe.directory "\$BUILD"

    extractassets() {
        if [ "\$BUILD" = "\$BUILDPATH/srb2" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

            if [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ]; then

                if [ -n "\$ISNET" ] && [ "\$(curl -X GET -sLI "\$SRB2RPHYSASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/SRB2rphys.zip" 2> /dev/null)" ]; then

                    curl -RL "\$SRB2RPHYSASSETURL" -o "\$SRB2BLDROOT/assets/SRB2rphys.zip"

                fi

                7z x -y "\$SRB2BLDROOT/assets/SRB2rphys.zip" "*.pk3" "*.wad" -o"\$BUILD/build/AppDir/usr/games/SRB2"

            fi

            # Temporary fix until SRB2 VR will be updated to the latest version of SRB2.
            if [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

                if [ -n "\$ISNET" ]; then

                    curl -RLC - https://github.com/STJr/SRB2/releases/download/SRB2_release_2.2.9/SRB2-v229-Patch.zip -o "\$SRB2BLDROOT/assets/SRB2VR-Patch.zip"

                fi

                7z x -y "\$SRB2BLDROOT/assets/SRB2VR-Patch.zip" "*.pk3" -o"\$BUILD/build/AppDir/usr/games/SRB2"

            fi

            extractsrb2assets

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ]; then

            if [ -n "\$ISNET" ] && [ "\$(curl -X GET -sLI "\$SRB2PERSONAASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/SRB2P_MP.zip" 2> /dev/null)" ]; then

                curl -RL "\$SRB2PERSONAASSETURL" -o "\$SRB2BLDROOT/assets/SRB2P_MP.zip"

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2P_MP.zip" "*.pk3" "*.wad" -o"\$BUILD/build/AppDir/usr/games/SRB2"
            extractsrb2assets

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ]; then

            if [ -n "\$ISNET" ]; then

                curl -RLC - https://github.com/STJr/SRB2/releases/download/SRB2_release_2.1.25/SRB2-v2125-Installer.exe -o "\$SRB2BLDROOT/assets/SRB2-2.1.exe"

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2-2.1.exe" "*.srb" "*.dta" "*.dat" -o"\$BUILD/build/AppDir/usr/games/SRB2"

            if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then


                if [ "\$IS64" = "64" ]; then

                    rm -rf "\$BUILD/libs/dll-binaries/x86_64/Old"
                    cp -f "\$BUILD/libs/dll-binaries/x86_64/"* "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDL2/x86_64-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDL2_mixer/x86_64-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

                else

                    rm -rf "\$BUILD/libs/dll-binaries/i686/Old"
                    cp -f "\$BUILD/libs/dll-binaries/i686/"* "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDL2/i686-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDL2_mixer/i686-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

                fi

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

            if [ -n "\$ISNET" ]; then

                curl -RLC - https://archive.org/download/srb20ya-v20/SRB2_v206.exe -o "\$SRB2BLDROOT/assets/SRB2-2.0.exe"

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2-2.0.exe" "*.plr" "*.dta" "*.wpn" "*.srb" -o"\$BUILD/build/AppDir/usr/games/SRB2"

            if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then


                7z x -y "\$SRB2BLDROOT/assets/SRB2-2.0.exe" "*.dll" -o"\$BUILD/build/AppDir/usr/lib"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            if [ -n "\$ISNET" ]; then

                curl -RLC - https://archive.org/download/srb20ya-finaldemo/FinalDemo1094-2008.exe -o "\$SRB2BLDROOT/assets/SRB2FinalDemo.exe"

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2FinalDemo.exe" "*.plr" "*.dta" "*.wpn" "*.srb" -o"\$BUILD/build/AppDir/usr/games/SRB2"

            if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then

                if [ -n "\$ISNET" ]; then

                    SRB2ASSETURL=\$(curl -s https://api.github.com/repos/STJr/SRB2/releases/latest | gawk -F'"' '/browser_download_url.*Full.zip/ {print \$4}')
                    if [ "\$(curl -X GET -sLI "\$SRB2ASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/SRB2-Latest.zip" 2> /dev/null)" ]; then

                        rm -f "\$SRB2BLDROOT/assets/SRB2-Latest.zip"
                        curl -RL "\$SRB2ASSETURL" -o "\$SRB2BLDROOT/assets/SRB2-Latest.zip"

                    fi

                fi

                7z x -y "\$SRB2BLDROOT/assets/SRB2-Latest.zip" "*.dll" -o"\$BUILD/build/AppDir/usr/lib"
                mv -f "\$BUILD/build/AppDir/usr/lib/SDL2_mixer_ext.dll" "\$BUILD/build/AppDir/usr/lib/SDL2_mixer.dll"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

            extractsrb2kartassets

        elif [ "\$(dirname \$BUILD)" = "\$BUILDPATH/srb2-custom" ]; then

            if [ "\$(gawk -F'\"' '/SRB2APPLICATION/ {gsub(" ","");print \$2}' "\$BUILD/src/doomdef.h" 2> /dev/null)" = "SRB2" ]; then

                extractsrb2assets

            else

                extractsrb2kartassets

            fi

        fi
    }

    extractcustomassets() {
        BUILDPREFIX=\$(\$PRINTF "%s\n" "\$BUILD" | gawk -F'/' '{print \$NF}')

        if [ -z "\$ISNET" ] && [ -n "\$SRB2BLDASSETPATH" ]; then

            FILETYPE=\$(find "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER."* 2> /dev/null | gawk -F'.' '{print \$NF}' | head -n1)
            SRB2BLDASSETPATH="\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE"

        elif [ -n "\$ISNET" ] && [ -n "\$SRB2BLDASSETPATH" ]; then

            if [ -n "\$(find "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER."* 2> /dev/null | head -n1)" ] && [ "\$(curl -X GET -sLI "\$SRB2BLDASSETPATH" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" = "\$(stat -c %s "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER."* 2> /dev/null)" ]; then

                FILETYPE=\$(find "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER."* 2> /dev/null | gawk -F'.' '{print \$NF}' | head -n1)
                SRB2BLDASSETPATH="\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE"

            elif [ -n "\$(\$PRINTF "%s\n" "\$SRB2BLDASSETPATH" | gawk '/drive.google.com/ {print}')" ]; then

                SRB2ASSETID=\$(\$PRINTF "%s\n" "\$SRB2BLDASSETPATH" | gawk '{gsub("https://drive.google.com/file/d/|/view|?usp=sharing","");print}')
                SRB2BLDASSETPATH="https://drive.google.com/uc?export=download&confirm=t&id=\$SRB2ASSETID"
                FILETYPE=\$(curl -X GET -sLI "https://drive.google.com/uc?export=download&confirm=t&id=\$SRB2ASSETID" | gawk -F'.' '/content-disposition:/ {gsub("\r|\"","");print \$NF}')

            elif [ -n "\$(\$PRINTF "%s\n" "\$SRB2BLDASSETPATH" | gawk '/mega.nz/ {print}')" ]; then

                # Using megafetch script to obtain data to decrypt asset pack from mega.nz.
                curl -sL https://gist.githubusercontent.com/Bijman/b791993783e2fb80d3e98a3a19b6e6e8/raw/4fb91369313eaa8d67fe911fdcc08797ca432517/megafetch.sh -o "\$BUILD/megafetch"
                chmod +x "\$BUILD/megafetch"
                MEGANZURL=\$("\$BUILD/megafetch" "\$SRB2BLDASSETPATH" | gawk '/userstorage.mega.co.nz/ {print}')
                MEGANZFILENAME=\$("\$BUILD/megafetch" "\$SRB2BLDASSETPATH" | gawk 'NR==2')
                MEGANZHEX=\$("\$BUILD/megafetch" "\$SRB2BLDASSETPATH" | gawk 'NR==3')
                MEGANZHEXRAW=\$("\$BUILD/megafetch" "\$SRB2BLDASSETPATH" | gawk 'NR==4')
                SRB2BLDASSETPATH="\$MEGANZURL"
                FILETYPE=\$(\$PRINTF "%s\n" "\$MEGANZFILENAME" | gawk -F'.' '{print \$NF}')

            else

                SRB2BLDASSETPATH="\$SRB2BLDASSETPATH"
                FILETYPE=\$(curl -X GET -sLI "\$SRB2BLDASSETPATH" | gawk -F'.' '/content-disposition:/ {gsub("\r|\"","");print \$NF}')

            fi

        elif [ -z "\$SRB2BLDASSETPATH" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Assuming the latest SRB2/SRB2Kart release assets for $BUILDNAME."
            extractassets

        fi

        if [ -n "\$ISNET" ] && [ -n "\$(curl -vI "\$SRB2BLDASSETPATH" 2>&1 | gawk '/> Host:/ {gsub("\r","");print \$NF}')" ] && [ "\$(curl -X GET -sLI "\$SRB2BLDASSETPATH" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE" 2> /dev/null)" ]; then

            rm -f "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE"

            if [ -n "\$(\$PRINTF "%s\n" "\$SRB2BLDASSETPATH" | gawk '/drive.google.com/ {print}')" ]; then

                curl -RL "https://drive.google.com/uc?export=download&confirm=t&id=\$SRB2ASSETID" -o"\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE"

            elif [ -n "\$(\$PRINTF "%s\n" "\$SRB2BLDASSETPATH" | gawk '/mega.co.nz/ {print}')" ]; then

                curl -RL "\$MEGANZURL" -o "\$BUILD/\$MEGANZFILENAME"
                cat "\$BUILD/\$MEGANZFILENAME" | openssl enc -d -aes-128-ctr -K "\$MEGANZHEX" -iv "\$MEGANZHEXRAW" > "\$BUILD/\$MEGANZFILENAME.new"
                mv -f "\$BUILD/\$MEGANZFILENAME.new" "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE"

            else

                curl -RL "\$SRB2BLDASSETPATH" -o "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE"

            fi

        fi

        if [ -n "\$(find "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE" 2> /dev/null | head -n1)" ]; then

            if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then

                if [ "\$IS64" = "64" ]; then

                    cp -f "\$BUILD/libs/curl/lib64/libcurl-x64.dll" "\$BUILD/build/AppDir/usr/lib"
                    rm -rf "\$BUILD/libs/dll-binaries/x86_64/Old"
                    cp -f "\$BUILD/libs/dll-binaries/x86_64/"* "\$BUILD/build/AppDir/usr/lib"
                    rm -rf "\$BUILD/libs/libopenmpt/bin/x86_64/mingw"
                    cp -f "\$BUILD/libs/libopenmpt/bin/x86_64/"* "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDL2/x86_64-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDLMixerX/x86_64-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

                else

                    cp -f "\$BUILD/libs/curl/lib32/libcurl.dll" "\$BUILD/build/AppDir/usr/lib"
                    rm -rf "\$BUILD/libs/dll-binaries/i686/Old"
                    cp -f "\$BUILD/libs/dll-binaries/i686/"* "\$BUILD/build/AppDir/usr/lib"
                    rm -rf "\$BUILD/libs/libopenmpt/bin/x86/mingw"
                    cp -f "\$BUILD/libs/libopenmpt/bin/x86/"* "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDL2/i686-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                    cp -f "\$BUILD/libs/SDLMixerX/i686-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

                fi

                7z x -y "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE" -x!"*.exe" -x!"*.txt" -o"\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR"

            else

                7z x -y "\$SRB2BLDROOT/assets/\$BUILDPREFIX-\$GITVER.\$FILETYPE" -x!"*.exe" -x!"*.txt" -x!"*.dll" -o"\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR"

            fi

            if [ "\$(find "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR" -mindepth 1 -maxdepth 1 2> /dev/null | wc -l)" -eq "1" ]; then

                mv -f "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR/"*/* "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR"

            fi

        fi

        if [ -n "\$(find "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR/models" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | head -n1)" ]; then

            find "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR/models" -type d -exec chmod 755 {} \;

        elif [ -n "\$(find "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR/mdls" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | head -n1)" ]; then

            find "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR/mdls" -type d -exec chmod 755 {} \;

        fi
    }

    extractsrb2assets() {
        SRB2LATESTVER=\$(curl -s https://api.github.com/repos/STJr/SRB2/releases | gawk -F':|_' '/tag_name/ {gsub("\"|,| ","");print \$NF}' | head -n1)
        SRB2VER=\$(gawk -F'\"' '/SRB2VERSION/ {print \$2}' "\$BUILD/src/version.h" 2> /dev/null)

        if [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ]; then

            SRB2VER=\$(gawk -F'- v|- ' '/v[0-9]/ {print \$2}' "\$BUILD/src/config.h.in" 2> /dev/null | gawk '{gsub(" ","");print}' | tail -n1)

        fi

        if [ -n "\$SRB2LATESTVER" ] && [ "\$SRB2VER" != "\$SRB2LATESTVER" ]; then

            if [ -n "\$ISNET" ]; then

                SRB2ASSETURL=\$(curl -s https://api.github.com/repos/STJr/SRB2/releases | gawk -F'"' '/'SRB2_release_\$SRB2VER'\/.*Full.zip/ {print \$4}')
                if [ "\$(curl -X GET -sLI "\$SRB2ASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/SRB2-Older.zip" 2> /dev/null)" ]; then

                    rm -f "\$SRB2BLDROOT/assets/SRB2-Older.zip"
                    curl -RL "\$SRB2ASSETURL" -o "\$SRB2BLDROOT/assets/SRB2-Older.zip"

                fi

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2-Older.zip" "*.pk3" "*.dta" "*.dat" "models/*" -o"\$BUILD/build/AppDir/usr/games/SRB2"

        else

            if [ -n "\$ISNET" ]; then

                SRB2ASSETURL=\$(curl -s https://api.github.com/repos/STJr/SRB2/releases/latest | gawk -F'"' '/browser_download_url.*Full.zip/ {print \$4}')
                if [ "\$(curl -X GET -sLI "\$SRB2ASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/SRB2-Latest.zip" 2> /dev/null)" ]; then

                    rm -f "\$SRB2BLDROOT/assets/SRB2-Latest.zip"
                    curl -RL "\$SRB2ASSETURL" -o "\$SRB2BLDROOT/assets/SRB2-Latest.zip"

                fi

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2-Latest.zip" "*.pk3" "*.dta" "*.dat" "models/*" -o"\$BUILD/build/AppDir/usr/games/SRB2"

        fi

        find "\$BUILD/build/AppDir/usr/games/SRB2/models" -type d -exec chmod 755 {} \;

        if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then

            if [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

                cp -f "\$BUILD/libs/curl/lib32/libcurl.dll" "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/dll-binaries/i686/Old"
                cp -f "\$BUILD/libs/dll-binaries/i686/"* "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/libopenmpt/bin/x86/mingw"
                cp -f "\$BUILD/libs/libopenmpt/bin/x86/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2/i686-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDLMixerX/i686-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/openvr/openvr_api.dll" "\$BUILD/build/AppDir/usr/lib"

            elif [ "\$IS64" = "64" ]; then

                cp -f "\$BUILD/libs/curl/lib64/libcurl-x64.dll" "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/dll-binaries/x86_64/Old"
                cp -f "\$BUILD/libs/dll-binaries/x86_64/"* "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/libopenmpt/bin/x86_64/mingw"
                cp -f "\$BUILD/libs/libopenmpt/bin/x86_64/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2/x86_64-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDLMixerX/x86_64-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

            else

                cp -f "\$BUILD/libs/curl/lib32/libcurl.dll" "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/dll-binaries/i686/Old"
                cp -f "\$BUILD/libs/dll-binaries/i686/"* "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/libopenmpt/bin/x86/mingw"
                cp -f "\$BUILD/libs/libopenmpt/bin/x86/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2/i686-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDLMixerX/i686-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

            fi

        fi

    }

    extractsrb2kartassets() {
        SRB2KARTVERS=\$(curl -s https://api.github.com/repos/STJr/Kart-Public/releases | gawk -F':|_' '/tag_name/ {gsub("\"|,| ","");print \$NF}')
        SRB2KARTLATESTVER=\$(\$PRINTF "%s\n" "\$SRB2KARTVERS" | head -n1)
        SRB2KARTVER=\$(gawk -F'- [A-z]*[0-9]*' '/v[0-9]/ {print \$2}' "\$BUILD/src/config.h.in" 2> /dev/null | gawk '{gsub(" ","");print}' | tail -n1)

        if [ -n "\$SRB2KARTLATESTVER" ] && [ "\$SRB2KARTVER" != "\$SRB2KARTLATESTVER" ]; then

            if [ -n "\$ISNET" ]; then

                SRB2KARTASSETURL=\$(curl -s https://api.github.com/repos/STJr/Kart-Public/releases | gawk -F'"' '/'\$SRB2KARTVER'\/.*Installer.exe/ {print \$4}')
                if [ "\$(curl -X GET -sLI "\$SRB2KARTASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/SRB2Kart-Older.exe" 2> /dev/null)" ]; then

                    rm -f "\$SRB2BLDROOT/assets/SRB2Kart-Older.exe"
                    curl -RL "\$SRB2KARTASSETURL" -o "\$SRB2BLDROOT/assets/SRB2Kart-Older.exe"

                fi

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2Kart-Older.exe" "*.kart" "*.srb" "*.dat" "mdls/*" -o"\$BUILD/build/AppDir/usr/games/SRB2Kart"

        else

            if [ -n "\$ISNET" ]; then

                SRB2KARTASSETURL=\$(curl -s https://api.github.com/repos/STJr/Kart-Public/releases/latest | gawk -F'"' '/browser_download_url.*Installer.exe/ {print \$4}')
                if [ "\$(curl -X GET -sLI "\$SRB2KARTASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print \$NF}' | tail -n1)" != "\$(stat -c %s "\$SRB2BLDROOT/assets/SRB2Kart-Latest.exe" 2> /dev/null)" ]; then

                    rm -f "\$SRB2BLDROOT/assets/SRB2Kart-Latest.exe"
                    curl -RL "\$SRB2KARTASSETURL" -o "\$SRB2BLDROOT/assets/SRB2Kart-Latest.exe"

                fi

            fi

            7z x -y "\$SRB2BLDROOT/assets/SRB2Kart-Latest.exe" "*.kart" "*.srb" "*.dat" "mdls/*" -o"\$BUILD/build/AppDir/usr/games/SRB2Kart"

        fi

        find "\$BUILD/build/AppDir/usr/games/SRB2Kart/mdls" -type d -exec chmod 755 {} \;

        if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then

            if [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

                cp -f "\$BUILD/libs/curl/lib32/libcurl.dll" "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/dll-binaries/i686/Old"
                cp -f "\$BUILD/libs/dll-binaries/i686/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2/i686-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2_mixer/i686-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/openvr/openvr_api.dll" "\$BUILD/build/AppDir/usr/lib"

            elif [ "\$IS64" = "64" ]; then

                cp -f "\$BUILD/libs/curl/lib64/libcurl-x64.dll" "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/dll-binaries/x86_64/Old"
                cp -f "\$BUILD/libs/dll-binaries/x86_64/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2/x86_64-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2_mixer/x86_64-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

            else

                cp -f "\$BUILD/libs/curl/lib32/libcurl.dll" "\$BUILD/build/AppDir/usr/lib"
                rm -rf "\$BUILD/libs/dll-binaries/i686/Old"
                cp -f "\$BUILD/libs/dll-binaries/i686/"* "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2/i686-w64-mingw32/bin/SDL2.dll" "\$BUILD/build/AppDir/usr/lib"
                cp -f "\$BUILD/libs/SDL2_mixer/i686-w64-mingw32/bin/"* "\$BUILD/build/AppDir/usr/lib"

            fi

        fi
    }

    # Update Docker container.
    \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker container. Please wait..."

    if [ -n "\$ISNET" ]; then

        if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

            sudo apk update && sudo apk upgrade

        else

            sudo apt update && sudo apt full-upgrade -y

        fi

    fi

    # Download and extract assets.
    if [ -z "\$(find "\$BUILD/build/AppDir/usr/games/\$ASSETAPPDIR/"* 2> /dev/null | head -n1)" ] && ([ "\$BUILD" != "\$BUILDPATH/wadcli" ] && [ "\$BUILD" != "\$BUILDPATH/slade" ]); then

        if [ -n "\$ISNET" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading and extracting $BUILDNAME's assets. Please wait..."

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Extracting $BUILDNAME's assets. Please wait..."

        fi

        if [ "\$GITVER" != "\$GITDEFVER" ] || [ "\$(dirname \$BUILD)" = "\$BUILDPATH/srb2-custom" ]; then

            extractcustomassets

        else

            extractassets

        fi

    fi

    # Add -lexecinfo to LDFLAGS for musl based Linux OS to make building successful.
    if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

        export LDFLAGS="\$LDFLAGS -lexecinfo"

    fi

    # Patching headers, source code to avoid compilation failure for builds on Windows.
    if ([ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]) && [ "\$BUILD" != "\$BUILDPATH/wadcli" ] && [ "\$BUILD" != "\$BUILDPATH/slade" ]; then

         sudo sed -i '/#if !defined(_WIN32) && !defined(__CYGWIN__)/,/#endif/d' "/usr/share/mingw-w64/include/_mingw.h"
         sudo sed -i '/#ifndef _WIN32/,/#endif/d' "/usr/share/mingw-w64/include/_mingw_stdarg.h"
         sudo sed -i '/#ifndef _WIN32/,/#endif/d' "/usr/share/mingw-w64/include/sys/types.h"
         sudo sed -i '/#ifndef _WIN32/,/#endif/d' "/usr/share/mingw-w64/include/sys/stat.h"
         sed -i '/#include "exchndl.h"/d' "$BUILD/src/sdl/i_main.c"
         sed -i '/ExcHndlInit()/d' "$BUILD/src/sdl/i_main.c"

         # Linking windres and dllwrap for compiling specific builds.
         if [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

             sudo ln -sf /usr/bin/i686-w64-mingw32-windres /usr/bin/windres
             sudo ln -sf /usr/bin/i686-w64-mingw32-dllwrap /usr/bin/dllwrap

         else

             sudo ln -sf "/usr/bin/\$ARCH-w64-mingw32-windres" /usr/bin/windres
             sudo ln -sf "/usr/bin/\$ARCH-w64-mingw32-dllwrap" /usr/bin/dllwrap

         fi

    fi

    if [ "\$GITVERCONF" = "\$GITDEFVER" ] && [ -z "\$SRB2BLDGITVER" ]; then

       unset GITVERCONF

    fi

    # Modify the build's configuration and assets directory names to avoid conflicts between installed builds.
    if [ "\$BUILD" = "\$BUILDPATH/srb2" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2"|#define DEFAULTDIR ".srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2"|#define DEFAULTDIR "srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2|'\$SRB2BLDPREFIX'/share/games/SRB2|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2|'\$SRB2BLDPREFIX'/games/SRB2|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2"|#define DEFAULTDIR ".srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2"|#define DEFAULTDIR "srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2|'\$SRB2BLDPREFIX'/share/games/SRB2UncappedPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2|'\$SRB2BLDPREFIX'/games/SRB2UncappedPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2|/usr/share/games/SRB2UncappedPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2|/usr/games/SRB2UncappedPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\srb2|c:\\\\\\\srb2uncappedplus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\games\\\\\\\srb2|c:\\\\\\\games\\\\\\\srb2uncappedplus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|\\\\\\\games\\\\\\\srb2|\\\\\\\games\\\\\\\srb2uncappedplus|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2"|#define DEFAULTDIR ".srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2"|#define DEFAULTDIR "srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2|'\$SRB2BLDPREFIX'/share/games/SRB2NetPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2|'\$SRB2BLDPREFIX'/games/SRB2NetPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2|/usr/share/games/SRB2NetPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2|/usr/games/SRB2NetPlus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\srb2|c:\\\\\\\srb2netplus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\games\\\\\\\srb2|c:\\\\\\\games\\\\\\\srb2netplus|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|\\\\\\\games\\\\\\\srb2|\\\\\\\games\\\\\\\srb2netplus|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2"|#define DEFAULTDIR ".srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2"|#define DEFAULTDIR "srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2|'\$SRB2BLDPREFIX'/share/games/SRB2rphys|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2|'\$SRB2BLDPREFIX'/games/SRB2rphys|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2|/usr/share/games/SRB2rphys|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2|/usr/games/SRB2rphys|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\srb2|c:\\\\\\\srb2rphys|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\games\\\\\\\srb2|c:\\\\\\\games\\\\\\\srb2rphys|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|\\\\\\\games\\\\\\\srb2|\\\\\\\games\\\\\\\srb2rphys|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2"|#define DEFAULTDIR ".srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2"|#define DEFAULTDIR "srb2'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2|'\$SRB2BLDPREFIX'/share/games/SRB2VR|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2|'\$SRB2BLDPREFIX'/games/SRB2VR|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2|/usr/share/games/SRB2VR|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2|/usr/games/SRB2VR|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\srb2|c:\\\\\\\srb2vr|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\games\\\\\\\srb2|c:\\\\\\\games\\\\\\\srb2vr|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|\\\\\\\games\\\\\\\srb2|\\\\\\\games\\\\\\\srb2vr|' "\$BUILD/src/sdl/i_system.c"
         gawk -i inplace '{gsub("../libs/openvr/libopenvr_api.so","\$(shell find /usr/lib64 /usr/lib $SRB2BLDPREFIX/lib64 $SRB2BLDPREFIX/lib -name libopenvr_api.so 2> /dev/null | head -n1)");print}' "\$BUILD/src/Makefile.d/nix.mk"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2_21"|#define DEFAULTDIR ".srb2_2.1'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2_21"|#define DEFAULTDIR "srb2_2.1'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2legacy|'\$SRB2BLDPREFIX'/share/games/SRB2legacy|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2legacy|'\$SRB2BLDPREFIX'/games/SRB2legacy|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2"|#define DEFAULTDIR ".srb2_2.0'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2"|#define DEFAULTDIR "srb2_2.0'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/srb2|'\$SRB2BLDPREFIX'/share/games/SRB2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/srb2|'\$SRB2BLDPREFIX'/games/SRB2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/srb2|/usr/share/games/SRB2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/srb2|/usr/games/SRB2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\srb2|c:\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|d:\\\\\\\srb2|d:\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|e:\\\\\\\srb2|e:\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|f:\\\\\\\srb2|f:\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|g:\\\\\\\srb2|g:\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|h:\\\\\\\srb2|h:\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|i:\\\\\\\srb2|i:\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\games\\\\\\\srb2|c:\\\\\\\games\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|\\\\\\\games\\\\\\\srb2|\\\\\\\games\\\\\\\srb2-2.0|' "\$BUILD/src/sdl/i_system.c"
         gawk -i inplace '{gsub("\\\\$\\\\(CC\\\\) \\\\$\\\\(CFLAGS\\\\) -MM \\\\*.c","\$(CC) \$(CFLAGS) -MM \$(wildcard *.c)");print}' "\$BUILD/src/Makefile"
         gawk -i inplace '{gsub("\\\\$\\\\(INTERFACE\\\\)/\\\\*.c","\$(wildcard \$(INTERFACE)/*.c)");print}' "\$BUILD/src/Makefile"
         gawk -i inplace '{gsub("hardware/\\\\*.c","\$(wildcard hardware/*.c)");print}' "\$BUILD/src/Makefile"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

         sed -i 's|#define DEFAULTDIR ".srb21094"|#define DEFAULTDIR ".srb2fd'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb21094"|#define DEFAULTDIR "srb2fd'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/games/SRB2|'\$SRB2BLDPREFIX'/share/games/SRB2FinalDemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2|/usr/games/SRB2FinalDemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\srb2|c:\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|d:\\\\\\\srb2|d:\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|e:\\\\\\\srb2|e:\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|f:\\\\\\\srb2|f:\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|g:\\\\\\\srb2|g:\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|h:\\\\\\\srb2|h:\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|i:\\\\\\\srb2|i:\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\games\\\\\\\srb2|c:\\\\\\\games\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|\\\\\\\games\\\\\\\srb2|\\\\\\\games\\\\\\\srb2finaldemo|' "\$BUILD/src/sdl/i_system.c"
         gawk -i inplace '{gsub("\\\\$\\\\(CC\\\\) \\\\$\\\\(CFLAGS\\\\) -MM \\\\*.c","\$(CC) \$(CFLAGS) -MM \$(wildcard *.c)");print}' "\$BUILD/src/makefile"
         gawk -i inplace '{gsub("\\\\$\\\\(INTERFACE\\\\)/\\\\*.c","\$(wildcard \$(INTERFACE)/*.c)");print}' "\$BUILD/src/makefile"
         gawk -i inplace '{gsub("hardware/\\\\*.c","\$(wildcard hardware/*.c)");print}' "\$BUILD/src/makefile"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2"|#define DEFAULTDIR ".srb2persona'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2"|#define DEFAULTDIR "srb2persona'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2|'\$SRB2BLDPREFIX'/share/games/SRB2Persona|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2|'\$SRB2BLDPREFIX'/games/SRB2Persona|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2|/usr/share/games/SRB2Persona|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2|/usr/games/SRB2Persona|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\srb2|c:\\\\\\\srb2persona|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|c:\\\\\\\games\\\\\\\srb2|c:\\\\\\\games\\\\\\\srb2persona|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|\\\\\\\games\\\\\\\srb2|\\\\\\\games\\\\\\\srb2persona|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2kart"|#define DEFAULTDIR ".srb2kart'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2kart"|#define DEFAULTDIR "srb2kart'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2Kart|'\$SRB2BLDPREFIX'/share/games/SRB2Kart|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2Kart|'\$SRB2BLDPREFIX'/games/SRB2Kart|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2Kart|/usr/share/games/SRB2Kart|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2Kart|/usr/games/SRB2Kart|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2kart"|#define DEFAULTDIR ".srb2kart'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2kart"|#define DEFAULTDIR "srb2kart'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2Kart|'\$SRB2BLDPREFIX'/share/games/SRB2KartMoeMansion|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2Kart|'\$SRB2BLDPREFIX'/games/SRB2KartMoeMansion|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2Kart|/usr/share/games/SRB2KartMoeMansion|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2Kart|/usr/games/SRB2KartMoeMansion|' "\$BUILD/src/sdl/i_system.c"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

         sed -i 's|#define DEFAULTDIR ".srb2kart"|#define DEFAULTDIR ".srb2kart'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "srb2kart"|#define DEFAULTDIR "srb2kart'\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|/usr/local/share/games/SRB2Kart|'\$SRB2BLDPREFIX'/share/games/SRB2KartVR|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/local/games/SRB2Kart|'\$SRB2BLDPREFIX'/games/SRB2KartVR|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/share/games/SRB2Kart|/usr/share/games/SRB2KartVR|' "\$BUILD/src/sdl/i_system.c"
         sed -i 's|/usr/games/SRB2Kart|/usr/games/SRB2KartVR|' "\$BUILD/src/sdl/i_system.c"
         gawk -i inplace '{gsub("../libs/openvr/libopenvr_api.so","\$(shell find /usr/lib64 /usr/lib $SRB2BLDPREFIX/lib64 $SRB2BLDPREFIX/lib -name libopenvr_api.so 2> /dev/null | head -n1)");print}' "\$BUILD/src/sdl/Makefile.cfg"

    elif [ "\$(dirname \$BUILD)" = "\$BUILDPATH/srb2-custom" ]; then

         SRB2CASSETDIR=\$(gawk -F'\"' '/SRB2APPLICATION/ {gsub(" ","");print \$2}' "\$BUILD/src/doomdef.h" 2> /dev/null)
         SRB2CCONFDIR=\$(\$PRINTF "%s\n" "\$SRB2CASSETDIR" | gawk '{print tolower(\$0)}')
         sed -i 's|#define DEFAULTDIR ".'\$SRB2CCONFDIR'"|#define DEFAULTDIR ".'\$SRB2CCONFDIR'c'\$CUSTOMDIR''\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         sed -i 's|#define DEFAULTDIR "'\$SRB2CCONFDIR'"|#define DEFAULTDIR "'\$SRB2CCONFDIR'c'\$CUSTOMDIR''\$GITVERCONF'"|' "\$BUILD/src/doomdef.h"
         gawk -i inplace '{gsub("\"/usr/local/share/games/'\$SRB2CASSETDIR'\"","\"'\$SRB2BLDPREFIX'/share/games/'\$SRB2CASSETDIR'C'\$CUSTOMDIR'\"");print}' "\$BUILD/src/sdl/i_system.c"
         gawk -i inplace '{gsub("\"/usr/local/games/'\$SRB2CASSETDIR'\"","\"'\$SRB2BLDPREFIX'/games/'\$SRB2CASSETDIR'C'\$CUSTOMDIR'\"");print}' "\$BUILD/src/sdl/i_system.c"
         gawk -i inplace '{gsub("\"/usr/share/games/'\$SRB2CASSETDIR'\"","\"/usr/games/'\$SRB2CASSETDIR'C'\$CUSTOMDIR'\"");print}' "\$BUILD/src/sdl/i_system.c"
         gawk -i inplace '{gsub("\"/usr/games/'\$SRB2CASSETDIR'\"","\"/usr/games/'\$SRB2CASSETDIR'C'\$CUSTOMDIR'\"");print}' "\$BUILD/src/sdl/i_system.c"

    fi

if [ "\$APPIMAGE" = 1 ]; then

        # Display content of Makefile for a good view of available compilation flags.
        if [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

            cat "\$BUILD/README.md"

        elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

            cmake -LAH "\$BUILD" 2>&1 | gawk '{if(f)print} /-- Cache values/{f=1}' 2> /dev/null

        else

            set +o noglob
            gawk '/^#/,/ / {print}' "\$BUILD/src/"*akefile
            set -o noglob

        fi

        # Add compilation flags.
        \$PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter $BUILDNAME's space separated compilation flags and then press enter, or just press enter to begin compiling. Default command and flags for compilation:"

        if [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 NONX86=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

            \$PRINTF "$NOTICE%s\n\e[0m" "CXX="$GXXVER" CPLUS_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/liblzf/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD" [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

        elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

            if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

                MUSLFLAGS="-DNO_WEBVIEW=ON"

            fi

            \$PRINTF "$NOTICE%s\n\e[0m" "cmake .. -DwxWidgets_CONFIG_EXECUTABLE=\$(which wx-config wx-config-gtk3 2> /dev/null | head -n1) -DwxWidgets_LIBRARIES=\$(find /usr -name libwx_baseu-*.so 2>/dev/null) \$MUSLFLAGS -DCMAKE_CXX_COMPILER="$GXXVER" -DCMAKE_C_COMPILER="$GCCVER" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

        else

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        fi

        \$PRINTF "$PROMPT\n%s\e[0m" "> "
        read -r CONF

        if [ -n "\$(\$PRINTF "%s\n" \$CONF | gawk 'match(\$0, /LINUX=1|LINUX64=1|MINGW=1|MINGW64=1|NONX86=1|UNIX=1|UNIXCOMMON=1|FREEBSD=1|CYGWIN32=1|SOLARIS=1|WATTCP=1|WINDOWS=1/) {print substr(\$0, RSTART, RLENGTH)}')" ]; then

            CONF=\$(\$PRINTF "%s\n" "\$CONF" | gawk '{gsub("LINUX=1|LINUX64=1|MINGW=1|MINGW64=1|NONX86=1|UNIX=1|UNIXCOMMON=1|FREEBSD=1|CYGWIN32=1|SOLARIS=1|WATTCP=1|WINDOWS=1","");print}')
            \$PRINTF "$FAILURE\n%s\n\e[0m" "ERROR: Entering OS flags like LINUX64=1, MINGW=1 or FREEBSD=1 is not supported on this script. Exiting."
            exit

        fi

    # Download libgme's source code, build and install it.
    if [ -z "\$(\$PRINTF "%s\n" "\$CONF" | gawk 'match(\$0, /NOGME=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && [ -n "\$(\$PRINTF "%s\n" "\$CONF" | gawk 'match(\$0, /HAVE_MIXERX=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && [ "\$BUILD" != "\$BUILDPATH/wadcli" ] && [ "\$BUILD" != "\$BUILDPATH/slade" ]; then

        if [ ! -d "\$SRB2BLDROOT/libraries/libgme/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libgme's source code. Please wait..."
            git clone https://bitbucket.org/mpyne/game-music-emu.git --recursive --branch "$LNXGMEVER" "\$SRB2BLDROOT/libraries/libgme"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libgme's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libgme"
            git -C "\$SRB2BLDROOT/libraries/libgme" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libgme" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libgme" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libgme" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/libgme" checkout -q "$LNXGMEVER"

        fi

        if [ ! -f \$SRB2BLDPREFIX/lib/libgme.so ] || ([ -n "\$(cat "\$SRB2BLDROOT/libraries/libgme/.comrev" 2> /dev/null)" ] && [ "\$(git -C "\$SRB2BLDROOT/libraries/libgme" rev-parse --short HEAD)" != "\$(cat "\$SRB2BLDROOT/libraries/libgme/.comrev" 2> /dev/null)" ]); then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libgme. Please wait..."
            mkdir -p "\$SRB2BLDROOT/libraries/libgme/build"
            cd "\$SRB2BLDROOT/libraries/libgme/build"
            gawk -i inplace 'BEGIN { del=0 } /4.1 had poor support for symbol visibility/ { del=2 } del<=0 { print } /endif()/ { del -= 1 }' "\$SRB2BLDROOT/libraries/libgme/CMakeLists.txt"
            cmake .. -DGME_YM2612_EMU=MAME -DENABLE_UBSAN=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libgme/build"
            sudo make -C "\$SRB2BLDROOT/libraries/libgme/build" install
            cd "\$BUILD" || exit

        fi

    fi

    # Download libSDL2_mixerX's source code, build and install it.
    if [ -n "\$(\$PRINTF "%s\n" \$CONF | gawk 'match(\$0, /HAVE_MIXERX=1/) {print substr(\$0, RSTART, RLENGTH)}')" ]; then

        if [ ! -d "\$SRB2BLDROOT/libraries/libsdl2-mixerx/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libSDL2_mixerX's source code. Please wait..."
            git clone https://github.com/WohlSoft/SDL-Mixer-X.git --recursive --branch "$LNXSDL2MIXERXVER" "\$SRB2BLDROOT/libraries/libsdl2-mixerx"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libSDL2_mixerX's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libsdl2-mixerx"
            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" checkout -q "$LNXSDL2MIXERXVER"

        fi

        \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libSDL2_mixerX. Please wait..."
        mkdir -p "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build"
        cd "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build" || exit
        cmake .. -DDOWNLOAD_AUDIO_CODECS_DEPENDENCY=OFF -DAUDIO_CODECS_BUILD_LOCAL_SDL2=OFF -DUSE_SYSTEM_SDL2=ON -DSDL_MIXER_X_STATIC=OFF -DUSE_GME=ON -DUSE_MIDI=ON -DUSE_MIDI_FLUIDSYNTH=ON -DUSE_MIDI_FLUIDLITE=OFF -DUSE_MIDI_TIMIDITY=ON -DUSE_MIDI_OPNMIDI=OFF -DUSE_MIDI_ADLMIDI=OFF -DUSE_MIDI_EDMIDI=OFF -DUSE_MIDI_NATIVE=OFF -DUSE_SYSTEM_AUDIO_LIBRARIES=ON -DMIXERX_ENABLE_LGPL=ON -DMIXERX_ENABLE_GPL=ON -DCMAKE_INSTALL_PREFIX=/usr
        CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build"
        sudo make -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build" install
        cd "\$BUILD" || exit

    fi

    # Download DiscordRPC source code, build and install it.
    if [ -n "\$(\$PRINTF "%s\n" \$CONF | gawk 'match(\$0, /HAVE_DISCORDRPC=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && ([ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]); then

        if [ ! -d "\$SRB2BLDROOT/libraries/discord-rpc/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading DiscordRPC's source code. Please wait..."
            git clone https://github.com/discord/discord-rpc.git --recursive --branch "$LNXDISCORDRPCVER" "\$SRB2BLDROOT/libraries/discord-rpc"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up DiscordRPC's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/discord-rpc"
            git -C "\$SRB2BLDROOT/libraries/discord-rpc" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/discord-rpc" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/discord-rpc" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/discord-rpc" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/discord-rpc" checkout -q "$LNXDISCORDRPCVER"

        fi

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing DiscordRPC. Please wait..."
            mkdir -p "\$SRB2BLDROOT/libraries/discord-rpc/build"
            cd "\$SRB2BLDROOT/libraries/discord-rpc/build" || exit
            cmake .. -DBUILD_EXAMPLES=OFF -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=/usr
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/discord-rpc/build"
            sudo make -C "\$SRB2BLDROOT/libraries/discord-rpc/build" install
            cd "\$BUILD" || exit

    fi

    # Download libopenvr's source code, build and install it.
    if [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

        if [ ! -d "\$SRB2BLDROOT/libraries/libopenvr/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libopenvr's source code. Please wait..."
            git clone https://github.com/ValveSoftware/openvr.git --recursive --branch "v$LNXOPENVRVER" "\$SRB2BLDROOT/libraries/libopenvr"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libopenvr's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libopenvr"
            git -C "\$SRB2BLDROOT/libraries/libopenvr" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libopenvr" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libopenvr" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libopenvr" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/libopenvr" checkout -q "v$LNXOPENVRVER"

        fi

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libopenvr. Please wait..."
            mkdir -p "\$SRB2BLDROOT/libraries/libopenvr/build"
            cp -rf "\$SRB2BLDROOT/libraries/libopenvr/src/vrcommon" "\$SRB2BLDROOT/libraries/libopenvr/src/vrcore"
            cd "\$SRB2BLDROOT/libraries/libopenvr/build" || exit
            cmake .. -DBUILD_UNIVERSAL=OFF -DBUILD_SHARED=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libopenvr/build"
            sudo make -C "\$SRB2BLDROOT/libraries/libopenvr/build" install
            cd "\$BUILD" || exit

    fi

    # Temporarily disabling libpng12 to avoid compiling errors for SRB2 Final Demo.
    if [ -f \$SRB2BLDPREFIX/lib/libpng12.so ] && [ -d \$SRB2BLDPREFIX/stow/libpng12 ] && [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" != "musl" ] && [ "\$BUILD" != "\$BUILDPATH/srb2-2.0" ]; then

        sudo -E stow -D --adopt libpng12

    fi

    # Compile the build's source code.
    \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building $BUILDNAME's source code. Please wait..."
    if [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

        if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

            CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

        else

            CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

        fi

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

        mkdir -p "\$BUILD/objs/Linux/SDL/Release"

        if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

            CC="$GCCVER" C_INCLUDE_PATH="/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 \$CONF

        else

            CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 NONX86=1 \$CONF

        fi

    elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        sudo -E STOW_DIR=/usr/local/stow stow -D liblzf
        CXX="$GXXVER" CPLUS_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/liblzf/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD" \$CONF
        sudo -E STOW_DIR=/usr/local/stow stow --adopt liblzf
        cd "\$BUILD" || exit

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        mkdir -p "\$BUILD/build"
        cd "\$BUILD/build" || exit

        if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

            MUSLFLAGS="-DNO_WEBVIEW=ON"

        fi

        cmake .. -DwxWidgets_CONFIG_EXECUTABLE=\$(which wx-config wx-config-gtk3 2> /dev/null | head -n1) -DwxWidgets_LIBRARIES=\$(find /usr -name libwx_baseu-*.so 2> /dev/null) \$MUSLFLAGS -DCMAKE_CXX_COMPILER="$GXXVER" -DCMAKE_C_COMPILER="$GCCVER" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr \$CONF
        make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/build"
        make -C "\$BUILD/build" install DESTDIR="\$BUILD/build/AppDir"
        rm -rf "\$BUILD/build/AppDir/usr/share/applications/net.mancubus.SLADE.desktop"
        cd "\$BUILD" || exit

    else

        # Running comptime.sh before compiling to avoid errors.
        cd "\$BUILD/src" || exit
        gawk -i inplace '{gsub("\r","");print}' ../comptime.sh
        bash ../comptime.sh

        if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

            CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

        else

            CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

        fi

        cd "\$BUILD" || exit

    fi

    # Renabling libpng12.
    if [ ! -f \$SRB2BLDPREFIX/lib/libpng12.so ] && [ -d \$SRB2BLDPREFIX/stow/libpng12 ]; then

        sudo -E stow --adopt libpng12

    fi

    \$PRINTF "$MESSAGE\n%s\n\e[0m" "Copying $BUILDNAME's binary, libraries, icons, desktop file and AppRun to AppDir. Please wait..."

    # Copy compiled binary to AppDir.
    if [ -f "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/lsdl2srb2" ]; then

        cp -rf "\$BUILD/bin/lsdl2srb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/Linux\$IS64/Release/srb2legacy" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/srb2legacy" "\$BUILD/build/AppDir/usr/bin/lsdl2srb2"

    elif [ -f "\$BUILD/bin/srb2legacy" ]; then

        cp -rf "\$BUILD/bin/srb2legacy" "\$BUILD/build/AppDir/usr/bin/lsdl2srb2"

    elif [ -f "\$BUILD/bin/Linux\$IS64/Release/lsdlsrb2" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/lsdlsrb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/lsdlsrb2" ]; then

        cp -rf "\$BUILD/bin/lsdlsrb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/Linux/Release/lsdl2srb2" ]; then

        cp -rf "\$BUILD/bin/Linux/Release/lsdl2srb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2kart" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2kart" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/lsdl2srb2kart" ]; then

        cp -rf "\$BUILD/bin/lsdl2srb2kart" "\$BUILD/build/AppDir/usr/bin"

    elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        cp -rf "\$BUILD/wadcli" "\$BUILD/build/AppDir/usr/bin"

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        cp -rf "\$BUILD/build/slade" "\$BUILD/build/AppDir/usr/bin"

    fi

    # Create desktop file.
    COMREV=\$(git -C "\$BUILD" rev-parse --short HEAD)

    if [ "\$BUILD" = "\$BUILDPATH/srb2" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 Uncapped PLUS
Comment=Modified open source 3D Sonic platformer with improved framerate and additional features
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2UncappedPlus
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 NetPlus
Comment=Modified open source 3D Sonic platformer with rollback netcode
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2NetPlus
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 rphys
Comment=Modified open source 3D Sonic platformer with customized physics and movesets
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2rphys
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 VR
Comment=Modified open source 3D Sonic VR platformer with improved framerate and additional features
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;OpenVR;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRBVR
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software

[Desktop Action OpenVR]
Name=OpenVR runtime
Exec=AppRun -openvr -win
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 v2.1 Legacy
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2-2.1-Legacy
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 v2.0
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2-2.0
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 Final Demo
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;platformer;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2FinalDemo
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 Persona
Comment=Modified open source 3D Sonic game with Persona gameplay
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;rpg;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2Persona
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 Kart
Comment=Modified open source 3D Sonic game with kart racing gameplay
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;kart;racing;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2Kart
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 Kart Moe Mansion
Comment=Modified open source 3D Sonic game with kart racing gameplay, improved framerate and additional features
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;kart;racing;
Actions=OpenGL;Software;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2KartMoeMansion
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 Kart VR
Comment=Modified open source 3D Sonic game with VR kart racing gameplay, improved framerate and additional features
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;kart;racing;
Actions=OpenGL;Software;OpenVR;
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2KartVR
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software

[Desktop Action OpenVR]
Name=OpenVR runtime
Exec=AppRun -openvr -win
DESKTOP

    elif [ "\$(dirname \$BUILD)" = "\$BUILDPATH/srb2-custom" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=Sonic Robo Blast 2 Custom \$CUSTOMDIR
Comment=Modified open source 3D Sonic game
Icon=icon
Exec=AppRun
Categories=Game;
Keywords=sonic;
Actions=OpenGL;Software
Terminal=false
NoDisplay=false
X-AppImage-Name=SRB2C\$CUSTOMDIR
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV

[Desktop Action OpenGL]
Name=OpenGL renderer
Exec=AppRun -opengl

[Desktop Action Software]
Name=Software renderer
Exec=AppRun -software
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=wadcli
Comment=Allows the manipulation of Doom WAD files through command-line
Icon=icon
Exec=AppRun
Categories=Development;
Keywords=sonic;wad;
Terminal=true
NoDisplay=false
X-AppImage-Name=wadcli
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/app.desktop" << DESKTOP
[Desktop Entry]
Type=Application
Name=slade
Comment=Allows the manipulation of Doom WAD files
Icon=icon
Exec=AppRun
Categories=Development;
Keywords=sonic;wad;
Terminal=false
NoDisplay=false
X-AppImage-Name=slade
X-AppImage-Arch=\$ARCH
X-AppImage-Version=\$COMREV
DESKTOP

    fi

    # Get app icon.
    if [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        if [ -n "\$ISNET" ]; then

            curl -L https://www.iconfinder.com/icons/285695/download/png/64 -o "\$BUILD/build/icon.png"

        else

            cp -rf \$(find "/usr/share/icons/hicolor" -type f -name "*.png" | head -n1) "\$BUILD/build/icon.png"

        fi

        ICONSIZE=\$(identify "\$BUILD/build/icon.png" | gawk '{print \$3}')
        mkdir -p "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps"
        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps"

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        ICONSIZE=\$(identify "\$BUILD/build/AppDir/usr/share/icons/net.mancubus.SLADE.png" | gawk '{print \$3}')
        mkdir -p "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps"
        mv -f "\$BUILD/build/AppDir/usr/share/icons/net.mancubus.SLADE.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/icon.png"

    else

        if [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            convert "\$BUILD/src/win32/Srb2win.ico" -resize 64x64\! -filter lanczos -alpha on -background none -flatten "\$BUILD/build/icon.png"

        else

            convert "\$BUILD/src/win32/Srb2win.ico[5]" -resize 64x64\! -filter lanczos -alpha on -background none -flatten "\$BUILD/build/icon.png"

        fi
        ICONSIZE=\$(identify "\$BUILD/build/icon.png" | gawk '{print \$3}')
        mkdir -p "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps"
        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps"

    fi

    # Create build's entrypoint and copy libraries to AppDir.
#DEPS="
#libFLAC.so.[0-9]
#libSDL2-2.0.so.[0-9]
#libSDL2_mixer-2.0.so.[0-9]
#libSDL_mixer-1.2.so.[0-9]
#libSDL2_mixer_ext.so.[0-9]
#libdiscord-rpc.so
#libfluidsynth.so.[0-9]
#libgme.so.[0-9]
#libjack.so.[0-9]
#libmad.so.[0-9]
#libmodplug.so.[0-9]
#libmpg123.so.[0-9]
#libogg.so.[0-9]
#libopenmpt.so.[0-9]
#libopenvr_api.so
#libopus.so.[0-9]
#libopusfile.so.[0-9]
#libpng.so.[0-9]
#libpng12.so.[0-9]
#libpulse-simple.so.[0-9]
#libpulse.so.[0-9]
#libpulsecommon-[0-9].[0-9].so.[0-9]
#libreadline.so.[0-9]
#libsndio.so.[0-9]
#libsndfile.so.[0-9]
#libtinfo.so.[0-9]
#libvorbis.so.[0-9]
#libvorbisenc.so.[0-9]
#libvorbisfile.so.[0-9]
#libwrap.so.[0-9]
#"

    cat > "\$BUILD/build/AppDir/AppRun" << 'APPRUN'
#!/bin/sh

export HERE="\$(dirname "\$(readlink -f "\$0")")"

export LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:\$HERE/usr/lib"

APPRUN

    if [ "\$BUILD" = "\$BUILDPATH/srb2" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ] || [ "\$(dirname \$BUILD)" = "\$BUILDPATH/srb2-custom" ]; then

        cat >> "\$BUILD/build/AppDir/AppRun" << 'APPRUNBIN'
export SRB2WADDIR="\$HERE/usr/games/SRB2"

exec "\$HERE/usr/bin/lsdl2srb2" "\$@"
APPRUNBIN

        cp -Lf \$(ldd "\$BUILD/build/AppDir/usr/bin/lsdl2srb2" | gawk '{print \$3}' | gawk '!/libc.so|libdl.so|ld-|libstdc++|libgcc_s.so|libm.so|libpthread.so|libresolv.so|librt.so|libz.so|libcom_err.so/ {print}') "\$BUILD/build/AppDir/usr/lib"

#        cp -Lf \$(for l in \$DEPS; do find /lib* /usr/lib* -name \$l; done) "\$BUILD/build/AppDir/usr/lib"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

        cat >> "\$BUILD/build/AppDir/AppRun" << 'APPRUNBIN'
export SRB2WADDIR="\$HERE/usr/games/SRB2"

exec "\$HERE/usr/bin/lsdlsrb2" "\$@"
APPRUNBIN

        cp -Lf \$(ldd "\$BUILD/build/AppDir/usr/bin/lsdlsrb2" | gawk '{print \$3}' | gawk '!/libc.so|libdl.so|ld-|libstdc++|libgcc_s.so|libm.so|libpthread.so|libresolv.so|librt.so|libz.so|libcom_err.so/ {print}') "\$BUILD/build/AppDir/usr/lib"

#        cp -Lf \$(for l in \$DEPS; do find /lib* /usr/lib* -name \$l; done) "\$BUILD/build/AppDir/usr/lib"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

        cat >> "\$BUILD/build/AppDir/AppRun" << 'APPRUNBIN'
export SRB2WADDIR="\$HERE/usr/games/SRB2Kart"

exec "\$HERE/usr/bin/lsdl2srb2kart" "\$@"
APPRUNBIN

        cp -Lf \$(ldd "\$BUILD/build/AppDir/usr/bin/lsdl2srb2kart" | gawk '{print \$3}' | gawk '!/libc.so|libdl.so|ld-|libstdc++|libgcc_s.so|libm.so|libpthread.so|libresolv.so|librt.so|libz.so|libcom_err.so/ {print}') "\$BUILD/build/AppDir/usr/lib"

#        cp -Lf \$(for l in \$DEPS; do find /lib* /usr/lib* -name \$l; done) "\$BUILD/build/AppDir/usr/lib"

    elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        cat >> "\$BUILD/build/AppDir/AppRun" << 'APPRUNBIN'
exec "\$HERE/usr/bin/wadcli" "\$@"
APPRUNBIN

        cp -Lf \$(ldd "\$BUILD/build/AppDir/usr/bin/wadcli" | gawk '{print \$3}' | gawk '!/libc.so|libdl.so|ld-|libstdc++|libgcc_s.so|libm.so|libpthread.so|libresolv.so|librt.so|libz.so|libcom_err.so/ {print}') "\$BUILD/build/AppDir/usr/lib"

#        cp -Lf \$(for l in \$DEPS; do find /lib* /usr/lib* -name \$l; done) "\$BUILD/build/AppDir/usr/lib"

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        cat >> "\$BUILD/build/AppDir/AppRun" << 'APPRUNBIN'
exec "\$HERE/usr/bin/slade" "\$@"
APPRUNBIN

        cp -Lf \$(ldd "\$BUILD/build/AppDir/usr/bin/slade" | gawk '{print \$3}' | gawk '!/libc.so|libdl.so|ld-|libstdc++|libgcc_s.so|libm.so|libpthread.so|libresolv.so|librt.so|libz.so|libcom_err.so/ {print}') "\$BUILD/build/AppDir/usr/lib"

#        cp -Lf \$(for l in \$DEPS; do find /lib* /usr/lib* -name \$l; done) "\$BUILD/build/AppDir/usr/lib"

    fi

#    cp -Lf \$(find /lib -type l -name "libfuse.so.*" 2> /dev/null | head -n1) "\$BUILD/build/AppDir/usr/lib"

    chmod +x "\$BUILD/build/AppDir/AppRun"

    # Download appimagetool.
    \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building $BUILDNAME's AppImage. Please wait..."
    ISARM=\$(\$PRINTF "%s\n" "\$ARCH" | gawk 'match(\$0, /arm/) {print substr(\$0, RSTART, RLENGTH)}')
    IS64=\$(getconf LONG_BIT)

    if [ -z "\$ISNET" ]; then

        exit

    fi

    if [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

        if [ "\$ARCH" = "x86_64" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-i686.AppImage" -o "\$BUILD/appimagetool"

        elif [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-i686.AppImage" -o "\$BUILD/appimagetool"

        elif ([ -n "\$ISARM" ] && [ "\$IS64" = "64" ]) || [ "\$ARCH" = "aarch64" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-armhf.AppImage" -o "\$BUILD/appimagetool"

        elif [ -n "\$ISARM" ] && [ "\$IS64" = "32" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-armhf.AppImage" -o "\$BUILD/appimagetool"

        fi

    else

        if [ "\$ARCH" = "x86_64" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -o "\$BUILD/appimagetool"

        elif [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-i686.AppImage" -o "\$BUILD/appimagetool"

        elif ([ -n "\$ISARM" ] && [ "\$IS64" = "64" ]) || [ "\$ARCH" = "aarch64" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage" -o "\$BUILD/appimagetool"

        elif [ -n "\$ISARM" ] && [ "\$IS64" = "32" ]; then

            curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-armhf.AppImage" -o "\$BUILD/appimagetool"

        fi

    fi

    chmod +x "\$BUILD/appimagetool"
    cd "\$BUILD/build/AppDir" || exit

    # Create symlinks that are specific for AppDir's structure.
    ln -sf "icon.png" ".DirIcon"
    ln -sf "usr/share/icons/hicolor/\$ICONSIZE/apps/icon.png" "icon.png"
    ln -sf "usr/share/applications/app.desktop" "app.desktop"
    cd "\$BUILD/build/AppDir/usr" || exit
    ln -sf "lib" "lib32"

else

# Upgrade build. Making sure, that there are only used compilation flags.
if [ -n "\$UPGRADE" ] && [ -z "\$CUSTOMDIR" ]; then

    export CONF="\$(gawk '/---------------/ {gsub("---------------","");getline;print}' "\$SRB2BLDROOT/installed/\$UPGRADE")"

elif [ -n "\$UPGRADE" ] && [ -n "\$CUSTOMDIR" ]; then

    export CONF="\$(gawk '/---------------/ {gsub("---------------","");getline;print}' "\$SRB2BLDROOT/installed/\$CUSTOMDIR")"

# Otherwise set compilation flags, build and install as usual.
else

        # Display content of Makefile for a good view of available compilation flags.
        if [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

            cat "\$BUILD/README.md"

        elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

            cmake -LAH "\$BUILD" 2>&1 | gawk '{if(f)print} /-- Cache values/{f=1}' 2> /dev/null

        else

            set +o noglob
            gawk '/^#/,/ / {print}' "\$BUILD/src/"*akefile
            set -o noglob

        fi

    # Add compilation flags.
    \$PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter $BUILDNAME's space separated compilation flags and then press enter, or just press enter to begin compiling. Default command and flags for compilation:"

    if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then

        if [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="i686-w64-mingw32-$MINGWOLDCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="\$ARCH-w64-mingw32-$MINGWOLDCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 SDL=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

            \$PRINTF "$NOTICE%s\n\e[0m" "CXX="\$ARCH-w64-mingw32-$MINGWCXXVER" CPLUS_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/liblzf/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD" WINDOWS=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

        elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

            if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

                MUSLFLAGS="-DNO_WEBVIEW=ON"

            fi

            \$PRINTF "$NOTICE%s\n\e[0m" "cmake .. -DwxWidgets_CONFIG_EXECUTABLE=\$(which wx-config wx-config-gtk3 2> /dev/null | head -n1) -DwxWidgets_LIBRARIES=\$(find /usr -name libwx_baseu-*.so 2> /dev/null) \$MUSLFLAGS -DCMAKE_SYSTEM_NAME=Windows -DTOOLCHAIN_PREFIX=x86_64-w64-mingw32 -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY -DCMAKE_CXX_COMPILER="\$ARCH-w64-mingw32-$MINGWCXXVER" -DCMAKE_C_COMPILER="\$ARCH-w64-mingw32-$MINGWCCVER" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

        else

            if [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="x86_64-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/x86_64-w64-mingw32/include/.:/usr/include/x86_64-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW64=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            elif [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        fi

    elif [ "\$OS" = "Linux" ]; then

        if [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-\$(arch)/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-\$(arch)/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-x86/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-\$(arch)/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 NONX86=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

            \$PRINTF "$NOTICE%s\n\e[0m" "CXX="$GXXVER" CPLUS_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/liblzf/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD" [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

        elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

            if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

                MUSLFLAGS="-DNO_WEBVIEW=ON"

            fi

            \$PRINTF "$NOTICE%s\n\e[0m" "cmake .. -DwxWidgets_CONFIG_EXECUTABLE=\$(which wx-config wx-config-gtk3 2> /dev/null | head -n1) -DwxWidgets_LIBRARIES=\$(find /usr -name libwx_baseu-*.so 2> /dev/null) \$MUSLFLAGS -DCMAKE_CXX_COMPILER="$GXXVER" -DCMAKE_C_COMPILER="$GCCVER" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=\$SRB2BLDPREFIX [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

        else

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                \$PRINTF "$NOTICE%s\n\e[0m" "CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

        fi

    fi

     \$PRINTF "$PROMPT\n%s\e[0m" "> "
     read -r CONF

  fi

    if [ -n "\$(\$PRINTF "%s\n" \$CONF | gawk 'match(\$0, /LINUX=1|LINUX64=1|MINGW=1|MINGW64=1|NONX86=1|UNIX=1|UNIXCOMMON=1|FREEBSD=1|CYGWIN32=1|SOLARIS=1|WATTCP=1|WINDOWS=1/) {print substr(\$0, RSTART, RLENGTH)}')" ]; then

        CONF=\$(\$PRINTF "%s\n" "\$CONF" | gawk '{gsub("LINUX=1|LINUX64=1|MINGW=1|MINGW64=1|NONX86=1|UNIX=1|UNIXCOMMON=1|FREEBSD=1|CYGWIN32=1|SOLARIS=1|WATTCP=1|WINDOWS=1","");print}')
        \$PRINTF "$FAILURE\n%s\n\e[0m" "ERROR: Entering OS flags like LINUX64=1, MINGW=1 or FREEBSD=1 is not supported on this script. Exiting."
        exit

    fi

    # Download libpng12's source code, build and install it.
    if [ "\$OS" = "Linux" ] && [ -z "\$(\$PRINTF "%s\n" "\$CONF" | gawk 'match(\$0, /NOPNG=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && ([ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ] && [ "\$BUILD" != "\$BUILDPATH/wadcli" ] && [ "\$BUILD" != "\$BUILDPATH/slade" ]); then

        if [ ! -d "\$SRB2BLDROOT/libraries/libpng12/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libpng12's source code. Please wait..."
            git clone git://git.code.sf.net/p/libpng/code.git --recursive --branch "$LNXPNG12VER" "\$SRB2BLDROOT/libraries/libpng12"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libpng12's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libpng12"
            git -C "\$SRB2BLDROOT/libraries/libpng12" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libpng12" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libpng12" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libpng12" pull --recurse-submodules --rebase

            fi

            git -C "\$SRB2BLDROOT/libraries/libpng12" checkout -q "$LNXPNG12VER"

        fi

        if [ ! -f \$SRB2BLDPREFIX/lib/libpng12.so ] || ([ -n "\$(cat "\$SRB2BLDROOT/libraries/libpng12/.comrev" 2> /dev/null)" ] && [ "\$(git -C "\$SRB2BLDROOT/libraries/libpng12" rev-parse --short HEAD)" != "\$(cat "\$SRB2BLDROOT/libraries/libpng12/.comrev" 2> /dev/null)" ]); then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libpng12. Please wait..."
            cd "\$SRB2BLDROOT/libraries/libpng12" || exit
            ./configure --prefix=\$SRB2BLDPREFIX/stow/libpng12
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libpng12"
            sudo make -C "\$SRB2BLDROOT/libraries/libpng12" install
            sudo -E stow -v --adopt libpng12
            COMREV=\$(git -C "\$SRB2BLDROOT/libraries/libpng12" rev-parse --short HEAD)
            \$PRINTF "%s\n" "\$COMREV" > "\$SRB2BLDROOT/libraries/libpng12/.comrev"
            cd "\$BUILD" || exit

        fi

    fi

    # Download libopenmpt's source code, build and install it for musl based Linux OS.
    if [ -z "\$(\$PRINTF "%s\n" "\$CONF" | gawk 'match(\$0, /NOOPENMPT=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ] && [ "\$BUILD" != "\$BUILDPATH/wadcli" ] && [ "\$BUILD" != "\$BUILDPATH/slade" ]; then

        if [ ! -d "\$SRB2BLDROOT/libraries/libopenmpt/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libopenmpt's source code. Please wait..."
            git clone https://github.com/OpenMPT/openmpt.git --recursive --branch "libopenmpt-$LNXOPENMPTVER" "\$SRB2BLDROOT/libraries/libopenmpt"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libopenmpt's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libopenmpt"
            git -C "\$SRB2BLDROOT/libraries/libopenmpt" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libopenmpt" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libopenmpt" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libopenmpt" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/libopenmpt" checkout -q "libopenmpt-$LNXOPENMPTVER"

        fi

        if [ ! -f \$SRB2BLDPREFIX/lib/libopenmpt.so ] || ([ -n "\$(cat "\$SRB2BLDROOT/libraries/libopenmpt/.comrev" 2> /dev/null)" ] && [ "\$(git -C "\$SRB2BLDROOT/libraries/libopenmpt" rev-parse --short HEAD)" != "\$(cat "\$SRB2BLDROOT/libraries/libopenmpt/.comrev" 2> /dev/null)" ]); then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libopenmpt. Please wait..."
            gawk -i inplace '{gsub("DYNLINK=1","DYNLINK=0") gsub("STATIC_LIB=1","STATIC_LIB=0") gsub("EXAMPLES=1","EXAMPLES=0") gsub("OPENMPT123=1","OPENMPT123=0") gsub("TEST=1","TEST=0");print}' "\$SRB2BLDROOT/libraries/libopenmpt/Makefile"
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libopenmpt" NO_PORTAUDIO=1 NO_PORTAUDIOCPP=1 NO_SNDFILE=1 NO_FLAC=1
            sudo make -C "\$SRB2BLDROOT/libraries/libopenmpt" PREFIX=\$SRB2BLDPREFIX/stow/libopenmpt install
            sudo -E stow -v --adopt libopenmpt
            COMREV=\$(git -C "\$SRB2BLDROOT/libraries/libopenmpt" rev-parse --short HEAD)
            \$PRINTF "%s\n" "\$COMREV" > "\$SRB2BLDROOT/libraries/libopenmpt/.comrev"
            cd "\$BUILD" || exit

        fi

    fi

    # Download libgme's source code, build and install it.
    if [ "\$OS" = "Linux" ] && [ -z "\$(\$PRINTF "%s\n" "\$CONF" | gawk 'match(\$0, /NOGME=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && [ -n "\$(\$PRINTF "%s\n" "\$CONF" | gawk 'match(\$0, /HAVE_MIXERX=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && [ "\$BUILD" != "\$BUILDPATH/wadcli" ] && [ "\$BUILD" != "\$BUILDPATH/slade" ]; then

        if [ ! -d "\$SRB2BLDROOT/libraries/libgme/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libgme's source code. Please wait..."
            git clone https://bitbucket.org/mpyne/game-music-emu.git --recursive --branch "$LNXGMEVER" "\$SRB2BLDROOT/libraries/libgme"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libgme's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libgme"
            git -C "\$SRB2BLDROOT/libraries/libgme" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libgme" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libgme" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libgme" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/libgme" checkout -q "$LNXGMEVER"

        fi

        if [ ! -f \$SRB2BLDPREFIX/lib/libgme.so ] || ([ -n "\$(cat "\$SRB2BLDROOT/libraries/libgme/.comrev" 2> /dev/null)" ] && [ "\$(git -C "\$SRB2BLDROOT/libraries/libgme" rev-parse --short HEAD)" != "\$(cat "\$SRB2BLDROOT/libraries/libgme/.comrev" 2> /dev/null)" ]); then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libgme. Please wait..."
            mkdir -p "\$SRB2BLDROOT/libraries/libgme/build"
            cd "\$SRB2BLDROOT/libraries/libgme/build"
            gawk -i inplace 'BEGIN { del=0 } /4.1 had poor support for symbol visibility/ { del=2 } del<=0 { print } /endif()/ { del -= 1 }' "\$SRB2BLDROOT/libraries/libgme/CMakeLists.txt"
            cmake .. -DGME_YM2612_EMU=MAME -DENABLE_UBSAN=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=\$SRB2BLDPREFIX/stow/libgme
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libgme/build"
            sudo make -C "\$SRB2BLDROOT/libraries/libgme/build" install
            sudo -E stow -v --adopt libgme
            COMREV=\$(git -C "\$SRB2BLDROOT/libraries/libgme" rev-parse --short HEAD)
            \$PRINTF "%s\n" "\$COMREV" > "\$SRB2BLDROOT/libraries/libgme/.comrev"
            cd "\$BUILD" || exit

        fi

    fi

    # Download libSDL2_mixerX's source code, build and install it.
    if [ "\$OS" = "Linux" ] && [ -n "\$(\$PRINTF "%s\n" \$CONF | gawk 'match(\$0, /HAVE_MIXERX=1/) {print substr(\$0, RSTART, RLENGTH)}')" ]; then

        if [ ! -d "\$SRB2BLDROOT/libraries/libsdl2-mixerx/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libSDL2_mixerX's source code. Please wait..."
            git clone https://github.com/WohlSoft/SDL-Mixer-X.git --recursive --branch "$LNXSDL2MIXERXVER" "\$SRB2BLDROOT/libraries/libsdl2-mixerx"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libSDL2_mixerX's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libsdl2-mixerx"
            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" checkout -q "$LNXSDL2MIXERXVER"

        fi

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libSDL2_mixerX. Please wait..."
            mkdir -p "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build"
            cd "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build"
            cmake .. -DDOWNLOAD_AUDIO_CODECS_DEPENDENCY=OFF -DAUDIO_CODECS_BUILD_LOCAL_SDL2=OFF -DUSE_SYSTEM_SDL2=ON -DSDL_MIXER_X_STATIC=OFF -DUSE_GME=ON -DUSE_MIDI=ON -DUSE_MIDI_FLUIDSYNTH=ON -DUSE_MIDI_FLUIDLITE=OFF -DUSE_MIDI_TIMIDITY=ON -DUSE_MIDI_OPNMIDI=OFF -DUSE_MIDI_ADLMIDI=OFF -DUSE_MIDI_EDMIDI=OFF -DUSE_MIDI_NATIVE=OFF -DUSE_SYSTEM_AUDIO_LIBRARIES=ON -DMIXERX_ENABLE_LGPL=ON -DMIXERX_ENABLE_GPL=ON -DCMAKE_INSTALL_PREFIX=\$SRB2BLDPREFIX/stow/libsdl2-mixerx
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build"
            sudo make -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx/build" install
            sudo -E stow -v --adopt libsdl2-mixerx
            COMREV=\$(git -C "\$SRB2BLDROOT/libraries/libsdl2-mixerx" rev-parse --short HEAD)
            \$PRINTF "%s\n" "\$COMREV" > "\$SRB2BLDROOT/libraries/libsdl2-mixerx/.comrev"
            cd "\$BUILD" || exit

    fi

    # Download DiscordRPC source code, build and install it.
    if [ -n "\$(\$PRINTF "%s\n" \$CONF | gawk 'match(\$0, /HAVE_DISCORDRPC=1/) {print substr(\$0, RSTART, RLENGTH)}')" ] && ([ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]); then

        if [ ! -d "\$SRB2BLDROOT/libraries/discord-rpc/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading DiscordRPC's source code. Please wait..."
            git clone https://github.com/discord/discord-rpc.git --recursive --branch "$LNXDISCORDRPCVER" "\$SRB2BLDROOT/libraries/discord-rpc"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up DiscordRPC's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/discord-rpc"
            git -C "\$SRB2BLDROOT/libraries/discord-rpc" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/discord-rpc" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/discord-rpc" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/discord-rpc" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/discord-rpc" checkout -q "$LNXDISCORDRPCVER"

        fi

        \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing DiscordRPC. Please wait..."
        mkdir -p "\$SRB2BLDROOT/libraries/discord-rpc/build"
        cd "\$SRB2BLDROOT/libraries/discord-rpc/build" || exit

        if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then

            if [ -n "\$ISNET" ]; then

                DISCORDRPCURL="\$(curl -s https://api.github.com/repos/discord/discord-rpc/releases/latest | gawk -F'"' '/browser_download_url.*discord-rpc-win.zip/ {print \$4}')"
                curl -RL "\$DISCORDRPCURL" > "\$SRB2BLDROOT/libraries/discord-rpc/discord-rpc-win.zip"

            fi

            if ([ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ]) || [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

                7z e -y "\$SRB2BLDROOT/libraries/discord-rpc/discord-rpc-win.zip" "discord-rpc/win32-dynamic/bin/discord-rpc.dll" -o"\$BUILD/build/AppDir/usr/lib"

            else

                7z e -y "\$SRB2BLDROOT/libraries/discord-rpc/discord-rpc-win.zip" "discord-rpc/win64-dynamic/bin/discord-rpc.dll" -o"\$BUILD/build/AppDir/usr/lib"

            fi

        elif [ "\$OS" = "Linux" ] && ([ ! -f \$SRB2BLDPREFIX/lib/libdiscord-rpc.so ] || ([ -n "\$(cat "\$SRB2BLDROOT/libraries/discord-rpc/.comrev" 2> /dev/null)" ] && [ "\$(git -C "\$SRB2BLDROOT/libraries/discord-rpc" rev-parse --short HEAD)" != "\$(cat "\$SRB2BLDROOT/libraries/discord-rpc/.comrev" 2> /dev/null)" ])); then

            cmake .. -DBUILD_EXAMPLES=OFF -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=\$SRB2BLDPREFIX/stow/discord-rpc
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/discord-rpc/build"
            sudo make -C "\$SRB2BLDROOT/libraries/discord-rpc/build" install
            sudo -E stow -v --adopt discord-rpc
            COMREV=\$(git -C "\$SRB2BLDROOT/libraries/discord-rpc" rev-parse --short HEAD)
            \$PRINTF "%s\n" "\$COMREV" > "\$SRB2BLDROOT/libraries/discord-rpc/.comrev"

        fi

        cd "\$BUILD" || exit

    fi

    # Download libopenvr's source code, build and install it.
    if [ "\$OS" = "Linux" ] && ([ "\$BUILD" = "\$BUILDPATH/srb2-vr" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]); then

        if [ ! -d "\$SRB2BLDROOT/libraries/libopenvr/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libopenvr's source code. Please wait..."
            git clone https://github.com/ValveSoftware/openvr.git --recursive --branch "v$LNXOPENVRVER" "\$SRB2BLDROOT/libraries/libopenvr"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libopenvr's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/libopenvr"
            git -C "\$SRB2BLDROOT/libraries/libopenvr" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/libopenvr" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/libopenvr" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/libopenvr" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/libopenvr" checkout -q "v$LNXOPENVRVER"

        fi

        if [ ! -f \$SRB2BLDPREFIX/lib/libopenvr_api.so ] || ([ -n "\$(cat "\$SRB2BLDROOT/libraries/libopenvr/.comrev" 2> /dev/null)" ] && [ "\$(git -C "\$SRB2BLDROOT/libraries/libopenvr" rev-parse --short HEAD)" != "\$(cat "\$SRB2BLDROOT/libraries/libopenvr/.comrev" 2> /dev/null)" ]); then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libopenvr. Please wait..."
            mkdir -p "\$SRB2BLDROOT/libraries/libopenvr/build"
            cp -rf "\$SRB2BLDROOT/libraries/libopenvr/src/vrcommon" "\$SRB2BLDROOT/libraries/libopenvr/src/vrcore"
            cd "\$SRB2BLDROOT/libraries/libopenvr/build" || exit
            cmake .. -DBUILD_UNIVERSAL=OFF -DBUILD_SHARED=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=\$SRB2BLDPREFIX/stow/libopenvr
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/libopenvr/build"
            sudo make -C "\$SRB2BLDROOT/libraries/libopenvr/build" install
            sudo -E stow -v --adopt libopenvr
            COMREV=\$(git -C "\$SRB2BLDROOT/libraries/libopenvr" rev-parse --short HEAD)
            \$PRINTF "%s\n" "\$COMREV" > "\$SRB2BLDROOT/libraries/libopenvr/.comrev"
            cd "\$BUILD" || exit

        fi

    fi

    # Download liblzf's source code, build and install it.
    if [ "\$OS" = "Linux" ] && [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        if [ ! -d "\$SRB2BLDROOT/libraries/liblzf/.git" ]; then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading liblzf's source code. Please wait..."
            git clone https://github.com/nemequ/liblzf.git --recursive --branch "$LNXLZFVER" "\$SRB2BLDROOT/libraries/liblzf"

        else

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up liblzf's source code. Please wait..."
            git config --global --add safe.directory "\$SRB2BLDROOT/libraries/liblzf"
            git -C "\$SRB2BLDROOT/libraries/liblzf" clean -qdffx -e .comrev
            git -C "\$SRB2BLDROOT/libraries/liblzf" reset -q --hard
            git -C "\$SRB2BLDROOT/libraries/liblzf" checkout -q master

            if [ -n "\$ISNET" ]; then

                git -C "\$SRB2BLDROOT/libraries/liblzf" pull --recurse-submodules --rebase --autostash

            fi

            git -C "\$SRB2BLDROOT/libraries/liblzf" checkout -q "$LNXLZFVER"

        fi

        if [ ! -f \$SRB2BLDPREFIX/lib/liblzf.so ] || ([ -n "\$(cat "\$SRB2BLDROOT/libraries/liblzf/.comrev" 2> /dev/null)" ] && [ "\$(git -C "\$SRB2BLDROOT/libraries/liblzf" rev-parse --short HEAD)" != "\$(cat "\$SRB2BLDROOT/libraries/liblzf/.comrev" 2> /dev/null)" ]); then

            \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing liblzf. Please wait..."
            cd "\$SRB2BLDROOT/libraries/liblzf"
            autoheader -v

            if [ -n "\$ISNET" ]; then

                curl -LO https://raw.githubusercontent.com/archlinux/svntogit-community/packages/liblzf/trunk/liblzf-3.6-autoconf-20140314.patch
                gawk -i inplace '/liblzf-3.6\/config.h.in/ {suppress=1} /+#endif/ {suppress=0} !suppress' ./liblzf-3.6-autoconf-20140314.patch
                patch -Np1 -i ./liblzf-3.6-autoconf-20140314.patch

            fi

            chmod +x ./bootstrap.sh
            ./bootstrap.sh
            ./configure --disable-static --prefix=\$SRB2BLDPREFIX/stow/liblzf
            CC="$GCCVER" make -k -j\$((\$(nproc) + 1)) -C "\$SRB2BLDROOT/libraries/liblzf"
            sudo make -C "\$SRB2BLDROOT/libraries/liblzf" install
            sudo mkdir -p \$SRB2BLDPREFIX/stow/include/liblzf
            sudo mv -f \$SRB2BLDPREFIX/stow/include/lzf.h \$SRB2BLDPREFIX/stow/include/liblzf/lzf.h
            sudo mv -f \$SRB2BLDPREFIX/stow/include/lzfP.h \$SRB2BLDPREFIX/stow/include/liblzf/lzfP.h
            sudo -E stow -v --adopt liblzf
            COMREV=\$(git -C "\$SRB2BLDROOT/libraries/liblzf" rev-parse --short HEAD)
            \$PRINTF "%s\n" "\$COMREV" > "\$SRB2BLDROOT/libraries/liblzf/.comrev"
            cd "\$BUILD" || exit

        fi

    fi

    # Download and install FMOD for compiling old SRB2 versions on Windows.
    if ([ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]) && ([ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]); then

        \$PRINTF "$MESSAGE\n%s\n\e[0m" "Installing FMOD to build $BUILDNAME. Please wait..."
        sudo mkdir -p "/usr/include/FMOD" "\$SRB2BLDROOT/libraries/FMOD"

        if [ -n "\$ISNET" ]; then

            curl -kRLC - "https://zdoom.org/files/fmod/$LNXFMODVER.tar.gz" -o "\$SRB2BLDROOT/libraries/FMOD/$LNXFMODVER.tar.gz"

        fi

        sudo tar xvf "\$SRB2BLDROOT/libraries/FMOD/$LNXFMODVER.tar.gz" --wildcards --strip-components=3 -C "/usr/lib" "$LNXFMODVER/api/libfmod-"*.so
        sudo tar xvf "\$SRB2BLDROOT/libraries/FMOD/$LNXFMODVER.tar.gz" --strip-components=3 -C "/usr/include/FMOD" "$LNXFMODVER/api/inc"

    fi

    # Compile the build's source code.
    \$PRINTF "$MESSAGE\n%s\n\e[0m" "Building $BUILDNAME's source code. Please wait..."

    if [ "\$($PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW64" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW32" ] || [ "\$(\$PRINTF "%s\n" "\$OS" | gawk -F'_' '{print \$1}')" = "MINGW" ]; then

        if [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

            # Running comptime.sh before compiling to avoid errors.
            cd "\$BUILD/src" || exit
            gawk -i inplace '{gsub("\r","");print}' ../comptime.sh
            bash ../comptime.sh

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF
                i686-w64-mingw32-objdump -x "\$BUILD/bin/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            else

                CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF
                \$ARCH-w64-mingw32-objdump -x "\$BUILD/bin/srb2win\$IS64.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            fi

            cd "\$BUILD" || exit

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                CC="i686-w64-mingw32-$MINGWOLDCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF
                i686-w64-mingw32-objdump -x "\$BUILD/bin/Mingw/Release/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            else

                CC="\$ARCH-w64-mingw32-$MINGWOLDCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF
                \$ARCH-w64-mingw32-objdump -x "\$BUILD/bin/Mingw\$IS64/Release/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            mkdir -p "\$BUILD/objs/Mingw/SDL/Release"
            mkdir -p "\$BUILD/objs/Mingw/Release"

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 \$CONF
                i686-w64-mingw32-objdump -x "\$BUILD/bin/Mingw/Release/srb2sdl.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            else

                CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 SDL=1 \$CONF
                \$ARCH-w64-mingw32-objdump -x "\$BUILD/bin/Mingw\$IS64/Release/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF
                i686-w64-mingw32-objdump -x "\$BUILD/bin/Mingw/Release/srb2kart.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            else

                CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 NONX86=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF
                \$ARCH-w64-mingw32-objdump -x "\$BUILD/bin/Mingw\$IS64/Release/srb2kart.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

            CXX="\$ARCH-w64-mingw32-$MINGWCXXVER" CPLUS_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/liblzf/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD" WINDOWS=1 \$CONF
            cd "\$BUILD" || exit

        elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

            mkdir -p "\$BUILD/build"
            cd "\$BUILD/build" || exit

            if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

                MUSLFLAGS="-DNO_WEBVIEW=ON"

            fi

            cmake .. -DwxWidgets_CONFIG_EXECUTABLE=\$(which wx-config wx-config-gtk3 2> /dev/null | head -n1) -DwxWidgets_LIBRARIES=\$(find /usr -name libwx_baseu-*.so 2> /dev/null) \$MUSLFLAGS -DCMAKE_SYSTEM_NAME=Windows -DTOOLCHAIN_PREFIX=x86_64-w64-mingw32 -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY -DCMAKE_CXX_COMPILER="\$ARCH-w64-mingw32-$MINGWCXXVER" -DCMAKE_C_COMPILER="\$ARCH-w64-mingw32-$MINGWCCVER" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr \$CONF
            make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/build"
            make -C "\$BUILD/build" install DESTDIR="\$BUILD/build/AppDir"
            rm -rf "\$BUILD/build/AppDir/usr/share/applications/net.mancubus.SLADE.desktop"
            cd "\$BUILD" || exit

        else

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                # Running comptime.sh before compiling to avoid errors.
                cd "\$BUILD/src" || exit
                gawk -i inplace '{gsub("\r","");print}' ../comptime.sh
                bash ../comptime.sh

                if [ "\$IS64" = "64" ]; then

                    CC="x86_64-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/x86_64-w64-mingw32/include/.:/usr/include/x86_64-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW64=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

                else

                    CC="i686-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/i686-w64-mingw32/include/.:/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW=1 SDL=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

                fi

                # Making list of build's dependencies to copy them to game directory on Windows later.
                if [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ]; then

                    if [ "\$IS64" = "64" ]; then

                        x86_64-w64-mingw32-objdump -x "\$BUILD/bin/Mingw64/Release/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                    else

                        i686-w64-mingw32-objdump -x "\$BUILD/bin/Mingw/Release/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                    fi

                elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ]; then

                    if [ "\$IS64" = "64" ]; then

                        x86_64-w64-mingw32-objdump -x "\$BUILD/bin/Mingw64/Release/srb2kart.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                    else

                        i686-w64-mingw32-objdump -x "\$BUILD/bin/Mingw/Release/srb2kart.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                    fi

                else

                    if [ "\$IS64" = "64" ]; then

                        x86_64-w64-mingw32-objdump -x "\$BUILD/bin/srb2win64.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                    else

                        i686-w64-mingw32-objdump -x "\$BUILD/bin/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                    fi

                fi

                cd "\$BUILD" || exit

            else

                # Running comptime.sh before compiling to avoid errors.
                cd "\$BUILD/src" || exit
                gawk -i inplace '{gsub("\r","");print}' ../comptime.sh
                bash ../comptime.sh

                CC="\$ARCH-w64-mingw32-$MINGWCCVER" C_INCLUDE_PATH="/usr/\$ARCH-w64-mingw32/include/.:/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" MINGW\$IS64=1 SDL=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

                # Making list of build's dependencies to copy them to game directory on Windows later.
                if [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ]; then

                    \$ARCH-w64-mingw32-objdump -x "\$BUILD/bin/Mingw\$IS64/Release/srb2win.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

                    \$ARCH-w64-mingw32-objdump -x "\$BUILD/bin/Mingw\$IS64/Release/srb2kart.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                else

                    \$ARCH-w64-mingw32-objdump -x "\$BUILD/bin/srb2win\$IS64.exe" | gawk '/DLL/ && /.dll/ {print \$NF}' > "\$BUILD/deps"

                fi

                cd "\$BUILD" || exit

            fi

        fi

     elif [ "\$OS" = "Linux" ]; then

        # Temporarily disabling libpng12 to avoid compiling errors for SRB2 Final Demo.
        if [ -f \$SRB2BLDPREFIX/lib/libpng12.so ] && [ -d \$SRB2BLDPREFIX/stow/libpng12 ] && [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" != "musl" ] && [ "\$BUILD" != "\$BUILDPATH/srb2-2.0" ]; then

            sudo -E stow -D --adopt libpng12

        fi

        if [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-\$(arch)/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

            else

                CC="$GCCOLDVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-\$(arch)/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            mkdir -p "\$BUILD/objs/Linux/SDL/Release"

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                CC="$GCCVER" C_INCLUDE_PATH="/usr/include/i386-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-x86/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 \$CONF

            else

                CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/.:/usr/lib/klibc-\$(arch)/include/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX=1 NONX86=1 \$CONF

            fi

        elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

            sudo -E STOW_DIR=/usr/local/stow stow -D liblzf
            CXX="$GXXVER" CPLUS_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/liblzf/." make -k -j\$((\$(nproc) + 1)) -C "\$BUILD" \$CONF
            sudo -E STOW_DIR=/usr/local/stow stow --adopt liblzf

        elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

            mkdir -p "\$BUILD/build"
            cd "\$BUILD/build" || exit

            if [ "\$(ldd --version 2>&1 | gawk 'match(\$0, /musl/) {print substr(\$0, RSTART, RLENGTH)}' | gawk '!a[\$0]++ {print}')" = "musl" ]; then

                MUSLFLAGS="-DNO_WEBVIEW=ON"

            fi

            cmake .. -DwxWidgets_CONFIG_EXECUTABLE=\$(which wx-config wx-config-gtk3 2> /dev/null | head -n1) -DwxWidgets_LIBRARIES=\$(find /usr -name libwx_baseu-*.so 2> /dev/null) \$MUSLFLAGS -DCMAKE_CXX_COMPILER="$GXXVER" -DCMAKE_C_COMPILER="$GCCVER" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=\$SRB2BLDPREFIX \$CONF
            make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/build"
            sudo make -C "\$BUILD/build" install
            sudo rm -rf "\$SRB2BLDPREFIX/share/applications/net.mancubus.SLADE.desktop"
            cd "\$BUILD" || exit

        else

            # Running comptime.sh before compiling to avoid errors.
            cd "\$BUILD/src" || exit
            gawk -i inplace '{gsub("\r","");print}' ../comptime.sh
            bash ../comptime.sh

            if [ "\$ARCH" = "i386" ] || [ "\$ARCH" = "i486" ] || [ "\$ARCH" = "i686" ] || [ "\$ARCH" = "x86_64" ]; then

                CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

            else

                CC="$GCCVER" C_INCLUDE_PATH="/usr/include/\$ARCH-linux-gnu/.:/usr/include/.:\$SRB2BLDPREFIX/include/.:\$SRB2BLDPREFIX/include/SDL2/." LIBGME_CFLAGS= LIBGME_LDFLAGS=-lgme make -k -j\$((\$(nproc) + 1)) -C "\$BUILD/src" LINUX\$IS64=1 NONX86=1 NOOBJDUMP=1 NOVERSION=1 NOUPX=1 \$CONF

            fi

            cd "\$BUILD" || exit

        fi

        # Renabling libpng12.
        if [ ! -f \$SRB2BLDPREFIX/lib/libpng12.so ] && [ -d \$SRB2BLDPREFIX/stow/libpng12 ]; then

            sudo -E stow --adopt libpng12

        fi

    fi

    # Copy compiled binary to AppDir.
    if [ -f "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/lsdl2srb2" ]; then

        cp -rf "\$BUILD/bin/lsdl2srb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/Linux\$IS64/Release/srb2legacy" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/srb2legacy" "\$BUILD/build/AppDir/usr/bin/lsdl2srb2"

    elif [ -f "\$BUILD/bin/srb2legacy" ]; then

        cp -rf "\$BUILD/bin/srb2legacy" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/Linux\$IS64/Release/lsdlsrb2" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/lsdlsrb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/lsdlsrb2" ]; then

        cp -rf "\$BUILD/bin/lsdlsrb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/Linux/Release/lsdl2srb2" ]; then

        cp -rf "\$BUILD/bin/Linux/Release/lsdl2srb2" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2kart" ]; then

        cp -rf "\$BUILD/bin/Linux\$IS64/Release/lsdl2srb2kart" "\$BUILD/build/AppDir/usr/bin"

    elif [ -f "\$BUILD/bin/lsdl2srb2kart" ]; then

        cp -rf "\$BUILD/bin/lsdl2srb2kart" "\$BUILD/build/AppDir/usr/bin"

    elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        cp -rf "\$BUILD/wadcli" "\$BUILD/build/AppDir/usr/bin"

#    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

#        cp -rf "\$BUILD/build/slade" "\$BUILD/build/AppDir/usr/bin"

    fi

    # Saving configuration flags for future upgrades.
    \$PRINTF "%s\n" "\$CONF" > "\$BUILD/conf"

    # Create desktop file.
    COMREV=\$(git -C "\$BUILD" rev-parse --short HEAD)

    if [ "\$BUILD" = "\$BUILDPATH/srb2" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 (Software)
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=srb2
Exec=srb2 -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 \\\(Software\\\)","Name=Sonic Robo Blast 2 (OpenGL)") || gsub("Exec=srb2 -software","Exec=srb2 -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2uncappedplus-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 Uncapped PLUS (Software)
Comment=Modified open source 3D Sonic platformer with improved framerate and additional features
Icon=srb2uncappedplus
Exec=srb2ucp -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2uncappedplus-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2uncappedplus-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Uncapped PLUS \\\(Software\\\)","Name=Sonic Robo Blast 2 Uncapped PLUS (OpenGL)") || gsub("Exec=srb2ucp -software","Exec=srb2ucp -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2uncappedplus-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2netplus-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 NetPlus (Software)
Comment=Modified open source 3D Sonic platformer with rollback netcode
Icon=srb2netplus
Exec=srb2np -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2netplus-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2netplus-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 NetPlus \\\(Software\\\)","Name=Sonic Robo Blast 2 NetPlus (OpenGL)") || gsub("Exec=srb2np -software","Exec=srb2np -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2netplus-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2rphys-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 rphys (Software)
Comment=Modified open source 3D Sonic platformer with customized physics and movesets
Icon=srb2rphys
Exec=srb2rphys -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2rphys-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2rphys-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 rphys \\\(Software\\\)","Name=Sonic Robo Blast 2 rphys (OpenGL)") || gsub("Exec=srb2rphys -software","Exec=srb2rphys -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2rphys-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2vr-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 VR (Software)
Comment=Modified open source 3D Sonic VR platformer with improved framerate and additional features
Icon=srb2vr
Exec=srb2vr -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2vr-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2vr-opengl.desktop"
    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2vr-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2vr-openvr.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 VR \\\(Software\\\)","Name=Sonic Robo Blast 2 VR (OpenGL)") || gsub("Exec=srb2vr -software","Exec=srb2vr -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2vr-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 VR \\\(Software\\\)","Name=Sonic Robo Blast 2 VR (OpenVR)") || gsub("Exec=srb2vr -software","Exec=srb2vr -openvr -win");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2vr-openvr.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2legacy-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 v2.1 Legacy (Software)
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=srb2legacy
Exec=srb2legacy -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2legacy-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2legacy-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 v2.1 Legacy \\\(Software\\\)","Name=Sonic Robo Blast 2 v2.1 Legacy (OpenGL)") || gsub("Exec=srb2legacy -software","Exec=srb2legacy -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2legacy-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2_2.0-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 v2.0 (Software)
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=srb2_2.0
Exec=srb2_2.0 -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2_2.0-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2_2.0-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 v2.0 \\\(Software\\\)","Name=Sonic Robo Blast 2 v2.0 (OpenGL)") || gsub("Exec=srb2_2.0 -software","Exec=srb2_2.0 -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2_2.0-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2finaldemo-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 Final Demo (Software)
Comment=Open source 3D Sonic platformer based on Doom Legacy engine
Icon=srb2finaldemo
Exec=srb2fd -software
Categories=Game;
Keywords=sonic;platformer;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2finaldemo-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2finaldemo-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Final Demo \\\(Software\\\)","Name=Sonic Robo Blast 2 Final Demo (OpenGL)") || gsub("Exec=srb2fd -software","Exec=srb2fd -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2finaldemo-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2persona-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 Persona (Software)
Comment=Modified open source 3D Sonic game with Persona gameplay
Icon=srb2persona
Exec=srb2p -software
Categories=Game;
Keywords=sonic;rpg;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2persona-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2persona-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Persona \\\(Software\\\)","Name=Sonic Robo Blast 2 Persona (OpenGL)") || gsub("Exec=srb2p -software","Exec=srb2p -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2persona-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2kart-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 Kart (Software)
Comment=Modified open source 3D Sonic game with kart racing gameplay
Icon=srb2kart
Exec=srb2kart -software
Categories=Game;
Keywords=sonic;kart;racing;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2kart-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2kart-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Kart \\\(Software\\\)","Name=Sonic Robo Blast 2 Kart (OpenGL)") || gsub("Exec=srb2kart -software","Exec=srb2kart -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2kart-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2kartmoemansion-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 Kart Moe Mansion (Software)
Comment=Modified open source 3D Sonic game with kart racing gameplay, improved framerate and additional features
Icon=srb2kartmoemansion
Exec=srb2kartmoe -software
Categories=Game;
Keywords=sonic;kart;racing;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2kartmoemansion-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2kartmoemansion-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Kart Moe Mansion \\\(Software\\\)","Name=Sonic Robo Blast 2 Kart Moe Mansion (OpenGL)") || gsub("Exec=srb2kartmoe -software","Exec=srb2kartmoe -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2kartmoemansion-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/srb2kartvr-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 Kart VR (Software)
Comment=Modified open source 3D Sonic game with VR kart racing gameplay, improved framerate and additional features
Icon=srb2kartvr
Exec=srb2kartvr -software
Categories=Game;
Keywords=sonic;kart;racing;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2kartvr-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2kartvr-opengl.desktop"
    cp -f "\$BUILD/build/AppDir/usr/share/applications/srb2kartvr-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/srb2kartvr-openvr.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Kart VR \\\(Software\\\)","Name=Sonic Robo Blast 2 Kart VR (OpenGL)") || gsub("Exec=srb2kartvr -software","Exec=srb2kartvr -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2kartvr-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Kart VR \\\(Software\\\)","Name=Sonic Robo Blast 2 Kart VR (OpenVR)") || gsub("Exec=srb2kartvr -software","Exec=srb2kartvr -openvr -win");print}' "\$BUILD/build/AppDir/usr/share/applications/srb2kartvr-openvr.desktop"

    elif [ "\$(dirname \$BUILD)" = "\$BUILDPATH/srb2-custom" ]; then

        SRB2CNAME="\$SRB2CCONFDIR"c"\$CUSTOMDIR"

        cat > "\$BUILD/build/AppDir/usr/share/applications/"\$SRB2CCONFDIR"c"\$CUSTOMDIR"-software.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=Sonic Robo Blast 2 Custom \$CUSTOMDIR (Software)
Comment=Modified open source 3D Sonic game
Icon=\$SRB2CNAME
Exec=\$SRB2CNAME -software
Categories=Game;
Keywords=sonic;
Terminal=false
NoDisplay=false
DESKTOP

    cp -f "\$BUILD/build/AppDir/usr/share/applications/\$SRB2CNAME-software.desktop" "\$BUILD/build/AppDir/usr/share/applications/\$SRB2CNAME-opengl.desktop"
    gawk -i inplace '{gsub("Name=Sonic Robo Blast 2 Custom '$CUSTOMDIR' \\\(Software\\\)","Name=Sonic Robo Blast 2 Custom '$CUSTOMDIR' (OpenGL)") || gsub("Exec='\$SRB2CNAME' -software","Exec='\$SRB2CNAME' -opengl");print}' "\$BUILD/build/AppDir/usr/share/applications/\$SRB2CNAME-opengl.desktop"

    elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/wadcli.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=wadcli
Comment=Allows the manipulation of Doom WAD files through command-line
Icon=wadcli
Exec=wadcli
Categories=Development;
Keywords=sonic;wad;
Terminal=true
NoDisplay=false
DESKTOP

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        cat > "\$BUILD/build/AppDir/usr/share/applications/slade.desktop" << DESKTOP
[Desktop Entry]
Version=\$COMREV
Type=Application
Name=slade
Comment=Allows the manipulation of Doom WAD files
Icon=slade
Exec=slade
Categories=Development;
Keywords=sonic;wad;
Terminal=false
NoDisplay=false
DESKTOP

    fi

    # Get app icon.
    if [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        if [ -n "\$ISNET" ]; then

            curl -L https://www.iconfinder.com/icons/285695/download/png/64 -o "\$BUILD/build/icon.png"

        else

            cp -rf \$(find "/usr/share/icons/hicolor" -type f -name "*.png" | head -n1) "\$BUILD/build/icon.png"

        fi

        ICONSIZE=\$(identify "\$BUILD/build/icon.png" | gawk '{print \$3}')
        mkdir -p "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps"

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        ICONSIZE=\$(identify "\$SRB2BLDPREFIX/share/icons/net.mancubus.SLADE.png" | gawk '{print \$3}')
        sudo mkdir -p "\$SRB2BLDPREFIX/share/icons/hicolor/\$ICONSIZE/apps"

    else

        if [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ] || [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

            convert "\$BUILD/src/win32/Srb2win.ico" -resize 64x64\! -filter lanczos -alpha on -background none -flatten "\$BUILD/build/icon.png"

        else

            convert "\$BUILD/src/win32/Srb2win.ico[5]" -resize 64x64\! -filter lanczos -alpha on -background none -flatten "\$BUILD/build/icon.png"

        fi

        ICONSIZE=\$(identify "\$BUILD/build/icon.png" | gawk '{print \$3}')
        mkdir -p "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps"

    fi

    if [ "\$BUILD" = "\$BUILDPATH/srb2" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-uncapped-plus" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2uncappedplus.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-netplus" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2netplus.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-rphys" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2rphys.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-vr" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2vr.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.1-legacy" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2legacy.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-2.0" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2_2.0.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-final-demo" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2finaldemo.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-persona" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2persona.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2kart.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-moe-mansion" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2kartmoemansion.png"

    elif [ "\$BUILD" = "\$BUILDPATH/srb2-kart-vr" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/srb2kartvr.png"

    elif [ "\$(dirname \$BUILD)" = "\$BUILDPATH/srb2-custom" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/"\$SRB2CCONFDIR"c"\$CUSTOMDIR".png"

    elif [ "\$BUILD" = "\$BUILDPATH/wadcli" ]; then

        cp -f "\$BUILD/build/icon.png" "\$BUILD/build/AppDir/usr/share/icons/hicolor/\$ICONSIZE/apps/wadcli.png"

    elif [ "\$BUILD" = "\$BUILDPATH/slade" ]; then

        sudo mv -f "\$SRB2BLDPREFIX/share/icons/net.mancubus.SLADE.png" "\$SRB2BLDPREFIX/share/icons/hicolor/\$ICONSIZE/apps/slade.png"

    fi

fi

ENTRYPOINT
    chmod +x "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker/Entrypoint"

    # Prepare Docker images.
    rm -rf "$SRB2BLDROOT/containers/srb2-games-old-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-tools-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-games-linux-musl-docker" "$SRB2BLDROOT/containers/srb2-games-old-linux-musl-docker" "$SRB2BLDROOT/containers/srb2-tools-linux-musl-docker" "$SRB2BLDROOT/containers/srb2-games-windows-docker" "$SRB2BLDROOT/containers/srb2-games-old-windows-docker" "$SRB2BLDROOT/containers/srb2-tools-windows-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-games-old-linux-glibc-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-tools-linux-glibc-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-games-linux-musl-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-games-old-linux-musl-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-tools-linux-musl-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-games-windows-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-games-old-windows-docker"
    cp -rf "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker" "$SRB2BLDROOT/containers/srb2-tools-windows-docker"

    # Set CPU architecture for Docker images in case of building old SRB2 versions.
    if ([ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]) && ([ "$ARCH" = "i386" ] || [ "$ARCH" = "i486" ] || [ "$ARCH" = "i686" ] || [ "$ARCH" = "x86_64" ]) && [ "$BUILD" = "$BUILDPATH/srb2-2.0" ]; then

        ISARM="i386/"

    elif ([ "$ARCH" = "i386" ] || [ "$ARCH" = "i486" ] || [ "$ARCH" = "i686" ] || [ "$ARCH" = "x86_64" ]) && [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

        ISARM="i386/"

    elif ([ "$ARCH" = "armhf" ] || [ "$ARCH" = "aarch64" ]) && [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

        ISARM="armhf/"

    fi

    # Create Dockerfiles.
    cat > "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"ubuntu:"$UBUVER"

ENV container docker \
DEBIAN_FRONTEND noninteractive

RUN printf 'Acquire::Check-Valid-Until "false";\n' > /etc/apt/apt.conf.d/90ignore-release-date && \
printf 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";\n' > /etc/apt/apt.conf.d/01norecommend && \
apt-get update && \
apt-get install -y gnupg apt-transport-https ca-certificates curl gawk && \
printf "deb http://ppa.launchpad.net/apt-fast/stable/ubuntu bionic main\ndeb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu bionic main" >> /etc/apt/sources.list && \
curl -Ls "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1EE2FF37CA8DA16B" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/aptfast.gpg > /dev/null && \
curl -Ls "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1E9377A2BA9EF27F" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/toolchain.gpg > /dev/null

RUN apt-get update && \
apt-get upgrade -y && \
apt-get install -y apt-fast && \
apt-fast install -y libsdl2-dev libsdl2-mixer-dev libsdl1.2-dev libsdl-image1.2-dev libsdl-mixer1.2-dev libsdl-ttf2.0-dev libgme-dev libopenmpt-dev libfluidsynth-dev libmodplug-dev libjack-dev libcurl4-openssl-dev libupnp-dev zlib1g-dev rapidjson-dev libfuse-dev fuse imagemagick nasm build-essential $GCCVER automake libtool cmake file sudo dash git stow p7zip-full p7zip-rar

RUN printf "%s\n" "%sudo ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G sudo -s /bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-games-old-linux-glibc-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"debian:"$DEBVER"

ENV container docker \
DEBIAN_FRONTEND noninteractive

RUN printf 'Acquire::Check-Valid-Until "false";\n' > /etc/apt/apt.conf.d/90ignore-release-date && \
printf 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";\n' > /etc/apt/apt.conf.d/01norecommend && \
apt-get update && \
apt-get install -y gnupg apt-transport-https ca-certificates curl gawk && \
gawk -i inplace '{gsub("main","main contrib non-free");print}' /etc/apt/sources.list && \
printf "deb http://ppa.launchpad.net/apt-fast/stable/ubuntu bionic main" >> /etc/apt/sources.list && \
curl -Lks "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1EE2FF37CA8DA16B" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/aptfast.gpg > /dev/null

RUN apt-get update && \
apt-get upgrade -y && \
apt-get install -y apt-fast && \
apt-fast install -y libsdl2-dev libsdl2-mixer-dev libsdl1.2-dev libsdl-image1.2-dev libsdl-mixer1.2-dev libsdl-ttf2.0-dev libgme-dev libfluidsynth-dev libmodplug-dev libjack-dev libcurl4-openssl-dev libupnp-dev zlib1g-dev libfuse-dev fuse imagemagick nasm build-essential automake libtool cmake file sudo dash git stow p7zip-full p7zip-rar

RUN printf "%s\n" "%sudo ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G sudo -s /bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-tools-linux-glibc-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"ubuntu:"$UBUSOFTVER"

ENV container docker \
DEBIAN_FRONTEND noninteractive

RUN printf 'Acquire::Check-Valid-Until "false";\n' > /etc/apt/apt.conf.d/90ignore-release-date && \
printf 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";\n' > /etc/apt/apt.conf.d/01norecommend && \
apt-get update && \
apt-get install -y gnupg apt-transport-https ca-certificates curl gawk && \
printf "deb http://ppa.launchpad.net/apt-fast/stable/ubuntu focal main\ndeb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu focal main" >> /etc/apt/sources.list && \
curl -Ls "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1EE2FF37CA8DA16B" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/aptfast.gpg > /dev/null && \
curl -Ls "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1E9377A2BA9EF27F" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/toolchain.gpg > /dev/null

RUN apt-get update && \
apt-get upgrade -y && \
apt-get install -y apt-fast && \
apt-fast install -y liblzf-dev libfmt-dev libsfml-dev libjpeg-dev libogg-dev libflac-dev libvorbis-dev libopenal-dev libudev-dev libglew-dev libfreeimage-dev libftgl-dev libfluidsynth-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgconf2-dev freeglut3-dev libmodplug-dev libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev libcurl4-openssl-dev libwxgtk-webview3.0-gtk3-dev libbz2-dev libgtk-3-dev liblua5.3-dev libmpg123-dev libfuse-dev fuse imagemagick nasm build-essential $GCCVER $GXXVER automake libtool cmake file sudo dash git stow p7zip-full p7zip-rar

RUN printf "%s\n" "%sudo ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G sudo -s /bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-games-linux-musl-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"alpine:latest

ENV container docker

RUN printf "https://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories && \
apk update && \
apk upgrade && \
apk add sdl2-dev sdl2_mixer-dev sdl-dev sdl_mixer-dev glu-dev fluidsynth-dev libmodplug-dev mpg123-dev jack-dev curl-dev libupnp-dev zlib-dev libexecinfo-dev klibc-dev imagemagick nasm build-base automake autoconf libtool cmake sudo bash dash gawk curl git p7zip shadow stow rapidjson-dev
RUN printf "%s\n" "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G wheel -s /usr/bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /usr/bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-games-old-linux-musl-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"alpine:latest

ENV container docker

RUN printf "https://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories && \
apk update && \
apk upgrade && \
apk add sdl2-dev sdl2_mixer-dev sdl-dev sdl_mixer-dev glu-dev fluidsynth-dev libmodplug-dev mpg123-dev jack-dev curl-dev libupnp-dev zlib-dev libexecinfo-dev klibc-dev imagemagick nasm build-base $($PRINTF "%s\n" $GCCVER | gawk '{gsub("-","");print}') automake autoconf libtool cmake sudo bash dash gawk curl git p7zip shadow stow

RUN printf "%s\n" "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G wheel -s /usr/bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /usr/bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-tools-linux-musl-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"alpine:latest

ENV container docker

RUN apk update && \
apk upgrade && \
apk add liblzf-dev fmt-dev sfml-dev jpeg-dev libogg-dev flac-dev libvorbis-dev openal-soft-dev eudev-dev glew-dev freeimage-dev ftgl-dev fluidsynth-dev gstreamer-dev gst-plugins-base-dev freeglut-dev libmodplug-dev wxgtk3-dev wxgtk3-media curl-dev libbz2 gtk+3.0 lua-dev mpg123-dev fuse-dev libexecinfo-dev imagemagick nasm build-base automake autoconf libtool cmake sudo bash dash gawk curl git p7zip shadow stow

RUN printf "%s\n" "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G wheel -s /usr/bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /usr/bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-games-windows-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"debian:latest

ENV container docker \
DEBIAN_FRONTEND noninteractive

RUN printf 'Acquire::Check-Valid-Until "false";\n' > /etc/apt/apt.conf.d/90ignore-release-date && \
printf 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";\n' > /etc/apt/apt.conf.d/01norecommend && \
apt-get update && \
apt-get install -y gnupg apt-transport-https ca-certificates curl gawk && \
gawk -i inplace '{gsub("main","main contrib non-free");print}' /etc/apt/sources.list && \
printf "deb http://ppa.launchpad.net/apt-fast/stable/ubuntu bionic main" >> /etc/apt/sources.list && \
curl -Ls "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1EE2FF37CA8DA16B" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/aptfast.gpg > /dev/null

RUN apt-get update && \
apt-get upgrade -y && \
apt-get install -y apt-fast && \
apt-fast install -y libsdl2-dev libsdl2-mixer-dev libsdl1.2-dev libsdl-image1.2-dev libsdl-mixer1.2-dev libsdl-ttf2.0-dev libgme-dev libopenmpt-dev libfluidsynth-dev libmodplug-dev libjack-dev libcurl4-openssl-dev libupnp-dev zlib1g-dev rapidjson-dev libfuse-dev fuse imagemagick nasm build-essential mingw-w64 automake libtool cmake file sudo dash git stow p7zip-full p7zip-rar

RUN printf "%s\n" "%sudo ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G sudo -s /bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-games-old-windows-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"debian:"$DEBVER"

ENV container docker \
DEBIAN_FRONTEND noninteractive

RUN printf 'Acquire::Check-Valid-Until "false";\n' > /etc/apt/apt.conf.d/90ignore-release-date && \
printf 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";\n' > /etc/apt/apt.conf.d/01norecommend && \
apt-get update && \
apt-get install -y gnupg apt-transport-https ca-certificates curl gawk && \
gawk -i inplace '{gsub("main","main contrib non-free");print}' /etc/apt/sources.list && \
printf "deb http://ppa.launchpad.net/apt-fast/stable/ubuntu bionic main" >> /etc/apt/sources.list && \
curl -Lks "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1EE2FF37CA8DA16B" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/aptfast.gpg > /dev/null

RUN apt-get update && \
apt-get upgrade -y && \
apt-get install -y apt-fast && \
apt-fast install -y libsdl2-dev libsdl2-mixer-dev libsdl1.2-dev libsdl-image1.2-dev libsdl-mixer1.2-dev libsdl-ttf2.0-dev libgme-dev libfluidsynth-dev libmodplug-dev libjack-dev libfuse-dev libcurl4-openssl-dev libupnp-dev zlib1g-dev fuse imagemagick nasm build-essential mingw-w64 automake libtool cmake file sudo dash git p7zip-full p7zip-rar stow

RUN printf "%s\n" "%sudo ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G sudo -s /bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE

    cat > "$SRB2BLDROOT/containers/srb2-tools-windows-docker/Dockerfile" << DOCKERFILE
FROM "$ISARM"debian:latest

ENV container docker \
DEBIAN_FRONTEND noninteractive

RUN printf 'Acquire::Check-Valid-Until "false";\n' > /etc/apt/apt.conf.d/90ignore-release-date && \
printf 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";\n' > /etc/apt/apt.conf.d/01norecommend && \
apt-get update && \
apt-get install -y gnupg apt-transport-https ca-certificates curl gawk && \
gawk -i inplace '{gsub("main","main contrib non-free");print}' /etc/apt/sources.list && \
printf "deb http://ppa.launchpad.net/apt-fast/stable/ubuntu bionic main" >> /etc/apt/sources.list && \
curl -Ls "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1EE2FF37CA8DA16B" | gawk '!/Comment:|Version:/ {gsub("\r","");print}' | gpg --dearmor | tee /etc/apt/trusted.gpg.d/aptfast.gpg > /dev/null

RUN apt-get update && \
apt-get upgrade -y && \
apt-get install -y apt-fast && \
apt-fast install -y libfluidsynth-dev libmodplug-dev libjack-dev libcurl4-openssl-dev libupnp-dev zlib1g-dev libglew-dev libfreeimage-dev libftgl-dev libsfml-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgconf2-dev freeglut3-dev libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev libwxgtk-webview3.0-gtk3-dev libbz2-dev libgtk-3-dev liblua5.3-dev libfmt-dev libmpg123-dev liblzf-dev libfuse-dev fuse imagemagick nasm build-essential mingw-w64 automake libtool cmake file sudo dash git stow p7zip-full p7zip-rar rapidjson-dev

RUN printf "%s\n" "%sudo ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
useradd -m -G sudo -s /bin/dash srb2 && \
passwd -d srb2 && \
ln -sf /bin/dash /bin/sh

COPY Entrypoint /home/srb2

ENTRYPOINT [ "/home/srb2/Entrypoint" ]

DOCKERFILE
}

dockerrun() {
    # Restarting Docker daemon in order to avoid connection to be refused by Docker image repository. One time check after every reboot/shutdown of system.
    if [ ! -f /tmp/srb2bld-docker ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Restarting Docker daemon. Please wait..."

        if [ -x "$(which systemctl 2> /dev/null)" ] && [ -n "$(systemctl --user list-units docker.service | gawk '/docker/ {print $1}')" ]; then

            systemctl --user restart docker

        elif [ -x "$(which systemctl 2> /dev/null)" ] && [ -n "$(systemctl list-units docker.service | gawk '/docker/ {print $1}')" ]; then

            $SUDO systemctl restart docker

        elif [ -x "$(which rc-service 2> /dev/null)" ]; then

            $SUDO rc-service docker restart

        elif [ -x "$(which sv 2> /dev/null)" ]; then

            $SUDO sv restart docker

        fi

        touch /tmp/srb2bld-docker
        sleep 1

    fi

    # Running Docker container.
    if [ "$BUILD" = "$BUILDPATH/srb2-2.0" ]; then

        if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for Windows SRB2 builds. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"debian:"$DEBVER"

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for Windows SRB2 builds. Please wait..."
            docker build --rm -t srb2-games-old-windows-docker "$SRB2BLDROOT/containers/srb2-games-old-windows-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            winpty docker run -it --security-opt="label:disable" --volume="$($PRINTF "%s\n" "$HOME" | gawk '{gsub("/","\\");gsub("\\\\Users",":\\Users");gsub("^\\\\","");print}')\\AppData\\Roaming\\srb2bld:$SRB2BLDROOT:rw" srb2-games-old-windows-docker

        elif [ "$(ldd --version 2>&1 | gawk 'match($0, /musl/) {print substr($0, RSTART, RLENGTH)}' | gawk '!a[$0]++ {print}')" = "musl" ]; then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for musl based Linux SRB2 builds. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"alpine:latest

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for musl based Linux SRB2 builds. Please wait..."
            docker build --rm -t srb2-games-old-linux-musl-docker "$SRB2BLDROOT/containers/srb2-games-old-linux-musl-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            docker run -it --security-opt="label:disable" --volume="$SRB2BLDROOT:$SRB2BLDROOT:rw" --volume="$SRB2BLDPREFIX:$SRB2BLDPREFIX:rw" srb2-games-old-linux-musl-docker

        else

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for glibc based Linux SRB2 builds. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"debian:"$DEBVER"

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for glibc based Linux SRB2 builds. Please wait..."
            docker build --rm -t srb2-games-old-linux-glibc-docker "$SRB2BLDROOT/containers/srb2-games-old-linux-glibc-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            docker run -it --security-opt="label:disable" --volume="$SRB2BLDROOT:$SRB2BLDROOT:rw" --volume="$SRB2BLDPREFIX:$SRB2BLDPREFIX:rw" srb2-games-old-linux-glibc-docker

        fi

    else

        if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ] && ([ "$BUILD" = "$BUILDPATH/wadcli" ] || [ "$BUILD" = "$BUILDPATH/slade" ]); then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for Windows SRB2 tools. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"debian:latest

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for Windows SRB2 tools. Please wait..."
            docker build --rm -t srb2-tools-windows-docker "$SRB2BLDROOT/containers/srb2-tools-windows-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            winpty docker run -it --security-opt="label:disable" --volume="$($PRINTF "%s\n" "$HOME" | gawk '{gsub("/","\\");gsub("\\\\Users",":\\Users");gsub("^\\\\","");print}')\\AppData\\Roaming\\srb2bld:$SRB2BLDROOT:rw" srb2-tools-windows-docker

        elif [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for Windows SRB2 builds. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"debian:latest

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for Windows SRB2 builds. Please wait..."
            docker build --rm -t srb2-games-windows-docker "$SRB2BLDROOT/containers/srb2-games-windows-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            winpty docker run -it --security-opt="label:disable" --volume="$($PRINTF "%s\n" "$HOME" | gawk '{gsub("/","\\");gsub("\\\\Users",":\\Users");gsub("^\\\\","");print}')\\AppData\\Roaming\\srb2bld:$SRB2BLDROOT:rw" srb2-games-windows-docker

        elif [ "$(ldd --version 2>&1 | gawk 'match($0, /musl/) {print substr($0, RSTART, RLENGTH)}' | gawk '!a[$0]++ {print}')" = "musl" ] && ([ "$BUILD" = "$BUILDPATH/wadcli" ] || [ "$BUILD" = "$BUILDPATH/slade" ]); then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for musl based Linux SRB2 tools. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"alpine:latest

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for musl based Linux SRB2 tools. Please wait..."
            docker build --rm -t srb2-tools-linux-musl-docker "$SRB2BLDROOT/containers/srb2-tools-linux-musl-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            docker run -it --security-opt="label:disable" --volume="$SRB2BLDROOT:$SRB2BLDROOT:rw" --volume="$SRB2BLDPREFIX:$SRB2BLDPREFIX:rw" srb2-tools-linux-musl-docker

        elif [ "$(ldd --version 2>&1 | gawk 'match($0, /musl/) {print substr($0, RSTART, RLENGTH)}' | gawk '!a[$0]++ {print}')" = "musl" ]; then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for musl based Linux SRB2 builds. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"alpine:latest

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for musl based Linux SRB2 builds. Please wait..."
            docker build --rm -t srb2-games-linux-musl-docker "$SRB2BLDROOT/containers/srb2-games-linux-musl-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            docker run -it --security-opt="label:disable" --volume="$SRB2BLDROOT:$SRB2BLDROOT:rw" --volume="$SRB2BLDPREFIX:$SRB2BLDPREFIX:rw" srb2-games-linux-musl-docker

        elif [ "$OS" = "Linux" ] && ([ "$BUILD" = "$BUILDPATH/wadcli" ] || [ "$BUILD" = "$BUILDPATH/slade" ]); then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for glibc based Linux SRB2 tools. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"ubuntu:"$UBUSOFTVER"

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for glibc based Linux SRB2 tools. Please wait..."
            docker build --rm -t srb2-tools-linux-glibc-docker "$SRB2BLDROOT/containers/srb2-tools-linux-glibc-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            docker run -it --security-opt="label:disable" --volume="$SRB2BLDROOT:$SRB2BLDROOT:rw" --volume="$SRB2BLDPREFIX:$SRB2BLDPREFIX:rw" srb2-tools-linux-glibc-docker

        else

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating Docker image for glibc based Linux SRB2 builds. Please wait..."

            if [ -n "$ISNET" ]; then

                docker pull "$ISARM"ubuntu:"$UBUVER"

            fi

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building Docker image for glibc based Linux SRB2 builds. Please wait..."
            docker build --rm -t srb2-games-linux-glibc-docker "$SRB2BLDROOT/containers/srb2-games-linux-glibc-docker"
            $PRINTF "$MESSAGE\n%s\n\e[0m" "Running Docker container from built image for $BUILDNAME. Please wait..."
            docker run -it --security-opt="label:disable" --volume="$SRB2BLDROOT:$SRB2BLDROOT:rw" --volume="$SRB2BLDPREFIX:$SRB2BLDPREFIX:rw" srb2-games-linux-glibc-docker

        fi

    fi

    CONTAINER_ID=$(docker ps -alq)
    docker stop "$CONTAINER_ID" > /dev/null
    docker container rm "$CONTAINER_ID" > /dev/null
}

extractmacosassets() {
    if [ "$BUILD" = "$BUILDPATH/srb2" ] || [ "$BUILD" = "$BUILDPATH/srb2-uncapped-plus" ] || [ "$BUILD" = "$BUILDPATH/srb2-netplus" ] || [ "$BUILD" = "$BUILDPATH/srb2-rphys" ] || [ "$BUILD" = "$BUILDPATH/srb2-vr" ]; then

        if [ "$BUILD" = "$BUILDPATH/srb2-rphys" ]; then

            if [ -n "$ISNET" ] && [ "$(curl -X GET -sLI "$SRB2RPHYSASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" != "$(stat -f %z "$SRB2BLDROOT/assets/SRB2rphys.zip" 2> /dev/null)" ]; then

                curl -RL "$SRB2RPHYSASSETURL" -o "$SRB2BLDROOT/assets/SRB2rphys.zip"

            fi

            7z x -y "$SRB2BLDROOT/assets/SRB2rphys.zip" "*.pk3" "*.wad" -o"$BUILD/assets/installer"

        fi

        # Temporary fix until SRB2 VR will be updated to the latest version of SRB2.
        if [ "$BUILD" = "$BUILDPATH/srb2-vr" ]; then

            if [ -n "$ISNET" ]; then

                curl -RLC - https://github.com/STJr/SRB2/releases/download/SRB2_release_2.2.9/SRB2-v229-Patch.zip -o "$SRB2BLDROOT/assets/SRB2VR-Patch.zip"

            fi

            7z x -y "$SRB2BLDROOT/assets/SRB2VR-Patch.zip" "*.pk3" -o"$BUILD/assets/installer"

        fi

        extractsrb2macosassets

    elif [ "$BUILD" = "$BUILDPATH/srb2-persona" ]; then

        if [ -n "$ISNET" ] && [ "$(curl -X GET -sLI "$SRB2PERSONAASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" != "$(stat -f %z "$SRB2BLDROOT/assets/SRB2P_MP.zip" 2> /dev/null)" ]; then

            curl -RL "$SRB2PERSONAASSETURL" -o "$SRB2BLDROOT/assets/SRB2P_MP.zip"

        fi

        7z x -y "$SRB2BLDROOT/assets/SRB2P_MP.zip" "*.pk3" "*.wad" -o"$BUILD/assets/installer"
        extractsrb2macosassets

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.1-legacy" ]; then

        if [ -n "$ISNET" ]; then

            curl -RLC - https://github.com/STJr/SRB2/releases/download/SRB2_release_2.1.25/SRB2-v2125-Installer.exe -o "$SRB2BLDROOT/assets/SRB2-2.1.exe"

        fi

        7z x -y "$SRB2BLDROOT/assets/SRB2-2.1.exe" "*.srb" "*.dta" "*.dat" -o"$BUILD/assets/installer"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.0" ]; then

        if [ -n "$ISNET" ]; then

            curl -RLC - https://archive.org/download/srb20ya-v20/SRB2_v206.exe -o "$SRB2BLDROOT/assets/SRB2-2.0.exe"

        fi

        7z x -y "$SRB2BLDROOT/assets/SRB2-2.0.exe" "*.plr" "*.dta" "*.wpn" "*.srb" -o"$BUILD/assets/installer"

    elif [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

        if [ -n "$ISNET" ]; then

            curl -RLC - https://archive.org/download/srb20ya-finaldemo/FinalDemo1094-2008.exe -o "$SRB2BLDROOT/assets/SRB2FinalDemo.exe"

        fi

        7z x -y "$SRB2BLDROOT/assets/SRB2FinalDemo.exe" "*.plr" "*.dta" "*.wpn" "*.srb" -o"$BUILD/assets/installer"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-moe-mansion" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]; then

        extractsrb2kartmacosassets

    elif [ "$(dirname $BUILD)" = "$BUILDPATH/srb2-custom" ]; then

        if [ "$(gawk -F'\"' '/SRB2APPLICATION/ {gsub(" ","");print $2}' "$BUILD/src/doomdef.h" 2> /dev/null)" = "SRB2" ]; then

            extractsrb2macosassets

        else

            extractsrb2kartmacosassets

        fi

    fi
}

extractmacoscustomassets() {
    BUILDPREFIX=$($PRINTF "%s\n" "$BUILD" | gawk -F'/' '{print $NF}')

    if [ -z "$ISNET" ] && [ -n "$SRB2BLDASSETPATH" ]; then

        FILETYPE=$(find "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER."* 2> /dev/null | gawk -F'.' '{print $NF}' | head -n1)
        SRB2BLDASSETPATH="$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE"

    elif [ -n "$ISNET" ] && [ -n "$SRB2BLDASSETPATH" ]; then

        if [ -n "$(find "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER."* 2> /dev/null | head -n1)" ] && [ "$(curl -X GET -sLI "$SRB2BLDASSETPATH" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" = "$(stat -f %z "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER."* 2> /dev/null)" ]; then

            FILETYPE=$(find "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER."* 2> /dev/null | gawk -F'.' '{print $NF}' | head -n1)
            SRB2BLDASSETPATH="$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE"

        elif [ -n "$($PRINTF "%s\n" "$SRB2BLDASSETPATH" | gawk '/drive.google.com/ {print}')" ]; then

            SRB2ASSETID=$($PRINTF "%s\n" "$SRB2BLDASSETPATH" | gawk '{gsub("https://drive.google.com/file/d/|/view|?usp=sharing","");print}')
            SRB2BLDASSETPATH="https://drive.google.com/uc?export=download&confirm=t&id=$SRB2ASSETID"
            FILETYPE=$(curl -X GET -sLI "https://drive.google.com/uc?export=download&confirm=t&id=$SRB2ASSETID" | gawk -F'.' '/content-disposition:/ {gsub("\r|\"","");print $NF}')

        elif [ -n "$($PRINTF "%s\n" "$SRB2BLDASSETPATH" | gawk '/mega.nz/ {print}')" ]; then

            # Using megafetch script to obtain data to decrypt asset pack from mega.nz.
            curl -sL https://gist.githubusercontent.com/Bijman/b791993783e2fb80d3e98a3a19b6e6e8/raw/4fb91369313eaa8d67fe911fdcc08797ca432517/megafetch.sh -o "$BUILD/megafetch"
            chmod +x "$BUILD/megafetch"
            MEGANZURL=$("$BUILD/megafetch" "$SRB2BLDASSETPATH" | gawk '/userstorage.mega.co.nz/ {print}')
            MEGANZFILENAME=$("$BUILD/megafetch" "$SRB2BLDASSETPATH" | gawk 'NR==2')
            MEGANZHEX=$("$BUILD/megafetch" "$SRB2BLDASSETPATH" | gawk 'NR==3')
            MEGANZHEXRAW=$("$BUILD/megafetch" "$SRB2BLDASSETPATH" | gawk 'NR==4')
            SRB2BLDASSETPATH="$MEGANZURL"
            FILETYPE=$($PRINTF "%s\n" "$MEGANZFILENAME" | gawk -F'.' '{print $NF}')

        else

            SRB2BLDASSETPATH="$SRB2BLDASSETPATH"
            FILETYPE=$(curl -X GET -sLI "$SRB2BLDASSETPATH" | gawk -F'.' '/content-disposition:/ {gsub("\r|\"","");print $NF}')

        fi

    elif [ -z "$SRB2BLDASSETPATH" ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Assuming the latest SRB2/SRB2Kart release assets for $BUILDNAME."
        extractmacosassets

    fi

    if [ -n "$ISNET" ] && [ -n "$(curl -vI "$SRB2BLDASSETPATH" 2>&1 | gawk '/> Host:/ {gsub("\r","");print $NF}')" ] && [ "$(curl -X GET -sLI "$SRB2BLDASSETPATH" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" != "$(stat -f %z "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE" 2> /dev/null)" ]; then

        rm -f "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE"

        if [ -n "$($PRINTF "%s\n" "$SRB2BLDASSETPATH" | gawk '/drive.google.com/ {print}')" ]; then

            curl -RL "https://drive.google.com/uc?export=download&confirm=t&id=$SRB2ASSETID" -o"$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE"

        elif [ -n "$($PRINTF "%s\n" "$SRB2BLDASSETPATH" | gawk '/mega.co.nz/ {print}')" ]; then

            curl -RL "$MEGANZURL" -o "$BUILD/$MEGANZFILENAME"
            cat "$BUILD/$MEGANZFILENAME" | openssl enc -d -aes-128-ctr -K "$MEGANZHEX" -iv "$MEGANZHEXRAW" > "$BUILD/$MEGANZFILENAME.new"
            mv -f "$BUILD/$MEGANZFILENAME.new" "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE"

        else

            curl -RL "$SRB2BLDASSETPATH" -o "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE"

        fi

    fi

    if [ -n "$(find "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ]; then

        if [ "$FILETYPE" = "rar" ]; then

            unrar x -y "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.rar" -x"*.exe" -x"*.txt" -x"*.dll" "$BUILD/assets/installer"

        else

            7z x -y "$SRB2BLDROOT/assets/$BUILDPREFIX-$GITVER.$FILETYPE" -x!"*.exe" -x!"*.txt" -x!"*.dll" -o"$BUILD/assets/installer"

        fi

        if [ "$(find "$BUILD/assets/installer" -mindepth 1 -maxdepth 1 2> /dev/null | wc -l)" -eq "1" ]; then

            mv -f "$BUILD/assets/installer/"*/* "$BUILD/assets/installer"

        fi

    fi

    if [ -n "$(find "$BUILD/assets/installer/models" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | head -n1)" ]; then

        find "$BUILD/assets/installer/models" -type d -exec chmod 755 {} \;

    elif [ -n "$(find "$BUILD/assets/installer/mdls" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | head -n1)" ]; then

        find "$BUILD/assets/installer/mdls" -type d -exec chmod 755 {} \;

    fi
}

extractsrb2macosassets() {
    SRB2LATESTVER=$(curl -s https://api.github.com/repos/STJr/SRB2/releases | gawk -F':|_' '/tag_name/ {gsub("\"|,| ","");print $NF}' | head -n1)
    SRB2VER=$(gawk -F'\"' '/SRB2VERSION/ {print $2}' "$BUILD/src/version.h" 2> /dev/null)

    if [ "$BUILD" = "$BUILDPATH/srb2-persona" ]; then

        SRB2VER=$(gawk -F'- v|- ' '/v[0-9]/ {print $2}' "$BUILD/src/config.h.in" 2> /dev/null | gawk '{gsub(" ","");print}' | tail -n1)

    fi

    if [ -n "$SRB2LATESTVER" ] && [ "$SRB2VER" != "$SRB2LATESTVER" ]; then

        if [ -n "$ISNET" ]; then

            SRB2ASSETURL=$(curl -s https://api.github.com/repos/STJr/SRB2/releases | gawk -F'"' '/'SRB2_release_$SRB2VER'\/.*Full.zip/ {print $4}')
            if [ "$(curl -X GET -sLI "$SRB2ASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" != "$(stat -f %z "$SRB2BLDROOT/assets/SRB2-Older.zip" 2> /dev/null)" ]; then

                rm -f "$SRB2BLDROOT/assets/SRB2-Older.zip"
                curl -RL "$SRB2ASSETURL" -o "$SRB2BLDROOT/assets/SRB2-Older.zip"

            fi

        fi

        7z x -y "$SRB2BLDROOT/assets/SRB2-Older.zip" "*.pk3" "*.dta" "*.dat" "models/*" -o"$BUILD/assets/installer"

    else

        if [ -n "$ISNET" ]; then

            SRB2ASSETURL=$(curl -s https://api.github.com/repos/STJr/SRB2/releases/latest | gawk -F'"' '/browser_download_url.*Full.zip/ {print $4}')
            if [ "$(curl -X GET -sLI "$SRB2ASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" != "$(stat -f %z "$SRB2BLDROOT/assets/SRB2-Latest.zip" 2> /dev/null)" ]; then

                rm -f "$SRB2BLDROOT/assets/SRB2-Latest.zip"
                curl -RL "$SRB2ASSETURL" -o "$SRB2BLDROOT/assets/SRB2-Latest.zip"

            fi

        fi

        7z x -y "$SRB2BLDROOT/assets/SRB2-Latest.zip" "*.pk3" "*.dta" "*.dat" "models/*" -o"$BUILD/assets/installer"

    fi

    find "$BUILD/assets/installer/models" -type d -exec chmod 755 {} \;
}

extractsrb2kartmacosassets() {
    SRB2KARTVERS=$(curl -s https://api.github.com/repos/STJr/Kart-Public/releases | gawk -F':|_' '/tag_name/ {gsub("\"|,| ","");print $NF}')
    SRB2KARTLATESTVER=$($PRINTF "%s\n" "$SRB2KARTVERS" | head -n1)
    SRB2KARTVER=$(gawk -F'- [A-z]*[0-9]*' '/v[0-9]/ {print $2}' "$BUILD/src/config.h.in" 2> /dev/null | gawk '{gsub(" ","");print}' | tail -n1)

    if [ -n "$SRB2KARTLATESTVER" ] && [ "$SRB2KARTVER" != "$SRB2KARTLATESTVER" ]; then

        if [ -n "$ISNET" ]; then

            SRB2KARTASSETURL=$(curl -s https://api.github.com/repos/STJr/Kart-Public/releases | gawk -F'"' '/'$SRB2KARTVER'\/.*Installer.exe/ {print $4}')
            if [ "$(curl -X GET -sLI "$SRB2KARTASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" != "$(stat -f %z "$SRB2BLDROOT/assets/SRB2Kart-Older.exe" 2> /dev/null)" ]; then

                rm -f "$SRB2BLDROOT/assets/SRB2Kart-Older.exe"
                curl -RL "$SRB2KARTASSETURL" -o "$SRB2BLDROOT/assets/SRB2Kart-Older.exe"

            fi

        fi

        unrar x -y "$SRB2BLDROOT/assets/SRB2Kart-Older.exe" "*.kart" "*.srb" "*.dat" "mdls/*" "$BUILD/assets/installer"

    else

        if [ -n "$ISNET" ]; then

            SRB2KARTASSETURL=$(curl -s https://api.github.com/repos/STJr/Kart-Public/releases/latest | gawk -F'"' '/browser_download_url.*Installer.exe/ {print $4}')
            if [ "$(curl -X GET -sLI "$SRB2KARTASSETURL" | gawk -F'Content-Length: ' '{IGNORECASE=1} /Content-Length/ {gsub("\r","");print $NF}' | tail -n1)" != "$(stat -f %z "$SRB2BLDROOT/assets/SRB2Kart-Latest.exe" 2> /dev/null)" ]; then

                rm -f "$SRB2BLDROOT/assets/SRB2Kart-Latest.exe"
                curl -RL "$SRB2KARTASSETURL" -o "$SRB2BLDROOT/assets/SRB2Kart-Latest.exe"

            fi

        fi

        unrar x -y "$SRB2BLDROOT/assets/SRB2Kart-Latest.exe" "*.kart" "*.srb" "*.dat" "mdls/*" "$BUILD/assets/installer"

    fi

    find "$BUILD/assets/installer/mdls" -type d -exec chmod 755 {} \;
}

installdepsglibc() {
    # Creating cache to find packages matching missing library.
    if [ -n "$ISNET" ] && [ -n "$(ldd $SRB2BINARYLNXPATH 2>&1 | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | head -n1)" ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Refreshing package database for $BUILDNAME to find packages matching missing library. Please wait..."

        if [ -x "$(which emerge 2> /dev/null)" ]; then

            if [ ! -x "$(which e-file 2> /dev/null)" ]; then

                $SUDO emerge pfl

            fi

        elif [ -x "$(which pacman 2> /dev/null)" ]; then

            $SUDO pacman -Fy

        elif [ -x "$(which apt-get 2> /dev/null)" ]; then

            if [ ! -x "$(which apt-file 2> /dev/null)" ]; then

                $SUDO apt-get install -y apt-file

            fi

            $SUDO apt-file update

        elif [ -x "$(which xbps-install 2> /dev/null)" ]; then

            if [ ! -x "$(which xlocate 2> /dev/null)" ]; then

                $SUDO xbps-install -Sy xtools

            fi

            xlocate -S

        elif [ -x "$(which rpm-ostree 2> /dev/null)" ]; then

            if [ -z "$(toolbox list --images | gawk '/fedora/ {print}' | head -n1)" ]; then

                yes | toolbox create

            fi

        elif [ -x "$(which nix 2> /dev/null)" ]; then

            #            VERSION_ID=$(gawk -F'"' '/VERSION_ID/ {print $2}' /etc/os-release)

            if [ ! -x "$(which nix-index 2> /dev/null)" ]; then

                $SUDO nix-env -iA nixos.nix-index
                #                $SUDO nix profile remove '.*nix-index' --extra-experimental-features 'nix-command flakes' 2> /dev/null && $SUDO nix profile install "nixpkgs/release-$VERSION_ID#nix-index" --extra-experimental-features 'nix-command flakes'

            fi

            if [ ! -f "$HOME/.cache/nix-index/files" ] && [ ! -f "$XDG_CACHE_HOME/nix-index/files" ]; then

                nix-index

            fi

        fi

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing missing dependencies for $BUILDNAME to the system. Please wait..."
        PACKAGE=$(for l in $(ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {gsub(".so.*|-[0-9]\\.[0-9].so.*|[0-9]\\.[0-9].so.*",".so");print $1}' | sort -u); do

            if [ -x "$(which emerge 2> /dev/null)" ]; then

                e-file "/usr/lib/$l" | col | gawk '/\*/ && gsub(/29m|0m/,"") {print $NF}'

            elif [ -x "$(which pacman 2> /dev/null)" ]; then

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    pacman -Fqx "$l" | gawk '{print}'

                else

                    pacman -Fqx "$l" | gawk '!/lib32-/ {print}'

                fi

            elif [ -x "$(which apt-get 2> /dev/null)" ]; then

                apt-file -l find "$l" | gawk 'NF{print}'

            elif [ -x "$(which zypper 2> /dev/null)" ]; then

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    zypper -q search --provides "$l" | gawk -F'|' '!/Name/ && /32bit/ {print $2}' | gawk 'NF{print}'

                else

                    zypper -q search --provides "$l" | gawk -F'|' '!/Name|32bit/ {print $2}' | gawk 'NF{print}'

                fi

            elif [ -x "$(which dnf 2> /dev/null)" ]; then

                VERSION_ID=$(gawk -F'"' '/VERSION_ID/ {print $2}' /etc/os-release)

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    dnf provides -q "/usr/lib/$l" | gawk '/.fc'$VERSION_ID'./ {print $1}'

                else

                    dnf provides -q "/usr/lib$IS64/$l" | gawk '/.fc'$VERSION_ID'./ {print $1}'

                fi

            elif [ -x "$(which rpm-ostree 2> /dev/null)" ]; then

                VERSION_ID=$(gawk -F'"' '/VERSION_ID/ {print $2}' /etc/os-release)

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    toolbox run dnf provides -q "/usr/lib/$l" | gawk '/.fc'$VERSION_ID'/ {print $1}' | gawk -F'\\.| ' '{gsub("-[0-9]|:[0-9]","");print $1"."$NF}'

                else

                    toolbox run dnf provides -q "/usr/lib$IS64/$l" | gawk '/.fc'$VERSION_ID'/ {print $1}' | gawk -F'\\.| ' '{gsub("-[0-9]|:[0-9]","");print $1"."$NF}'

                fi

            elif [ -x "$(which xbps-install 2> /dev/null)" ]; then

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    xlocate "$l" | gawk '!/-devel-/ && /-32bit-/ {print $1}' | gawk '!a[$0]++ {print}'

                else

                    xlocate "$l" | gawk '!/-devel-|-32bit-/ {print $1}' | gawk '!a[$0]++ {print}'

                fi

            elif [ -x "$(which nix 2> /dev/null)" ]; then

                nix-locate --top-level --regex "$($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-[0-9]\\.[0-9].so.*|[0-9]\\.[0-9].so.*","");print "/lib/"$0".*.so|/wx/"$0".*.so"}')" 2>&1 | gawk '{if (/\/lib\/libz\.so/) {gsub("^","nixos.");print $1;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*|\/lib\/libz/) {gsub("^","nixos.");print $1;exit}}'
                #                nix-locate --top-level --regex "$($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-[0-9]\\.[0-9].so.*|[0-9]\\.[0-9].so.*","");print "/lib/"$0".*.so|/wx/"$0".*.so"}')" 2>&1 | gawk '{if (/\/lib\/libz\.so/) {gsub("^","nixpkgs/release-'$VERSION_ID'#");print $1;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*|\/lib\/libz/ || /SDL2_mixer/) {gsub("^","nixpkgs/release-'$VERSION_ID'#");print $1;exit}}'

            elif [ -x "$(which brew 2> /dev/null)" ]; then

                curl -s "https://packages.debian.org/search?suite=default&section=all&arch=any&searchon=contents&keywords=$l" | gawk 'NF{print}' | gawk -F'>|</a' '/<td>/ {getline;gsub("-dev$|0$","");print $2}' | head -n1

            fi

        done)

        PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk '!a[$0]++ {print}')

        # Installing missing libraries for glibc based distros.
        if [ -n "$(touch /TESTFILE 2>&1 | gawk 'match($0, /Read-only/) {print substr($0, RSTART, RLENGTH)}' 2> /dev/null | head -n1)" ]; then

            if [ -x "$(which rpm-ostree 2> /dev/null)" ]; then

                rpm-ostree install -A --allow-inactive $PACKAGE || true

            elif [ -x "$(which nix 2> /dev/null)" ]; then

                PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk '!/wxGTK\.out/ {gsub("sdl","SDL");print}' | sort -u)

                #                PACKAGENIXREMOVE=$(for l in $(nix profile list --extra-experimental-features 'nix-command flakes' | gawk -F'#| ' '{print $3}'); do
                #
                #                    $PRINTF "%s\n" "$l"
                #
                #                done)

                #                PACKAGENIXREMOVE=$($PRINTF "%s\n" "$PACKAGENIXREMOVE" | gawk '!/wxGTK\.out|wxGTK[0-9][0-9]]-gtk3\.out/ {gsub("sdl","SDL");print}' | sort -u)
                nix-env -irA $PACKAGE || true
                #                nix profile remove $PACKAGENIXREMOVE --extra-experimental-features 'nix-command flakes' 2> /dev/null && nix profile install $PACKAGE --extra-experimental-features 'nix-command flakes' || true

            elif [ -x "$(which brew 2> /dev/null)" ]; then

                PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk -F'/' '{gsub("libpng12","");print $NF}' | sort -u)
                brew install $PACKAGE || true

            else

                ldd "$SRB2BINARYLNXPATH" | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | sort -u
                $PRINTF "$NOTICE\n%s\n\e[0m" "Script can't detect package manager. Please install manually these above missing libraries."
                exit

            fi

        else

            if [ -x "$(which emerge 2> /dev/null)" ]; then

                $SUDO emerge $PACKAGE || true

            elif [ -x "$(which pacman 2> /dev/null)" ]; then

                $SUDO pacman -S --needed --noconfirm $PACKAGE || true

            elif [ -x "$(which apt-get 2> /dev/null)" ]; then

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    ISARM=$($PRINTF "%s\n" "$ISARM" | gawk -F'/' '{print $1}')
                    PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk '!/nvidia|primus|virtualbox/ {gsub("$","':$ISARM'");print}')

                fi

                $SUDO apt-get install -y $PACKAGE || true

            elif [ -x "$(which zypper 2> /dev/null)" ]; then

                $SUDO zypper install -y $PACKAGE || true

            elif [ -x "$(which dnf 2> /dev/null)" ]; then

                $SUDO dnf install --best --skip-broken -y $PACKAGE || true

            elif [ -x "$(which xbps-install 2> /dev/null)" ]; then

                $SUDO xbps-install -Sy $PACKAGE || true

            elif [ -x "$(which nix 2> /dev/null)" ]; then

                PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk '!/wxGTK\.out/ {gsub("sdl","SDL");print}' | sort -u)
                #                PACKAGENIXREMOVE=$(for l in $($SUDO nix profile list --extra-experimental-features 'nix-command flakes' | gawk -F'#| ' '{print $3}'); do

                #                    $PRINTF "%s\n" "$l"

                #                done)
                #                PACKAGENIXREMOVE=$($PRINTF "%s\n" "$PACKAGENIXREMOVE" | gawk '!/wxGTK\.out|wxGTK[0-9][0-9]]-gtk3\.out/ {gsub("sdl","SDL");print}' | sort -u)
                $SUDO nix-env -irA $PACKAGE || true

                #                $SUDO nix profile remove $PACKAGENIXREMOVE --extra-experimental-features 'nix-command flakes' 2> /dev/null && $SUDO nix profile install $PACKAGE --extra-experimental-features 'nix-command flakes' || true

            elif [ -x "$(which brew 2> /dev/null)" ]; then

                PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk -F'/' '{gsub("libpng12","");print $2}' | sort -u)
                brew install $PACKAGE || true

            else

                ldd "$SRB2BINARYLNXPATH" | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | sort -u
                $PRINTF "$NOTICE\n%s\n\e[0m" "Script can't detect package manager. Please install manually these above missing libraries."
                exit

            fi

        fi

    fi
}

installdepsmusl() {
    # Creating cache to find packages matching missing library.
    if [ -n "$ISNET" ] && [ -n "$(ldd $SRB2BINARYLNXPATH 2>&1 | gawk -F':| ' '/No such file or directory/ && !/symbol not found/ {print $5}' | sort -u)" ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing missing dependencies for $BUILDNAME to the system. Please wait..."

        if [ -x "$(which apk 2> /dev/null)" ]; then

            if [ ! -x "$(which apk-file 2> /dev/null)" ]; then

                $SUDO apk add apk-file

            fi

        elif [ -x "$(which xbps-install 2> /dev/null)" ]; then

            if [ ! -x "$(which xlocate 2> /dev/null)" ]; then

                $SUDO xbps-install -Sy xtools

            fi

            xlocate -S

        fi

        PACKAGE=$(for l in $(ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk -F':| ' '/No such file or directory/ && !/symbol not found/ {print $5}' | sort -u); do

            if [ -x "$(which apk 2> /dev/null)" ]; then

                apk-file "$l" | gawk '!/PACKAGE/ {print $2}' | sort -u

            elif [ -x "$(which xbps-install 2> /dev/null)" ]; then

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    xlocate "$l" | gawk '!/-devel-|primus/ && /-32bit-/ {print $1}' | gawk '!a[$0]++ {print}'

                else

                    xlocate "$l" | gawk '!/-devel-|-32bit-|primus/ {print $1}' | gawk '!a[$0]++ {print}'

                fi

            fi

        done)

        PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk '!a[$0]++ {print}')

        # Installing missing libraries for musl based distros.
        if [ -n "$(touch /TESTFILE 2>&1 | gawk 'match($0, /Read-only/) {print substr($0, RSTART, RLENGTH)}' 2> /dev/null | head -n1)" ]; then

            if [ -x "$(which nix 2> /dev/null)" ]; then

                #            VERSION_ID=$(gawk -F'"' '/VERSION_ID/ {print $2}' /etc/os-release)

                #                PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk '!/nixos\.wxGTK\.out/ {gsub("nixos.|[a-z]*/","") && gsub("^| "," nixpkgs.") && gsub("sdl","SDL");print}' | sort -u)
                nix-env -irA $PACKAGE || true
                #                nix profile remove '.*nix-index' --extra-experimental-features 'nix-command flakes' 2> /dev/null && nix profile install "nixpkgs/release-$VERSION_ID#nix-index" --extra-experimental-features 'nix-command flakes'

            elif [ -x "$(which brew 2> /dev/null)" ]; then

                PACKAGE=$($PRINTF "%s\n" "$PACKAGE" | gawk -F'/' '{gsub("libpng12","");print $NF}' | sort -u)
                brew install $PACKAGE || true

            else

                ldd "$SRB2BINARYLNXPATH" | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | sort -u
                $PRINTF "$NOTICE\n%s\n\e[0m" "Script can't detect package manager. Please install manually these above missing libraries."
                exit

            fi

        else

            if [ -x "$(which apk 2> /dev/null)" ]; then

                $SUDO apk add --force-broken-world $PACKAGE 2> /dev/null

            elif [ -x "$(which xbps-install 2> /dev/null)" ]; then

                $SUDO xbps-install -Sy $PACKAGE 2> /dev/null

            else

                ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk -F':' '/No such file or directory/ && !/symbol not found/ {print $1}' | gawk '{print $NF}' | sort -u $PRINTF "$NOTICE\n%s\n\e[0m" "Script can't detect package manager. Please install manually these above missing libraries."
                exit

            fi

        fi

    fi
}

installtolinux() {
    # Saving configuration flags to variable.
    if [ -n "$(cat "$BUILD/conf")" ]; then

        CONF=$(cat "$BUILD/conf")

    fi

    # Adding path to commit revision file.
    COMREVFILEPATH="$BUILD/.comrev"

    # Making missing directory path.
    if [ "$SRB2BLDPREFIX" = "/usr/local" ] || [ ! -d "/usr/local/bin" ] && [ ! -d "/usr/local/share/applications" ] && [ ! -d "/usr/local/share/icons/hicolor/64x64/apps" ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Creating /usr/local/bin, /usr/local/share/applications, /usr/local/share/icons/hicolor/64x64/apps and /usr/local/share/games directory paths. Please wait..."
        $SUDO install -d "/usr/local/bin"
        $SUDO install -d "/usr/local/share/applications"
        $SUDO install -d "/usr/local/share/icons/hicolor/64x64/apps"
        $SUDO install -d "/usr/local/share/games"

    else

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Creating $SRB2BLDPREFIX/bin, $SRB2BLDPREFIX/share/applications, $SRB2BLDPREFIX/share/icons/hicolor/64x64/apps and $SRB2BLDPREFIX/share/games directory paths. Please wait..."
        install -d "$SRB2BLDPREFIX/bin"
        install -d "$SRB2BLDPREFIX/share/applications"
        install -d "$SRB2BLDPREFIX/share/icons/hicolor/64x64/apps"
        install -d "$SRB2BLDPREFIX/share/games"

    fi

    removeduplicate

    # Patching linked libraries against libSDL2_mixerX.
    SRB2BINARYLNXPATH="/usr/local/lib/libSDL2_mixer_ext.so"

    installdepsglibc

    ldd /usr/local/lib/libSDL2_mixer_ext.so 2>&1 | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | sort -u | while read -r l; do

        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib64|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') /usr/local/lib/libSDL2_mixer_ext.so 2> /dev/null || true

    done

    # Installing build.
    if [ "$BUILD" = "$BUILDPATH/srb2" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2 binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-uncapped-plus" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2UncappedPlus"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2ucp"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2uncappedplus-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2uncappedplus-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2uncappedplus.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2ucp binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-netplus" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2NetPlus"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2np"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2netplus-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2netplus-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2netplus.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2np binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-rphys" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2rphys"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2rphys"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2rphys-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2rphys-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2rphys.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2rphys binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-vr" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2VR"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2vr"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2vr-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2vr-opengl.desktop"
        SRB2DESKTOPOPENVRLNXPATH="$SRB2BLDPREFIX/share/applications/srb2vr-openvr.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2vr.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2vr binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.1-legacy" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2legacy"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2legacy"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2legacy-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2legacy-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2legacy.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2legacy binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.0" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2-2.0"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2_2.0"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2_2.0-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2_2.0-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2_2.0.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2_2.0 binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdlsrb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2FinalDemo"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2fd"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2finaldemo-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2finaldemo-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2finaldemo.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2fd binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-persona" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2Persona"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2p"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2persona-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2persona-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2persona.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2p binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2Kart"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2kart"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2kart-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2kart-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2kart.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2kart binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2kart" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2Kart"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart-moe-mansion" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2KartMoeMansion"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2kartmoe"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2kartmoemansion-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2kartmoemansion-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2kartmoemansion.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2kartmoe binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2kart" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2Kart"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/SRB2KartVR"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/srb2kartvr"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/srb2kartvr-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/srb2kartvr-opengl.desktop"
        SRB2DESKTOPOPENVRLNXPATH="$SRB2BLDPREFIX/share/applications/srb2kartvr-openvr.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/srb2kartvr.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's srb2kartvr binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/lsdl2srb2kart" "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf "$BUILD/build/AppDir/usr/games/SRB2Kart"/* "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$(dirname $BUILD)" = "$BUILDPATH/srb2-custom" ]; then

        SRB2CASSETDIR=$(gawk -F'"' '/SRB2APPLICATION/ {gsub(" ","");print $2}' "$BUILD/src/doomdef.h" 2> /dev/null)
        SRB2CCONFDIR=$($PRINTF "%s\n" "$SRB2CASSETDIR" | gawk '{print tolower($0)}')
        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/games/"$SRB2CASSETDIR"C"$CUSTOMDIR""
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/"$SRB2CCONFDIR"c"$CUSTOMDIR""
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/"$SRB2CCONFDIR"c"$CUSTOMDIR"-software.desktop"
        SRB2DESKTOPOPENGLLNXPATH="$SRB2BLDPREFIX/share/applications/"$SRB2CCONFDIR"c"$CUSTOMDIR"-opengl.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"$SRB2CCONFDIR"c"$CUSTOMDIR".png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's "$SRB2CCONFDIR"c"$CUSTOMDIR" binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 $(find "$BUILD/build/AppDir/usr/bin" -mindepth 1 -maxdepth 1 2> /dev/null) "$SRB2BINARYLNXPATH"
        $SUDO install -d "$SRB2ASSETLNXPATH"
        $SUDO cp -rf $(
            $SUDO find "$BUILD/build/AppDir/usr/games" -mindepth 2 -maxdepth 2 -type f -regex ".*\.[a-z]*[0-9]*" 2> /dev/null
            $SUDO find "$BUILD/build/AppDir/usr/games" -mindepth 2 -maxdepth 2 -type d 2> /dev/null
        ) "$SRB2ASSETLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/wadcli"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/wadcli.desktop"
        SRB2LNXICONSIZE=$(find "$BUILD/build/AppDir/usr/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/wadcli.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's wadcli binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm755 "$BUILD/build/AppDir/usr/bin/wadcli" "$SRB2BINARYLNXPATH"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/icons/hicolor/$SRB2LNXICONSIZE/apps/"* -t "$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps"

    elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

        SRB2ASSETLNXPATH="$SRB2BLDPREFIX/share/slade3"
        SRB2BINARYLNXPATH="$SRB2BLDPREFIX/bin/slade"
        SRB2DESKTOPLNXPATH="$SRB2BLDPREFIX/share/applications/slade.desktop"
        SRB2LNXICONSIZE=$(find "$SRB2BLDPREFIX/share/icons/hicolor/"*/apps -mindepth 1 -maxdepth 1 2> /dev/null | gawk -F'hicolor/|/apps' '{print $2}' | gawk '!a[$0]++ {print}')
        SRB2ICONLNXPATH="$SRB2BLDPREFIX/share/icons/hicolor/$SRB2LNXICONSIZE/apps/slade.png"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's slade binary, assets, icons and desktop file to the system. Please wait..."
        $SUDO install -Dm644 "$BUILD/build/AppDir/usr/share/applications/"* -t "$SRB2BLDPREFIX/share/applications"

    fi

    if [ -n "$($PRINTF "%s\n" "$SRB2BLDPREFIX" | gawk 'match($0, /\/home\/'$USER'/) {print substr($0, RSTART, RLENGTH)}')" ]; then

        $SUDO find "$SRB2BLDPREFIX" ! -user 1000 -exec chown -R $(stat -c "%U:%G" "$HOME") {} \;

    fi

    installtolist

    # Refreshing menu icons.
    if [ -x "$(which gtk-update-icon-cache 2> /dev/null)" ]; then

        $SUDO gtk-update-icon-cache -qft "$SRB2BLDPREFIX/share/icons/hicolor"

    elif [ -x "$(find /usr/bin -name "kbuildsycoca*" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ]; then

        $SUDO "$(find /usr/bin -name "kbuildsycoca*" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" --noincremental

    fi

    installdepsglibc

    # Installing tool for detection of missing libraries.
    if [ -n "$(ldd $SRB2BINARYLNXPATH 2>&1 | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | head -n1)" ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Patching paths to dependencies for $BUILDNAME. Please wait..."

        # Setting path to interpreter.
        $SUDO patchelf --set-interpreter $(ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk '/ld-linux.*/ {print $3}') "$SRB2BINARYLNXPATH" || true

        # Patching compiled binary, in order to libraries be found.
        while true; do

            ldd "$SRB2BINARYLNXPATH" | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | sort -u | while read -r l; do

                VERSION=$($PRINTF "%s\n" "$l" | gawk 'match($0, /-[0-9]\.[0-9]|[0-9]\.[0-9]/) {gsub(".so.*|-","");print substr($0, RSTART)}')

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                else

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib64|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/ || /SDL2_mixer/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib64|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/ || /SDL2_mixer/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                fi

            done

            # Additional patching, if still there are missing paths to libraries to be added to binary.
            ldd "$SRB2BINARYLNXPATH" | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | sort -u | while read -r l; do

                VERSION=$($PRINTF "%s\n" "$l" | gawk 'match($0, /-[0-9]\.[0-9]|[0-9]\.[0-9]/) {gsub(".so.*|-","");print substr($0, RSTART)}')

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\//) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\//) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                else

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib|^\/usr\/lib64/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib|^\/usr\/lib64/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                fi

            done

            installdepsglibc

            if [ -z "$(ldd "$SRB2BINARYLNXPATH" | gawk '/not found/ && !/GLIBC/ && !/symbol not found/ && !/\/usr\/local\/bin/ {print $1}' | head -n1)" ]; then

                break

            fi

        done

        $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Installation of $BUILDNAME's dependencies is successful."

    fi

    installdepsmusl

    if [ -n "$(ldd $SRB2BINARYLNXPATH 2>&1 | gawk -F':| ' '/No such file or directory/ && !/symbol not found/ {print $5}' | sort -u)" ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Patching paths to dependencies for $BUILDNAME. Please wait..."

        # Setting path to interpreter.
        $SUDO patchelf --set-interpreter $(ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk '/ld-musl.*/ {print $3}') "$SRB2BINARYLNXPATH" || true

        # Patching compiled binary, in order to libraries be found.
        while true; do

            ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk -F':| ' '/No such file or directory/ && !/symbol not found/ {print $5}' | sort -u | while read -r l; do

                VERSION=$($PRINTF "%s\n" "$l" | gawk 'match($0, /-[0-9]\.[0-9]|[0-9]\.[0-9]/) {gsub(".so.*|-","");print substr($0, RSTART)}')

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                else

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib64|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --replace-needed "$l" $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\/|^\/usr\/lib64|^\/usr\/lib32/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                fi

            done

            # Additional patching, if still there are missing paths to libraries to be added to binary.
            ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk -F':| ' '/No such file or directory/ && !/symbol not found/ {print $5}' | sort -u | while read -r l; do

                VERSION=$($PRINTF "%s\n" "$l" | gawk 'match($0, /-[0-9]\.[0-9]|[0-9]\.[0-9]/) {gsub(".so.*|-","");print substr($0, RSTART)}')

                if [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\//) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib\//) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                else

                    if [ -n "$VERSION" ] && [ ! -x "$(which brew 2> /dev/null)" ]; then

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*|-'$VERSION'.*so.*|'$VERSION'.*so.*","");print $0"*'$VERSION'*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib|^\/usr\/lib64/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    else

                        $SUDO patchelf --add-needed $(find $SRB2BLDPREFIX/lib/ $HOME/.nix-portable/store /home/linuxbrew/.linuxbrew/lib /nix/store /usr/lib64 /usr/lib -name $($PRINTF "%s\n" "$l" | gawk '{gsub(".so.*","");print $0"*so*"}' | head -n1) 2> /dev/null | gawk '{if (/^\/home\/'$USER'\/.nix-portable\/store|^\/home\/linuxbrew\/.linuxbrew\/lib|^\/home\/'$USER'\/.local\/lib\/|^\/usr\/local\/lib|^\/usr\/lib|^\/usr\/lib64/) {print;exit} else if (/[0-9]\.[0-9]\/lib|[0-9]\.[0-9][0-9]\/lib|[0-9]\.[0-9]\/wx|[0-9]\.[0-9][0-9]\/wx|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/lib|[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\/wx|\/lib\/libz.so/ && !/libstdc\+\+[0-9]|lzfse|SDL2_.*/) {print;exit}}') "$SRB2BINARYLNXPATH" 2> /dev/null || true

                    fi

                fi

            done

            installdepsmusl

            if [ -z "$(ldd "$SRB2BINARYLNXPATH" 2>&1 | gawk -F':| ' '/No such file or directory/ && !/symbol not found/ {print $5}' | sort -u)" ]; then

                break

            fi

        done

        $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Installation of $BUILDNAME's dependencies is successful."

    fi
}

installtolist() {
    # Making list of installed files.
    mkdir -p "$SRB2BLDROOT/installed"
    cat > "$SRB2BLDROOT/installed/$($PRINTF "%s\n" "$BUILD" | gawk -F'/' '{print $NF}')" << INSTALL
$SRB2ASSETLNXPATH
$SRB2BINARYLNXPATH
$SRB2DESKTOPLNXPATH
$SRB2DESKTOPOPENGLLNXPATH
$SRB2DESKTOPOPENVRLNXPATH
$SRB2ICONLNXPATH
$SRB2WINPATH
$SRB2WINMENUPATH
$SRB2MACPATH
$SRB2MACLINK
$COMREVFILEPATH
---------------
$CONF
INSTALL

    gawk -i inplace 'NF{print}' "$SRB2BLDROOT/installed/$($PRINTF "%s\n" "$BUILD" | gawk -F'/' '{print $NF}')"

    COMREV=$(git -C "$BUILD" rev-parse --short HEAD)
    $PRINTF "$COMREV\n$GITVERCONF" > "$BUILD/.comrev"

    if [ -n "$SRB2BINARYLNXPATH" ]; then

        SRB2PATH="$SRB2BINARYLNXPATH"

    elif [ -n "$SRB2MACPATH" ]; then

        SRB2PATH="$SRB2MACPATH and $SRB2MACLINK"

    elif [ -n "$SRB2WINPATH" ]; then

        SRB2PATH="$SRB2WINPATH"

    fi

    $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Installation of $BUILDNAME is successful and is located at $SRB2PATH path."
}

installtomacos() {
    # Exporting environment variables for compiling, installing game and libraries on macOS.
    export MACOSX_DEPLOYMENT_TARGET="$MACOSVER"
    export SDKROOT="$SDKROOT"
    export PATH="$MACPORTPREFIX/bin:$HOMEBREWPREFIX/bin:$PATH"
    export LIBRARY_PATH="$SRB2BLDPREFIX/lib:$MACPORTPREFIX/lib:$HOMEBREWPREFIX/lib:$LIBRARY_PATH"
    export C_INCLUDE_PATH="$SRB2BLDPREFIX/include:$MACPORTPREFIX/include:$HOMEBREWPREFIX/include:$C_INCLUDE_PATH"
    export CPLUS_INCLUDE_PATH="$C_INCLUDE_PATH"
    export PKG_CONFIG_PATH="$SRB2BLDPREFIX/lib/pkgconfig:$MACPORTPREFIX/lib/pkgconfig:$HOMEBREWPREFIX/lib/pkgconfig:$PKG_CONFIG_PATH"
    export STOW_DIR="$SRB2BLDPREFIX/stow"

    # Have commit revision as part of name for App Bundle.
    COMREV=$(git -C "$BUILD" rev-parse --short HEAD)

    # Change prefix depending on, if library is in $HOMEBREWPREFIX/lib or $MACPORTPREFIX/lib or $SRB2BLDPREFIX/lib.
    if [ -f "$HOMEBREWPREFIX/lib/libSDL2.dylib" ]; then

        LIBSDL2PREFIX="$HOMEBREWPREFIX"

    elif [ -f "$MACPORTPREFIX/lib/libSDL2.dylib" ]; then

        LIBSDL2PREFIX="$MACPORTPREFIX"

    else

        LIBSDL2PREFIX="$SRB2BLDPREFIX"

    fi

    if [ -f "$HOMEBREWPREFIX/lib/libSDL2_mixer.dylib" ]; then

        LIBSDL2MIXERPREFIX="$HOMEBREWPREFIX"

    elif [ -f "$MACPORTPREFIX/lib/libSDL2_mixer.dylib" ]; then

        LIBSDL2MIXERPREFIX="$MACPORTPREFIX"

    else

        LIBSDL2MIXERPREFIX="$SRB2BLDPREFIX"

    fi

    if [ -f "$HOMEBREWPREFIX/lib/libgme.dylib" ]; then

        LIBGMEPREFIX="$HOMEBREWPREFIX"

    elif [ -f "$MACPORTPREFIX/lib/libgme.dylib" ]; then

        LIBGMEPREFIX="$MACPORTPREFIX"

    else

        LIBGMEPREFIX="$SRB2BLDPREFIX"

    fi

    if [ -f "$HOMEBREWPREFIX/lib/libopenmpt.dylib" ]; then

        LIBOPENMPTPREFIX="$HOMEBREWPREFIX"

    elif [ -f "$MACPORTPREFIX/lib/libopenmpt.dylib" ]; then

        LIBOPENMPTPREFIX="$MACPORTPREFIX"

    else

        LIBOPENMPTPREFIX="$SRB2BLDPREFIX"

    fi

    if [ -f "$HOMEBREWPREFIX/lib/libpng.dylib" ]; then

        LIBPNGPREFIX="$HOMEBREWPREFIX"

    elif [ -f "$MACPORTPREFIX/lib/libpng.dylib" ]; then

        LIBPNGPREFIX="$MACPORTPREFIX"

    else

        LIBPNGPREFIX="$SRB2BLDPREFIX"

    fi

    if [ -f "$HOMEBREWPREFIX/lib/libmpg123.dylib" ]; then

        LIBMPG123PREFIX="$HOMEBREWPREFIX"

    elif [ -f "$MACPORTPREFIX/lib/libmpg123.dylib" ]; then

        LIBMPG123PREFIX="$MACPORTPREFIX"

    else

        LIBMPG123PREFIX="$SRB2BLDPREFIX"

    fi

    # Upgrade build. Making sure, that there are only used compilation flags.
    if [ -n "$UPGRADE" ] && [ -z "$CUSTOMDIR" ]; then

        export CONF="$(gawk '/---------------/ {gsub("---------------","");getline;print}' "$SRB2BLDROOT/installed/$UPGRADE")"

    elif [ -n "$UPGRADE" ] && [ -n "$CUSTOMDIR" ]; then

        export CONF="$(gawk '/---------------/ {gsub("---------------","");getline;print}' "$SRB2BLDROOT/installed/$CUSTOMDIR")"

    # Otherwise set compilation flags, build and install as usual.
    else

        # Warning for MacOS users.
        $PRINTF "$NOTICE\n%s\n\e[0m" "WARNING for macOS users! This script makes changes from rpath to absolute paths within some libraries installed from Homebrew, MacPorts or compiled (mostly should affects libraries compiled by user), that are associated with SRB2 binary, so installing or making App Bundles would be successful. In the future this could make unexpected results with apps or SRB2 builds, that depend on those libraries. Possible changes that would be applied. Save those below commands to text file and revert those changes after process:

        sudo ln -sf /Library/Developer/CommandLineTools/usr/lib/clang/*/lib/darwin/libclang_rt.ubsan_osx_dynamic.dylib $SRB2BLDPREFIX/lib/libclang_rt.ubsan_osx_dynamic.dylib
        sudo install_name_tool -change "@rpath/libclang_rt.ubsan_osx_dynamic.dylib" "$SRB2BLDPREFIX/lib/libclang_rt.ubsan_osx_dynamic.dylib" $SRB2BLDPREFIX/lib/libgme.dylib

        sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$SRB2BLDPREFIX/lib/libbrotlicommon.dylib" $SRB2BLDPREFIX/lib/libbrotlidec.dylib
        sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$SRB2BLDPREFIX/lib/libbrotlicommon.dylib" $SRB2BLDPREFIX/lib/libbrotlienc.dylib

        sudo install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$SRB2BLDPREFIX/lib/libSDL2.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libSDL2-2.0.dylib" "$SRB2BLDPREFIX/lib/libSDL2.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@rpath/libmodplug.dylib" "$SRB2BLDPREFIX/lib/libmodplug.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libmodplug.dylib" "$SRB2BLDPREFIX/lib/libmodplug.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbis.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbisfile.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libopenmpt.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbis.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbisfile.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libopenmpt.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$HOMEBREWPREFIX/lib/libbrotlicommon.dylib" $HOMEBREWPREFIX/lib/libbrotlidec.dylib
        sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$HOMEBREWPREFIX/lib/libbrotlicommon.dylib" $HOMEBREWPREFIX/lib/libbrotlienc.dylib

        sudo install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$HOMEBREWPREFIX/lib/libSDL2.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libSDL2-2.0.dylib" "$HOMEBREWPREFIX/lib/libSDL2.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@rpath/libmodplug.dylib" "$HOMEBREWPREFIX/lib/libmodplug.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libmodplug.dylib" "$HOMEBREWPREFIX/lib/libmodplug.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbis.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbisfile.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libopenmpt.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbis.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbisfile.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libopenmpt.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$MACPORTPREFIX/lib/libbrotlicommon.dylib" $MACPORTPREFIX/lib/libbrotlidec.dylib
        sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$MACPORTPREFIX/lib/libbrotlicommon.dylib" $MACPORTPREFIX/lib/libbrotlienc.dylib

        sudo install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$MACPORTPREFIX/lib/libSDL2.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libSDL2-2.0.dylib" "$MACPORTPREFIX/lib/libSDL2.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@rpath/libmodplug.dylib" "$MACPORTPREFIX/lib/libmodplug.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libmodplug.dylib" "$MACPORTPREFIX/lib/libmodplug.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib

        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbis.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbisfile.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libopenmpt.dylib
        sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbis.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbisfile.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libopenmpt.dylib
        sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib

Press y/yes to continue, or n/no or ctrl+c to quit."

        $PRINTF "$PROMPT\n%s\e[0m" "> "
        read -r CONFIRM

        if [ "$CONFIRM" = y ] || [ "$CONFIRM" = Y ] || [ "$CONFIRM" = yes ] || [ "$CONFIRM" = Yes ]; then

            if [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

                cat "$BUILD/README.md"
                $PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter $BUILDNAME's space separated compilation flags and then press enter, or just press enter to begin compiling. Default command and flags for compilation:"
                $PRINTF "$NOTICE%s\n\e[0m" "make -k -j$(($(nproc) + 1)) -C $BUILD [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

                # Display content of CMakeLists for a good view of available compilation flags.
                cmake -LAH -S "$BUILD" -B "$BUILD/build" 2>&1 | gawk '{if(f)print} /-- Cache values/{f=1}' 2> /dev/null
                $PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter $BUILDNAME's space separated compilation flags and then press enter, or just press enter to begin compiling. Default command and flags for compilation:"
                $PRINTF "$NOTICE%s\n\e[0m" "cmake -S $BUILD -B $BUILD/build -DwxWidgets_CONFIG_EXECUTABLE=$(which $MACPORTPREFIX/Library/Frameworks/wxWidgets.framework/Versions/wxWidgets/*/bin/wx-config wx-config wx-config-gtk3 2> /dev/null | head -n1) -DCMAKE_OSX_SYSROOT=$SDKROOT -DCMAKE_OSX_DEPLOYMENT_TARGET=$MACOSVERSLADE -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/opt/srb2-apps [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            else

                # Display content of CMakeLists for a good view of available compilation flags.
                cmake -LAH -S "$BUILD" -B "$BUILD/build" 2>&1 | gawk '{if(f)print} /-- Cache values/{f=1}' 2> /dev/null
                $PRINTF "$MESSAGE\n%s\n\e[0m" "Please enter $BUILDNAME's space separated compilation flags and then press enter, or just press enter to begin compiling. Default command and flags for compilation:"
                $PRINTF "$NOTICE%s\n\e[0m" "cmake -S $BUILD -B $BUILD/build -DCMAKE_OSX_SYSROOT=$SDKROOT -DCMAKE_OSX_DEPLOYMENT_TARGET=$MACOSVER -DCPACK_PACKAGE_DESCRIPTION_SUMMARY=$BUILDNAME -DCPACK_PACKAGE_FILE_NAME=$BUILDNAME-$GITVER-$COMREV -DCMAKE_BUILD_TYPE=Release -DSRB2_CPACK_GENERATOR=DragNDrop -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/opt/srb2-apps -DCMAKE_EXE_LINKER_FLAGS_RELEASE=-headerpad_max_install_names -DCMAKE_MODULE_LINKER_FLAGS_RELEASE=-headerpad_max_install_names -DCMAKE_SHARED_LINKER_FLAGS_RELEASE=-headerpad_max_install_names -DSDL2_INCLUDE_DIR=$LIBSDL2PREFIX/include/SDL2 -DSDL2_LIBRARY=$LIBSDL2PREFIX/lib/libSDL2.dylib -DSDL2_MIXER_INCLUDE_DIR=$LIBSDL2MIXERPREFIX/include/SDL2 -DSDL2_MIXER_LIBRARY=$LIBSDL2MIXERPREFIX/lib/libSDL2_mixer.dylib -DGME_INCLUDE_DIR=$LIBGMEPREFIX/include/gme -DGME_LIBRARY=$LIBGMEPREFIX/lib/libgme.dylib -DOPENMPT_INCLUDE_DIR=$LIBOPENMPTPREFIX/include/libopenmpt -DOPENMPT_LIBRARY=$LIBOPENMPTPREFIX/lib/libopenmpt.dylib -DPNG_PNG_INCLUDE_DIR=$LIBPNGPREFIX/include -DPNG_LIBRARY=$LIBPNGPREFIX/lib/libpng.dylib -DCMAKE_SKIP_RPATH=ON -DCMAKE_SKIP_INSTALL_RPATH=ON [YOUR-COMPILATION-FLAGS-WILL-BE-HERE]"

            fi

            # Add compilation flags.
            $PRINTF "$PROMPT\n%s\e[0m" "> "
            read -r CONF

        else

            $PRINTF "$NOTICE\n%s\n\e[0m" "Exiting."
            exit

        fi

        # Some checks, if the build's certain compilation flags were entered.
        if [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_PNG=OFF/) {print substr($0, RSTART, RLENGTH)}')" ] || [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_PNG:BOOL=OFF/) {print substr($0, RSTART, RLENGTH)}')" ]; then

            ISPNG=

        else

            ISPNG=libpng

        fi

        if [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_GME=OFF/) {print substr($0, RSTART, RLENGTH)}')" ] || [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_GME:BOOL=OFF/) {print substr($0, RSTART, RLENGTH)}')" ]; then

            ISGME=

        else

            ISGME=libgme

        fi

        if [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_OPENMPT=OFF/) {print substr($0, RSTART, RLENGTH)}')" ] || [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_OPENMPT:BOOL=OFF/) {print substr($0, RSTART, RLENGTH)}')" ]; then

            ISOPENMPT=

        else

            ISOPENMPT=libopenmpt

        fi

        if [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_SDL2_USEMIXER=OFF/) {print substr($0, RSTART, RLENGTH)}')" ] || [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_SDL2_USEMIXER:BOOL=OFF/) {print substr($0, RSTART, RLENGTH)}')" ]; then

            ISSDL2MIXER=

        else

            ISSDL2MIXER=libsdl2_mixer

        fi

        if [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_MIXERX=ON/) {print substr($0, RSTART, RLENGTH)}')" ] || [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_MIXERX:BOOL=ON/) {print substr($0, RSTART, RLENGTH)}')" ]; then

            ISSDL2MIXERX=libsdl2_mixerx

        else

            ISSDL2MIXERX=

        fi

        if [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_DISCORDRPC=ON/) {print substr($0, RSTART, RLENGTH)}')" ] || [ -n "$($PRINTF "%s\n" "$CONF" | gawk 'match($0, /SRB2_CONFIG_HAVE_DISCORDRPC:BOOL=ON/) {print substr($0, RSTART, RLENGTH)}')" ]; then

            ISDISCORDRPC=libdiscord-rpc

        else

            ISDISCORDRPC=

        fi

    fi

    # Download and extract assets.
    if [ -z "$(find "$BUILD/build/assets/installer/"* -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ] && ([ "$BUILD" != "$BUILDPATH/wadcli" ] && [ "$BUILD" != "$BUILDPATH/slade" ]); then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading and extracting $BUILDNAME's assets. Please wait..."

        if [ "$GITVER" != "$GITDEFVER" ] || [ "$(dirname $BUILD)" = "$BUILDPATH/srb2-custom" ]; then

            extractmacoscustomassets

        else

            extractmacosassets

        fi

    fi

    $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing missing dependencies. Please wait..."
    sudo_ping

    # Fixing permission conflicts between compiled libraries and installed from package manager.
    if [ "$(stat -f %u $SRB2BLDPREFIX/stow 2> /dev/null)" = "0" ]; then

        sudo chown -R "$USER" $SRB2BLDPREFIX/stow

    fi

    if [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

        if [ "$(which port 2> /dev/null)" ]; then

            sudo port -Nfcb install libfmt

        else

            brew install -f fmt

        fi

    elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

        if [ -n "$(which port 2> /dev/null)" ]; then

            sudo port -Nfcb install ftgl glew fluidsynth gtk3 freeimage sfml libmodplug $(port -q search wxwidgets-[0-9] | tail -n1) lua

        else

            brew install -f ftgl glew fluidsynth gtk+ freeimage sfml libmodplug wxwidgets lua

        fi

    else

        # Download libpng's source code, build and install it.
        if [ "$ISPNG" = "libpng" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libpng/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libpng's source code. Please wait..."
                git clone git://git.code.sf.net/p/libpng/code.git --recursive --branch "v$MACOSPNGVER" "$SRB2BLDROOT/libraries/libpng"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libpng's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libpng" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libpng" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libpng" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libpng" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libpng" checkout -q "v$MACOSPNGVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libpng.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libpng.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libpng.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libpng/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libpng" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libpng/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libpng. Please wait..."
                mkdir -p "$SRB2BLDROOT/libraries/libpng/build"
                cmake -S "$SRB2BLDROOT/libraries/libpng" -B "$SRB2BLDROOT/libraries/libpng/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/libpng -DCMAKE_MACOSX_RPATH=OFF
                cmake --build "$SRB2BLDROOT/libraries/libpng/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
                sudo -E cmake --install "$SRB2BLDROOT/libraries/libpng/build"
                sudo -E stow -v --adopt libpng
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libpng" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libpng/.comrev"

            fi

        fi

        # Download libogg's source code, build and install it.
        if [ "$ISOPENMPT" = "libopenmpt" ] || [ "$ISSDL2MIXER" = "libsdl2_mixer" ] || [ "$ISSDL2MIXERX" = "libsdl2_mixerx" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libogg/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libogg's source code. Please wait..."
                git clone https://gitlab.xiph.org/xiph/ogg.git --recursive --branch "v$MACOSOGGVER" "$SRB2BLDROOT/libraries/libogg"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libogg's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libogg" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libogg" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libogg" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libogg" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libogg" checkout -q "v$MACOSOGGVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libogg.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libogg.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libogg.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libogg/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libogg" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libogg/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libogg. Please wait..."
                mkdir -p "$SRB2BLDROOT/libraries/libogg/build"
                cmake -S "$SRB2BLDROOT/libraries/libogg" -B "$SRB2BLDROOT/libraries/libogg/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=true -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/libogg -DCMAKE_MACOSX_RPATH=OFF
                cmake --build "$SRB2BLDROOT/libraries/libogg/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
                sudo -E cmake --install "$SRB2BLDROOT/libraries/libogg/build"
                sudo -E stow -v --adopt libogg
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libogg" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libogg/.comrev"

            fi

        fi

        # Download libvorbis' source code, build and install it.
        if [ "$ISOPENMPT" = "libopenmpt" ] || [ "$ISSDL2MIXER" = "libsdl2_mixer" ] || [ "$ISSDL2MIXERX" = "libsdl2_mixerx" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libvorbis/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libvorbis' source code. Please wait..."
                git clone https://gitlab.xiph.org/xiph/vorbis.git --recursive --branch "v$MACOSVORBISVER" "$SRB2BLDROOT/libraries/libvorbis"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libvorbis' source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libvorbis" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libvorbis" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libvorbis" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libvorbis" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libvorbis" checkout -q "v$MACOSVORBISVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libvorbis.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libvorbis.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libvorbis.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libvorbis/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libvorbis" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libvorbis/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libvorbis. Please wait..."
                cd "$SRB2BLDROOT/libraries/libvorbis" || exit
                ./autogen.sh
                ./configure --prefix=$SRB2BLDPREFIX/stow/libvorbis
                make -k -j$(($(sysctl -n hw.logicalcpu) + 1))
                sudo -E make install
                sudo -E stow -v --adopt libvorbis
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libvorbis" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libvorbis/.comrev"
                cd "$BUILD" || exit

            fi

        fi

        # Download libmpg123's source code, build and install it.
        if [ "$ISOPENMPT" = "libopenmpt" ] || [ "$ISSDL2MIXER" = "libsdl2_mixer" ] || [ "$ISSDL2MIXERX" = "libsdl2_mixerx" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libmpg123/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libmpg123's source code. Please wait..."
                git clone https://github.com/madebr/mpg123.git --recursive --branch "$MACOSMPG123VER" "$SRB2BLDROOT/libraries/libmpg123"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libmpg123's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libmpg123" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libmpg123" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libmpg123" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libmpg123" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libmpg123" checkout -q "$MACOSMPG123VER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libmpg123.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libmpg123.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libmpg123.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libmpg123/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libmpg123" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libmpg123/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libmpg123. Please wait..."
                cd "$SRB2BLDROOT/libraries/libmpg123" || exit
                autoreconf -iv
                ./configure --prefix=$SRB2BLDPREFIX/stow/libmpg123
                make -k -j$(($(sysctl -n hw.logicalcpu) + 1))
                sudo -E make install
                sudo -E stow -v --adopt libmpg123
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libmpg123" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libmpg123/.comrev"
                cd "$BUILD" || exit

            fi

        fi

        # Download libmodplug's source code, build and install it.
        if [ "$ISOPENMPT" = "libopenmpt" ] || [ "$ISSDL2MIXER" = "libsdl2_mixer" ] || [ "$ISSDL2MIXERX" = "libsdl2_mixerx" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libmodplug/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libmodplug's source code. Please wait..."
                git clone https://github.com/Konstanty/libmodplug.git --recursive --branch "$MACOSMODPLUGVER" "$SRB2BLDROOT/libraries/libmodplug"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libmodplug's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libmodplug" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libmodplug" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libmodplug" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libmodplug" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libmodplug" checkout -q "$MACOSMODPLUGVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libmodplug.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libmodplug.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libmodplug.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libmodplug/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libmodplug" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libmodplug/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libmodplug. Please wait..."
                mkdir -p "$SRB2BLDROOT/libraries/libmodplug/build"
                cmake -S "$SRB2BLDROOT/libraries/libmodplug" -B "$SRB2BLDROOT/libraries/libmodplug/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=true -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/libmodplug -DCMAKE_MACOSX_RPATH=OFF
                cmake --build "$SRB2BLDROOT/libraries/libmodplug/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
                sudo -E cmake --install "$SRB2BLDROOT/libraries/libmodplug/build"
                sudo -E stow -v --adopt libmodplug
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libmodplug" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libmodplug/.comrev"

            fi

        fi

        # Download libSDL2's source code, build and install it.
        if [ ! -d "$SRB2BLDROOT/libraries/libsdl2/.git" ]; then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libSDL2's source code. Please wait..."
            git clone https://github.com/libsdl-org/SDL.git --recursive --branch "release-$MACOSSDL2VER" "$SRB2BLDROOT/libraries/libsdl2"

        else

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libSDL2's source code. Please wait..."
            git -C "$SRB2BLDROOT/libraries/libsdl2" clean -qdffx -e .comrev
            git -C "$SRB2BLDROOT/libraries/libsdl2" reset -q --hard
            git -C "$SRB2BLDROOT/libraries/libsdl2" checkout -q main

            if [ -n "$ISNET" ]; then

                git -C "$SRB2BLDROOT/libraries/libsdl2" pull --recurse-submodules --rebase --autostash

            fi

            git -C "$SRB2BLDROOT/libraries/libsdl2" checkout -q "release-$MACOSSDL2VER"

        fi

        if ([ ! -f "$SRB2BLDPREFIX/lib/libSDL2.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libSDL2.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libSDL2.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libsdl2/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libsdl2" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libsdl2/.comrev" 2> /dev/null)" ]); then

            $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libSDL2. Please wait..."
            mkdir -p "$SRB2BLDROOT/libraries/libsdl2/build"
            cmake -S "$SRB2BLDROOT/libraries/libsdl2" -B "$SRB2BLDROOT/libraries/libsdl2/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DSDL_HIDAPI_JOYSTICK=ON -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/libsdl2 -DCMAKE_MACOSX_RPATH=OFF
            cmake --build "$SRB2BLDROOT/libraries/libsdl2/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
            sudo -E cmake --install "$SRB2BLDROOT/libraries/libsdl2/build"
            sudo -E stow -v --adopt libsdl2
            COMREV=$(git -C "$SRB2BLDROOT/libraries/libsdl2" rev-parse --short HEAD)
            $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libsdl2/.comrev"

        fi

        # Download libopenmpt's source code, build and install it.
        if [ "$ISOPENMPT" = "libopenmpt" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libopenmpt/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libopenmpt's source code. Please wait..."
                git clone https://github.com/OpenMPT/openmpt.git --recursive --branch "libopenmpt-$MACOSOPENMPTVER" "$SRB2BLDROOT/libraries/libopenmpt"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libopenmpt's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libopenmpt" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libopenmpt" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libopenmpt" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libopenmpt" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libopenmpt" checkout -q "libopenmpt-$MACOSOPENMPTVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libopenmpt.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libopenmpt.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libopenmpt.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libopenmpt/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libopenmpt" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libopenmpt/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libopenmpt. Please wait..."
                cd "$SRB2BLDROOT/libraries/libopenmpt" || exit
                gawk -i inplace '{gsub("DYNLINK=1","DYNLINK=0") gsub("SOSUFFIX=.so","SOSUFFIX=.dylib") gsub("STATIC_LIB=1","STATIC_LIB=0") gsub("EXAMPLES=1","EXAMPLES=0") gsub("OPENMPT123=1","OPENMPT123=0") gsub("TEST=1","TEST=0");print}' "$SRB2BLDROOT/libraries/libopenmpt/Makefile"
                make -k -j$(($(sysctl -n hw.logicalcpu) + 1)) NO_PORTAUDIO=1 NO_PORTAUDIOCPP=1 NO_SNDFILE=1 NO_FLAC=1
                sudo -E make PREFIX=$SRB2BLDPREFIX/stow/libopenmpt install
                sudo -E stow -v --adopt libopenmpt
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libopenmpt" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libopenmpt/.comrev"
                cd "$BUILD" || exit

            fi

        fi

        # Download libgme's source code, build and install it.
        if [ "$ISGME" = "libgme" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libgme/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libgme's source code. Please wait..."
                git clone https://bitbucket.org/mpyne/game-music-emu.git --recursive --branch "$MACOSGMEVER" "$SRB2BLDROOT/libraries/libgme"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libgme's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libgme" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libgme" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libgme" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libgme" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libgme" checkout -q "$MACOSGMEVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libgme.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libgme.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libgme.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libgme/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libgme" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libgme/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libgme. Please wait..."
                mkdir -p "$SRB2BLDROOT/libraries/libgme/build"
                cmake -S "$SRB2BLDROOT/libraries/libgme" -B "$SRB2BLDROOT/libraries/libgme/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DGME_YM2612_EMU=MAME -DENABLE_UBSAN=OFF -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/libgme -DCMAKE_MACOSX_RPATH=OFF
                cmake --build "$SRB2BLDROOT/libraries/libgme/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
                sudo -E cmake --install "$SRB2BLDROOT/libraries/libgme/build"
                sudo -E stow -v --adopt libgme
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libgme" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libgme/.comrev"

            fi

        fi

        # Download libSDL2_mixer's source code, build and install it.
        if [ "$ISSDL2MIXER" = "libsdl2_mixer" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libsdl2-mixer/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libSDL2_mixer's source code. Please wait..."
                git clone https://github.com/libsdl-org/SDL_mixer.git --recursive --branch "release-$MACOSSDL2MIXERVER" "$SRB2BLDROOT/libraries/libsdl2-mixer"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libSDL2_mixer's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libsdl2-mixer" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libsdl2-mixer" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libsdl2-mixer" checkout -q main

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libsdl2-mixer" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libsdl2-mixer" checkout -q "release-$MACOSSDL2MIXERVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libSDL2_mixer.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libSDL2_mixer.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libSDL2_mixer.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libsdl2-mixer/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libsdl2-mixer" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libsdl2-mixer/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libSDL2_mixer. Please wait..."
                cd "$SRB2BLDROOT/libraries/libsdl2-mixer" || exit
                ./configure \
                    --disable-dependency-tracking \
                    --disable-music-flac \
                    --disable-music-flac-shared \
                    --enable-music-midi \
                    --disable-music-midi-fluidsynth \
                    --disable-music-midi-fluidsynth-shared \
                    --enable-music-midi-native \
                    --disable-music-midi-timidity \
                    --enable-music-mod \
                    --disable-music-mod-mikmod \
                    --disable-music-mod-mikmod-shared \
                    --enable-music-mod-modplug \
                    --disable-music-mod-modplug-shared \
                    --enable-music-mp3 \
                    --enable-music-mp3-mpg123 \
                    --disable-music-mp3-mpg123-shared \
                    --enable-music-ogg \
                    --disable-music-ogg-shared \
                    --disable-music-opus \
                    --disable-music-opus-shared \
                    --enable-music-wave \
                    --prefix=$SRB2BLDPREFIX/stow/libsdl2-mixer
                make -k -j$(($(sysctl -n hw.logicalcpu) + 1))
                sudo -E make install
                sudo -E stow -v --adopt libsdl2-mixer
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libsdl2-mixer" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libsdl2-mixer/.comrev"
                cd "$BUILD" || exit

            fi

        fi

        # Download libSDL2_mixerX's source code, build and install it.
        if [ "$ISSDL2MIXERX" = "libsdl2_mixerx" ]; then

            if [ ! -d "$SRB2BLDROOT/libraries/libsdl2-mixerx/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libSDL2_mixerX's source code. Please wait..."
                git clone https://github.com/WohlSoft/SDL-Mixer-X.git --recursive --branch "$MACOSSDL2MIXERXVER" "$SRB2BLDROOT/libraries/libsdl2-mixerx"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libSDL2_mixerX's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libsdl2-mixerx" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libsdl2-mixerx" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libsdl2-mixerx" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libsdl2-mixerx" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libsdl2-mixerx" checkout -q "$MACOSSDL2MIXERXVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libSDL2_mixer_ext.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libSDL2_mixer_ext.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libSDL2_mixer_ext.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libsdl2-mixerx/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libsdl2-mixerx" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libsdl2-mixerx/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libSDL2_mixerX. Please wait..."
                mkdir -p "$SRB2BLDROOT/libraries/libsdl2-mixerx/build"
                cmake -S "$SRB2BLDROOT/libraries/libsdl2-mixerx" -B "$SRB2BLDROOT/libraries/libsdl2-mixerx/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DDOWNLOAD_AUDIO_CODECS_DEPENDENCY=ON -DAUDIO_CODECS_BUILD_LOCAL_SDL2=OFF -DUSE_SYSTEM_SDL2=ON -DSDL_MIXER_X_STATIC=OFF -DUSE_GME=ON -DUSE_MIDI=ON -DUSE_MIDI_FLUIDSYNTH=ON -DUSE_MIDI_FLUIDLITE=OFF -DUSE_MIDI_TIMIDITY=ON -DUSE_MIDI_OPNMIDI=OFF -DUSE_MIDI_ADLMIDI=OFF -DUSE_MIDI_EDMIDI=OFF -DUSE_MIDI_NATIVE=OFF -DUSE_SYSTEM_AUDIO_LIBRARIES=ON -DMIXERX_ENABLE_LGPL=ON -DMIXERX_ENABLE_GPL=ON -DUSE_FLAC=OFF -DUSE_MP3_MPG123=OFF -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/libsdl2-mixerx -DCMAKE_MACOSX_RPATH=OFF
                cmake --build "$SRB2BLDROOT/libraries/libsdl2-mixerx/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
                sudo -E cmake --install "$SRB2BLDROOT/libraries/libsdl2-mixerx/build"
                sudo -E stow -v --adopt libsdl2-mixerx
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libsdl2-mixerx" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libsdl2-mixerx/.comrev"

            fi

        fi

        # Download DiscordRPC's source code, build and install it.
        if [ "$ISDISCORDRPC" = "libdiscord-rpc" ] && ([ "$BUILD" = "$BUILDPATH/srb2-uncapped-plus" ] || [ "$BUILD" = "$BUILDPATH/srb2-netplus" ] || [ "$BUILD" = "$BUILDPATH/srb2-rphys" ] || [ "$BUILD" = "$BUILDPATH/srb2-vr" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-moe-mansion" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]); then

            if [ ! -d "$SRB2BLDROOT/libraries/discord-rpc/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading DiscordRPC's source code. Please wait..."
                git clone https://github.com/discord/discord-rpc.git --recursive --branch "$MACOSDISCORDRPCVER" "$SRB2BLDROOT/libraries/discord-rpc"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up DiscordRPC's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/discord-rpc" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/discord-rpc" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/discord-rpc" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/discord-rpc" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/discord-rpc" checkout -q "$MACOSDISCORDRPCVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libdiscord-rpc.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libdiscord-rpc.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libdiscord-rpc.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/discord-rpc/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/discord-rpc" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/discord-rpc/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing DiscordRPC. Please wait..."
                mkdir -p "$SRB2BLDROOT/libraries/discord-rpc/build"
                cmake -S "$SRB2BLDROOT/libraries/discord-rpc" -B "$SRB2BLDROOT/libraries/discord-rpc/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=OFF -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/discord-rpc -DCMAKE_MACOSX_RPATH=OFF
                cmake --build "$SRB2BLDROOT/libraries/discord-rpc/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
                sudo -E cmake --install "$SRB2BLDROOT/libraries/discord-rpc/build"
                sudo -E stow -v --adopt discord-rpc
                COMREV=$(git -C "$SRB2BLDROOT/libraries/discord-rpc" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/discord-rpc/.comrev"

            fi

        fi

        # Download libopenvr's source code, build and install it.
        if ([ "$BUILD" = "$BUILDPATH/srb2-vr" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]); then

            if [ ! -d "$SRB2BLDROOT/libraries/libopenvr/.git" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Downloading libopenvr's source code. Please wait..."
                git clone https://github.com/ValveSoftware/openvr.git --recursive --branch "v$MACOSOPENVRVER" "$SRB2BLDROOT/libraries/libopenvr"

            else

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating and cleaning up libopenvr's source code. Please wait..."
                git -C "$SRB2BLDROOT/libraries/libopenvr" clean -qdffx -e .comrev
                git -C "$SRB2BLDROOT/libraries/libopenvr" reset -q --hard
                git -C "$SRB2BLDROOT/libraries/libopenvr" checkout -q master

                if [ -n "$ISNET" ]; then

                    git -C "$SRB2BLDROOT/libraries/libopenvr" pull --recurse-submodules --rebase --autostash

                fi

                git -C "$SRB2BLDROOT/libraries/libopenvr" checkout -q "v$MACOSOPENVRVER"

            fi

            if ([ ! -f "$SRB2BLDPREFIX/lib/libopenvr_api.dylib" ] && [ ! -f "$HOMEBREWPREFIX/lib/libopenvr_api.dylib" ] && [ ! -f "$MACPORTPREFIX/lib/libopenvr_api.dylib" ]) || ([ -n "$(cat "$SRB2BLDROOT/libraries/libopenvr/.comrev" 2> /dev/null)" ] && [ "$(git -C "$SRB2BLDROOT/libraries/libopenvr" rev-parse --short HEAD)" != "$(cat "$SRB2BLDROOT/libraries/libopenvr/.comrev" 2> /dev/null)" ]); then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Building and installing libopenvr. Please wait..."
                mkdir -p "$SRB2BLDROOT/libraries/libopenvr/build"
                cp -rf "$SRB2BLDROOT/libraries/libopenvr/src/vrcommon" "$SRB2BLDROOT/libraries/libopenvr/src/vrcore"
                cmake -S "$SRB2BLDROOT/libraries/libopenvr" -B "$SRB2BLDROOT/libraries/libopenvr/build" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCMAKE_BUILD_TYPE=Release -DBUILD_UNIVERSAL=OFF -DBUILD_SHARED=ON -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/stow/libopenvr -DCMAKE_MACOSX_RPATH=OFF
                cmake --build "$SRB2BLDROOT/libraries/libopenvr/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release
                sudo -E cmake --install "$SRB2BLDROOT/libraries/libopenvr/build"
                sudo -E stow -v --adopt libopenvr
                COMREV=$(git -C "$SRB2BLDROOT/libraries/libopenvr" rev-parse --short HEAD)
                $PRINTF "%s\n" "$COMREV" > "$SRB2BLDROOT/libraries/libopenvr/.comrev"

            fi

        fi

    fi

    # Fixing permission conflicts between compiled libraries and installed from package manager.
    if [ "$(stat -f %u $SRB2BLDPREFIX/stow 2> /dev/null)" = "0" ]; then

        sudo chown -R "$USER" $SRB2BLDPREFIX/stow

    fi

    if [ "$GITVERCONF" = "$GITDEFVER" ] && [ -z "$SRB2BLDGITVER" ]; then

        unset GITVERCONF

    fi

    # Patching CMakeLists.txt to prevent macOS from loading external frameworks prior to libraries installed by Homebrew.
    if [ "$BUILD" != "$BUILDPATH/srb2-2.0" ] && [ "$BUILD" != "$BUILDPATH/srb2-final-demo" ]; then

        gawk -i inplace '{gsub("add_definitions\\(-DMACOSX\\)","add_definitions(-DMACOSX)\n        set(CMAKE_FIND_FRAMEWORK LAST)");print}' "$BUILD/CMakeLists.txt"

        gawk -i inplace '{gsub("set\\(CMAKE_C_FLAGS \\${CMAKE_C_FLAGS} -Wno-trigraphs\\)","");print}' "$BUILD/src/CMakeLists.txt"

    fi

    # Patching SRB2 Uncapped Plus' source code to fix error with implicit declaration of function R_ResetFirstLerp is invalid in C99 [-Werror,-Wimplicit-function-declaration]. Thanks Lach for help with this.
    if [ "$BUILD" = "$BUILDPATH/srb2-uncapped-plus" ]; then

        gawk -i inplace '{gsub("#include \"doomdef.h\"","#include \"r_fps.h\"\n#include \"doomdef.h\"");print}' "$BUILD/src/p_setup.c"

    # Patching SRB2 Persona's source code to fix error with implicit declaration of function W_GetNumForNameMusic is invalid in C99 [-Werror,-Wimplicit-function-declaration].
    elif [ "$BUILD" = "$BUILDPATH/srb2-persona" ]; then

        gawk -i inplace '/\/\/ W_GetNumForNameMusic/ {suppress=1} /\/\/ Like W_GetNumForName/ {suppress=0} !suppress' "$BUILD/src/w_wad.c"

        gawk -i inplace -v RS="^$" '{gsub("\\/\\/\\/ ------------------------\n\nstatic lumpnum_t S_GetMusicLumpNum\\(const char \\*mname\\)","\nlumpnum_t W_GetNumForNameMusic(const char *name)\n{\n\tlumpnum_t i;\n\n\ti = W_CheckNumForName(name);\n\n\treturn i;\n}\n\nstatic lumpnum_t S_GetMusicLumpNum(const char *mname)");print}' "$BUILD/src/s_sound.c"

    fi

    # Modify the build's configuration and assets directory names to avoid conflicts between installed builds.
    if [ "$BUILD" = "$BUILDPATH/srb2" ] || [ "$BUILD" = "$BUILDPATH/srb2-uncapped-plus" ] || [ "$BUILD" = "$BUILDPATH/srb2-netplus" ] || [ "$BUILD" = "$BUILDPATH/srb2-rphys" ] || [ "$BUILD" = "$BUILDPATH/srb2-vr" ] || [ "$BUILD" = "$BUILDPATH/srb2-persona" ]; then

        gawk -i inplace '{gsub("#define DEFAULTDIR \"srb2\"","#define DEFAULTDIR \"srb2'$GITVERCONF'\"");print}' "$BUILD/src/doomdef.h"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.1-legacy" ]; then

        gawk -i inplace '{gsub("#define DEFAULTDIR \"srb2_21\"","#define DEFAULTDIR \"srb2_2.1\"");print}' "$BUILD/src/doomdef.h"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.0" ]; then

        gawk -i inplace '{gsub("#define DEFAULTDIR \"srb2\"","#define DEFAULTDIR \"srb2_2.0\"");print}' "$BUILD/src/doomdef.h"

    elif [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

        gawk -i inplace '{gsub("#define DEFAULTDIR \"srb21094\"","#define DEFAULTDIR \"srb2fd'$GITVERCONF'\"");print}' "$BUILD/src/doomdef.h"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-moe-mansion" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]; then

        gawk -i inplace '{gsub("#define DEFAULTDIR \"srb2kart\"","#define DEFAULTDIR \"srb2kart'$GITVERCONF'\"");print}' "$BUILD/src/doomdef.h"

    elif [ "$(dirname $BUILD)" = "$BUILDPATH/srb2-custom" ]; then

        gawk -i inplace '{gsub("#define DEFAULTDIR \"srb2\"","#define DEFAULTDIR \"srb2c'$CUSTOMDIR''$GITVERCONF'\"");print}' "$BUILD/src/doomdef.h"
        gawk -i inplace '{gsub("#define DEFAULTDIR \"srb2kart\"","#define DEFAULTDIR \"srb2c'$CUSTOMDIR''$GITVERCONF'\"");print}' "$BUILD/src/doomdef.h"

    fi

    # Compile the build's source code.
    $PRINTF "$MESSAGE\n%s\n\e[0m" "Building $BUILDNAME. Please wait..."
    mkdir -p "$BUILD/build"

    if [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

        make -k -j$(($(nproc) + 1)) -C "$BUILD" $CONF

    elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

        cmake -S "$BUILD" -B "$BUILD/build" -DwxWidgets_CONFIG_EXECUTABLE=$(which $MACPORTPREFIX/Library/Frameworks/wxWidgets.framework/Versions/wxWidgets/*/bin/wx-config wx-config wx-config-gtk3 2> /dev/null | head -n1) -DCMAKE_OSX_SYSROOT="$SDKROOT" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVERSLADE" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/opt/srb2-apps -DMPG123_INCLUDE_DIR="$LIBMPG123PREFIX/include" -DMPG123_LIBRARIES="$LIBMPG123PREFIX/lib/libmpg123.dylib" $CONF
        cmake --build "$BUILD/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release

    else

        cmake -S "$BUILD" -B "$BUILD/build" -DCMAKE_OSX_SYSROOT="$SDKROOT" -DCMAKE_OSX_DEPLOYMENT_TARGET="$MACOSVER" -DCPACK_PACKAGE_DESCRIPTION_SUMMARY="$BUILDNAME" -DCPACK_PACKAGE_FILE_NAME="$BUILDNAME-$GITVER-$COMREV" -DCMAKE_BUILD_TYPE=Release -DSRB2_CPACK_GENERATOR=DragNDrop -DCMAKE_INSTALL_PREFIX=$SRB2BLDPREFIX/opt/srb2-apps -DCMAKE_EXE_LINKER_FLAGS_RELEASE="-headerpad_max_install_names" -DCMAKE_MODULE_LINKER_FLAGS_RELEASE="-headerpad_max_install_names" -DCMAKE_SHARED_LINKER_FLAGS_RELEASE="-headerpad_max_install_names" -DSDL2_INCLUDE_DIR="$LIBSDL2PREFIX/include/SDL2" -DSDL2_LIBRARY="$LIBSDL2PREFIX/lib/libSDL2.dylib" -DSDL2_MIXER_INCLUDE_DIR="$LIBSDL2MIXERPREFIX/include/SDL2" -DSDL2_MIXER_LIBRARY="$LIBSDL2MIXERPREFIX/lib/libSDL2_mixer.dylib" -DGME_INCLUDE_DIR="$LIBGMEPREFIX/include/gme" -DGME_LIBRARY="$LIBGMEPREFIX/lib/libgme.dylib" -DOPENMPT_INCLUDE_DIR="$LIBOPENMPTPREFIX/include/libopenmpt" -DOPENMPT_LIBRARY="$LIBOPENMPTPREFIX/lib/libopenmpt.dylib" -DPNG_PNG_INCLUDE_DIR="$LIBPNGPREFIX/include" -DPNG_LIBRARY="$LIBPNGPREFIX/lib/libpng.dylib" -DCMAKE_SKIP_RPATH=ON -DCMAKE_SKIP_INSTALL_RPATH=ON $CONF
        cmake --build "$BUILD/build" -j$(($(sysctl -n hw.logicalcpu) + 1)) --config Release

    fi

    if [ "$BUILD" != "$BUILDPATH/wadcli" ] && [ "$BUILD" != "$BUILDPATH/slade" ]; then

        # Get app icon.
        mkdir -p "$BUILD/build/bin/$BUILDNAME.app/Contents/Resources"
        makeicns -in "$BUILD/src/win32/Srb2win.ico" -64 -out "$BUILD/build/bin/$BUILDNAME.app/Contents/Resources/Srb2mac.icns" 2> /dev/null
        gawk -i inplace -v RS= '{sub("<key>CFBundleIconFile</key>\n	<string></string>","<key>CFBundleIconFile</key>\n	<string>Srb2mac</string>");print}' "$BUILD/build/bin/$BUILDNAME.app/Contents/Info.plist"

        # Create $SRB2BLDPREFIX/lib, if does not exist.
        if [ ! -d $SRB2BLDPREFIX/lib ]; then

            sudo mkdir -p $SRB2BLDPREFIX/lib

        fi

        # Fix paths of installed libraries.
        if [ -f "$(find /Library/Developer/CommandLineTools/usr/lib/clang -name libclang_rt.ubsan_osx_dynamic.dylib 2> /dev/null | head -n1)" ]; then

            sudo ln -sf /Library/Developer/CommandLineTools/usr/lib/clang/$(clang -v 2>&1 | gawk -F'Apple clang version|\\(| ' '/version/ {print $3}')/lib/darwin/libclang_rt.ubsan_osx_dynamic.dylib $SRB2BLDPREFIX/lib/libclang_rt.ubsan_osx_dynamic.dylib

        fi

        if [ -f $SRB2BLDPREFIX/lib/libbrotlicommon.dylib ]; then

            sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$SRB2BLDPREFIX/lib/libbrotlicommon.dylib" $SRB2BLDPREFIX/lib/libbrotlidec.dylib
            sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$SRB2BLDPREFIX/lib/libbrotlicommon.dylib" $SRB2BLDPREFIX/lib/libbrotlienc.dylib

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libbrotlicommon.dylib" ]; then

            sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$HOMEBREWPREFIX/lib/libbrotlicommon.dylib" $HOMEBREWPREFIX/lib/libbrotlidec.dylib
            sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$HOMEBREWPREFIX/lib/libbrotlicommon.dylib" $HOMEBREWPREFIX/lib/libbrotlienc.dylib

        fi

        if [ -f "$MACPORTPREFIX/lib/libbrotlicommon.dylib" ]; then

            sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$MACPORTPREFIX/lib/libbrotlicommon.dylib" $MACPORTPREFIX/lib/libbrotlidec.dylib
            sudo install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "$MACPORTPREFIX/lib/libbrotlicommon.dylib" $MACPORTPREFIX/lib/libbrotlienc.dylib

        fi

        if [ -f $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib ]; then

            sudo install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$SRB2BLDPREFIX/lib/libSDL2.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libSDL2-2.0.dylib" "$SRB2BLDPREFIX/lib/libSDL2.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "@rpath/libmodplug.dylib" "$SRB2BLDPREFIX/lib/libmodplug.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libmodplug.dylib" "$SRB2BLDPREFIX/lib/libmodplug.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libSDL2_mixer.dylib

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libSDL2_mixer.dylib" ]; then

            sudo install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$HOMEBREWPREFIX/lib/libSDL2.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libSDL2-2.0.dylib" "$HOMEBREWPREFIX/lib/libSDL2.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "@rpath/libmodplug.dylib" "$HOMEBREWPREFIX/lib/libmodplug.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libmodplug.dylib" "$HOMEBREWPREFIX/lib/libmodplug.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libSDL2_mixer.dylib

        fi

        if [ -f "$MACPORTPREFIX/lib/libSDL2_mixer.dylib" ]; then

            sudo install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$MACPORTPREFIX/lib/libSDL2.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libSDL2-2.0.dylib" "$MACPORTPREFIX/lib/libSDL2.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "@rpath/libmodplug.dylib" "$MACPORTPREFIX/lib/libmodplug.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libmodplug.dylib" "$MACPORTPREFIX/lib/libmodplug.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libSDL2_mixer.dylib

        fi

        if [ -f $SRB2BLDPREFIX/lib/libvorbis.dylib ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbis.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbis.dylib

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libvorbis.dylib" ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbis.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbis.dylib

        fi

        if [ -f "$MACPORTPREFIX/lib/libvorbis.dylib" ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbis.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbis.dylib

        fi

        if [ -f $SRB2BLDPREFIX/lib/libvorbisfile.dylib ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbisfile.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libvorbisfile.dylib

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libvorbisfile.dylib" ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbisfile.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libvorbisfile.dylib

        fi

        if [ -f "$MACPORTPREFIX/lib/libvorbisfile.dylib" ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbisfile.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libvorbisfile.dylib

        fi

        if [ -f $SRB2BLDPREFIX/lib/libopenmpt.dylib ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libopenmpt.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$SRB2BLDPREFIX/lib/libogg.dylib" $SRB2BLDPREFIX/lib/libopenmpt.dylib

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libopenmpt.dylib" ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libopenmpt.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$HOMEBREWPREFIX/lib/libogg.dylib" $HOMEBREWPREFIX/lib/libopenmpt.dylib

        fi

        if [ -f "$MACPORTPREFIX/lib/libopenmpt.dylib" ]; then

            sudo install_name_tool -change "@rpath/libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libopenmpt.dylib
            sudo install_name_tool -change "libogg.0.dylib" "$MACPORTPREFIX/lib/libogg.dylib" $MACPORTPREFIX/lib/libopenmpt.dylib

        fi

        if [ -f $SRB2BLDPREFIX/lib/libgme.dylib ]; then

            sudo install_name_tool -change "@rpath/libclang_rt.ubsan_osx_dynamic.dylib" "$SRB2BLDPREFIX/lib/libclang_rt.ubsan_osx_dynamic.dylib" $SRB2BLDPREFIX/lib/libgme.dylib

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libgme.dylib" ]; then

            sudo install_name_tool -change "@rpath/libclang_rt.ubsan_osx_dynamic.dylib" "$SRB2BLDPREFIX/lib/libclang_rt.ubsan_osx_dynamic.dylib" $HOMEBREWPREFIX/lib/libgme.dylib

        fi

        if [ -f "$MACPORTPREFIX/lib/libgme.dylib" ]; then

            sudo install_name_tool -change "@rpath/libclang_rt.ubsan_osx_dynamic.dylib" "$SRB2BLDPREFIX/lib/libclang_rt.ubsan_osx_dynamic.dylib" $MACPORTPREFIX/lib/libgme.dylib

        fi

        # Fix linking of libraries to build's binary.
        if [ -f $SRB2BLDPREFIX/lib/libSDL2.dylib ]; then

            install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$SRB2BLDPREFIX/lib/libSDL2.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libSDL2-2.0.dylib" "$SRB2BLDPREFIX/lib/libSDL2.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libSDL2.dylib" ]; then

            install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$HOMEBREWPREFIX/lib/libSDL2.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libSDL2-2.0.dylib" "$HOMEBREWPREFIX/lib/libSDL2.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$MACPORTPREFIX/lib/libSDL2.dylib" ]; then

            install_name_tool -change "@rpath/libSDL2-2.0.dylib" "$MACPORTPREFIX/lib/libSDL2.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libSDL2-2.0.dylib" "$MACPORTPREFIX/lib/libSDL2.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f $SRB2BLDPREFIX/lib/libmodplug.dylib ]; then

            install_name_tool -change "@rpath/libmodplug.dylib" "$SRB2BLDPREFIX/lib/libmodplug.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libmodplug.dylib" "$SRB2BLDPREFIX/lib/libmodplug.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libmodplug.dylib" ]; then

            install_name_tool -change "@rpath/libmodplug.dylib" "$HOMEBREWPREFIX/lib/libmodplug.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libmodplug.dylib" "$HOMEBREWPREFIX/lib/libmodplug.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$MACPORTPREFIX/lib/libmodplug.dylib" ]; then

            install_name_tool -change "@rpath/libmodplug.dylib" "$MACPORTPREFIX/lib/libmodplug.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libmodplug.dylib" "$MACPORTPREFIX/lib/libmodplug.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f $SRB2BLDPREFIX/lib/libopenmpt.dylib ]; then

            install_name_tool -change "bin/libopenmpt.dylib" "$SRB2BLDPREFIX/lib/libopenmpt.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libopenmpt.dylib" "$SRB2BLDPREFIX/lib/libopenmpt.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libopenmpt.dylib" ]; then

            install_name_tool -change "bin/libopenmpt.dylib" "$HOMEBREWPREFIX/lib/libopenmpt.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libopenmpt.dylib" "$HOMEBREWPREFIX/lib/libopenmpt.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$MACPORTPREFIX/lib/libopenmpt.dylib" ]; then

            install_name_tool -change "bin/libopenmpt.dylib" "$MACPORTPREFIX/lib/libopenmpt.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libopenmpt.dylib" "$MACPORTPREFIX/lib/libopenmpt.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f $SRB2BLDPREFIX/lib/libgme.dylib ]; then

            install_name_tool -change "@rpath/libgme.0.dylib" "$SRB2BLDPREFIX/lib/libgme.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libgme.0.dylib" "$SRB2BLDPREFIX/lib/libgme.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libgme.dylib" ]; then

            install_name_tool -change "@rpath/libgme.0.dylib" "$HOMEBREWPREFIX/lib/libgme.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libgme.0.dylib" "$HOMEBREWPREFIX/lib/libgme.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$MACPORTPREFIX/lib/libgme.dylib" ]; then

            install_name_tool -change "@rpath/libgme.0.dylib" "$MACPORTPREFIX/lib/libgme.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libgme.0.dylib" "$MACPORTPREFIX/lib/libgme.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f $SRB2BLDPREFIX/lib/libpng.dylib ]; then

            install_name_tool -change "@rpath/libpng16.16.dylib" "$SRB2BLDPREFIX/lib/libpng.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libpng16.16.dylib" "$SRB2BLDPREFIX/lib/libpng.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libpng.dylib" ]; then

            install_name_tool -change "@rpath/libpng16.16.dylib" "$HOMEBREWPREFIX/lib/libpng.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libpng16.16.dylib" "$HOMEBREWPREFIX/lib/libpng.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$MACPORTPREFIX/lib/libpng.dylib" ]; then

            install_name_tool -change "@rpath/libpng16.16.dylib" "$MACPORTPREFIX/lib/libpng.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libpng16.16.dylib" "$MACPORTPREFIX/lib/libpng.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f $SRB2BLDPREFIX/lib/libdiscord-rpc.dylib ]; then

            install_name_tool -change "@rpath/libdiscord-rpc.dylib" "$SRB2BLDPREFIX/lib/libdiscord-rpc.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libdiscord-rpc.dylib" "$SRB2BLDPREFIX/lib/libdiscord-rpc.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libdiscord-rpc.dylib" ]; then

            install_name_tool -change "@rpath/libdiscord-rpc.dylib" "$HOMEBREWPREFIX/lib/libdiscord-rpc.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libdiscord-rpc.dylib" "$HOMEBREWPREFIX/lib/libdiscord-rpc.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$MACPORTPREFIX/lib/libdiscord-rpc.dylib" ]; then

            install_name_tool -change "@rpath/libdiscord-rpc.dylib" "$MACPORTPREFIX/lib/libdiscord-rpc.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libdiscord-rpc.dylib" "$MACPORTPREFIX/lib/libdiscord-rpc.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f $SRB2BLDPREFIX/lib/libopenvr_api.dylib ]; then

            install_name_tool -change "@rpath/libopenvr_api.dylib" "$SRB2BLDPREFIX/lib/libopenvr_api.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libopenvr_api.dylib" "$SRB2BLDPREFIX/lib/libopenvr_api.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$HOMEBREWPREFIX/lib/libopenvr_api.dylib" ]; then

            install_name_tool -change "@rpath/libopenvr_api.dylib" "$HOMEBREWPREFIX/lib/libopenvr_api.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libopenvr_api.dylib" "$HOMEBREWPREFIX/lib/libopenvr_api.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

        if [ -f "$MACPORTPREFIX/lib/libopenvr_api.dylib" ]; then

            install_name_tool -change "@rpath/libopenvr_api.dylib" "$MACPORTPREFIX/lib/libopenvr_api.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"
            install_name_tool -change "libopenvr_api.dylib" "$MACPORTPREFIX/lib/libopenvr_api.dylib" "$BUILD/build/bin/$BUILDNAME.app/Contents/MacOS/$BUILDNAME"

        fi

    fi

    # Building App Bundle.
    if [ "$APPBUNDLE" = 1 ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Building $BUILDNAME's App Bundle. Please wait..."

        if [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

            mkdir -p "$BUILD/build/WADCLI"
            mv -f "$BUILD/build/wadcli" "$BUILD/build/WADCLI"
            cd "$BUILD/build/WADCLI"
            ln -sf /Applications Application
            cd "$BUILD"
            hdiutil create -srcfolder "$BUILD/WADCLI" "$BUILD/build/WADCLI.dmg"

        elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

            mkdir -p "$BUILD/build/$BUILDNAME-$GITVER-$COMREV" "$BUILD/build/slade.app/Contents/Frameworks"
            APPBUNDLELIBS=$(otool -L "$BUILD/build/slade.app/Contents/MacOS/slade" | gawk '/.dylib/ && !/usr\/lib/ {print $1}')
            cp -f $APPBUNDLELIBS "$BUILD/build/slade.app/Contents/Frameworks"

            for l in $APPBUNDLELIBS; do

                LIBNAME=$($PRINTF "%s\n" "$l" | gawk -F'/' '{print $NF}')
                install_name_tool -change "$l" "@executable_path/../Frameworks/$LIBNAME" "$BUILD/build/slade.app/Contents/MacOS/slade"

            done

            mv -f "$BUILD/build/slade.app" "$BUILD/build/$BUILDNAME-$GITVER-$COMREV/$BUILDNAME.app"
            cd "$BUILD/build/$BUILDNAME-$GITVER-$COMREV"
            ln -sf /Applications Application
            cp -f "$BUILD/LICENSE" "$BUILD/build/$BUILDNAME-$GITVER-$COMREV"
            cd "$BUILD"
            hdiutil create -srcfolder "$BUILD/build/$BUILDNAME-$GITVER-$COMREV" -format UDZO -fs HFS+ "$BUILD/build/$BUILDNAME.dmg"

        else

            make -k -j$(($(sysctl -n hw.logicalcpu) + 1)) -C "$BUILD/build" package

        fi

    # Installing build's binary, assets, libraries, icons and desktop file to the system.
    else

        SRB2MACPATH="$SRB2BLDPREFIX/opt/srb2-apps/$BUILDNAME.app"

        removeduplicate

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's binary, assets, libraries, icons and desktop file to the system. Please wait..."

        if [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

            sudo mkdir -p $SRB2BLDPREFIX/opt/srb2-apps
            sudo mv -f "$BUILD/wadcli" $SRB2BLDPREFIX/opt/srb2-apps

        elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

            sudo mkdir -p $SRB2BLDPREFIX/opt/srb2-apps
            sudo mv -f "$BUILD/build/slade.app" "$SRB2MACPATH"

        else

            sudo -E make -C "$BUILD/build" install

        fi

        # Saving configuration flags for future upgrades.
        $PRINTF "%s\n" "$CONF" > "$BUILD/conf"

        if [ -n "$(cat "$BUILD/conf")" ]; then

            CONF=$(cat "$BUILD/conf")

        fi

        # Adding path to commit revision file.
        COMREVFILEPATH="$BUILD/.comrev"

        # Making symbolic link to .app file in /Applications.
        SRB2MACLINK="/Applications/$BUILDNAME.app"
        sudo rm -rf "$SRB2MACLINK"
        sudo ln -sf "$SRB2MACPATH" "$SRB2MACLINK"

    fi
}

installtowindows() {
    # Saving configuration flags to variable.
    if [ -n "$(cat "$BUILD/conf")" ]; then

        CONF=$(cat "$BUILD/conf")

    fi

    # Adding path to commit revision file.
    COMREVFILEPATH="$BUILD/.comrev"

    removeduplicate

    # Installing build's binary, assets, libraries, icons and desktop files to the system.
    $PRINTF "$MESSAGE\n%s\n\e[0m" "Installing $BUILDNAME's binary, assets, libraries, icons and desktop files to the system. Please wait..."

    if [ "$BUILD" = "$BUILDPATH/srb2" ]; then

        SRB2WINDIR="SRB2"
        SRB2WINMENUDIR="Sonic Robo Blast 2"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-uncapped-plus" ]; then

        SRB2WINDIR="SRB2 Uncapped Plus"
        SRB2WINMENUDIR="Sonic Robo Blast 2 Uncapped PLUS"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-netplus" ]; then

        SRB2WINDIR="SRB2 NetPlus"
        SRB2WINMENUDIR="Sonic Robo Blast 2 NetPlus"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-rphys" ]; then

        SRB2WINDIR="SRB2 rphys"
        SRB2WINMENUDIR="Sonic Robo Blast 2 rphys"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-vr" ]; then

        SRB2WINDIR="SRB2 VR"
        SRB2WINMENUDIR="Sonic Robo Blast 2 VR"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -openvr -win" > "$SRB2WINPATH/$SRB2WINDIR (OpenVR).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.1-legacy" ]; then

        SRB2WINDIR="SRB2 v2.1 Legacy"
        SRB2WINMENUDIR="Sonic Robo Blast 2 v2.1 Legacy"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/exchndl.dll" "$BUILD/build/AppDir/usr/lib/libFLAC"*.dll "$BUILD/build/AppDir/usr/lib/libmodplug"*.dll "$BUILD/build/AppDir/usr/lib/libmpg123"*.dll "$BUILD/build/AppDir/usr/lib/libogg"*.dll "$BUILD/build/AppDir/usr/lib/libopus"*.dll "$BUILD/build/AppDir/usr/lib/libopusfile"*.dll "$BUILD/build/AppDir/usr/lib/libvorbis"*.dll "$BUILD/build/AppDir/usr/lib/libvorbisfile"*.dll "$BUILD/build/AppDir/usr/lib/mgwhelp.dll" "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-2.0" ]; then

        SRB2WINDIR="SRB2 v2.0"
        SRB2WINMENUDIR="Sonic Robo Blast 2 v2.0"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/r_opengl.dll" "$BUILD/build/AppDir/usr/lib/fmod.dll" "$SRB2WINPATH"
        touch "$SRB2WINPATH/md2.dat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-final-demo" ]; then

        SRB2WINDIR="SRB2 Final Demo"
        SRB2WINMENUDIR="Sonic Robo Blast 2 Final Demo"
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-persona" ]; then

        SRB2WINDIR="SRB2 Persona"
        SRB2WINMENUDIR="Sonic Robo Blast 2 Persona"
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart" ]; then

        SRB2WINDIR="SRB2 Kart"
        SRB2WINMENUDIR="Sonic Robo Blast 2 Kart"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2Kart/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/mgwhelp.dll" "$BUILD/build/AppDir/usr/lib/libvorbis"*.dll "$BUILD/build/AppDir/usr/lib/libvorbisfile"*.dll "$BUILD/build/AppDir/usr/lib/libopus"*.dll "$BUILD/build/AppDir/usr/lib/libopusfile"*.dll "$BUILD/build/AppDir/usr/lib/libogg"*.dll "$BUILD/build/AppDir/usr/lib/libmpg123"*.dll "$BUILD/build/AppDir/usr/lib/libmodplug"*.dll "$BUILD/build/AppDir/usr/lib/libFLAC"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart-moe-mansion" ]; then

        SRB2WINDIR="SRB2 Kart Moe Mansion"
        SRB2WINMENUDIR="Sonic Robo Blast 2 Kart Moe Mansion"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2Kart/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/mgwhelp.dll" "$BUILD/build/AppDir/usr/lib/libvorbis"*.dll "$BUILD/build/AppDir/usr/lib/libvorbisfile"*.dll "$BUILD/build/AppDir/usr/lib/libopus"*.dll "$BUILD/build/AppDir/usr/lib/libopusfile"*.dll "$BUILD/build/AppDir/usr/lib/libogg"*.dll "$BUILD/build/AppDir/usr/lib/libmpg123"*.dll "$BUILD/build/AppDir/usr/lib/libmodplug"*.dll "$BUILD/build/AppDir/usr/lib/libFLAC"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]; then

        SRB2WINDIR="SRB2 Kart VR"
        SRB2WINMENUDIR="Sonic Robo Blast 2 Kart VR"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -name "$SRB2WINBIN" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/SRB2Kart/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/lib/mgwhelp.dll" "$BUILD/build/AppDir/usr/lib/libvorbis"*.dll "$BUILD/build/AppDir/usr/lib/libvorbisfile"*.dll "$BUILD/build/AppDir/usr/lib/libopus"*.dll "$BUILD/build/AppDir/usr/lib/libopusfile"*.dll "$BUILD/build/AppDir/usr/lib/libogg"*.dll "$BUILD/build/AppDir/usr/lib/libmpg123"*.dll "$BUILD/build/AppDir/usr/lib/libmodplug"*.dll "$BUILD/build/AppDir/usr/lib/libFLAC"*.dll "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -openvr -win" > "$SRB2WINPATH/$SRB2WINDIR (OpenVR).bat"

    elif [ "$(dirname $BUILD)" = "$BUILDPATH/srb2-custom" ]; then

        SRB2WINDIR="SRB2 Custom $CUSTOMDIR"
        SRB2WINMENUDIR="Sonic Robo Blast 2 Custom $CUSTOMDIR"
        SRB2WINBIN=$(find "$BUILD/bin" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/SRB2 Games/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf $(find "$BUILD/bin" -type f 2> /dev/null | head -n1) "$SRB2WINPATH"
        cp -rf "$BUILD/build/AppDir/usr/games/$ASSETAPPDIR/"* "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"

        if [ -f "$(find "$BUILD/build/AppDir/usr/lib" -name "libgcc_s_sjlj"*.dll -type f 2> /dev/null | head -n1)" ]; then

            cp -rf "$BUILD/build/AppDir/usr/lib/libgcc_s_sjlj"*.dll "$BUILD/build/AppDir/usr/lib/libstdc++"*.dll "$BUILD/build/AppDir/usr/lib/libfluidsynth"*.dll "$BUILD/build/AppDir/usr/lib/openmpt-"*.dll "$SRB2WINPATH"

        else

            cp -rf "$BUILD/build/AppDir/usr/lib/mgwhelp.dll" "$BUILD/build/AppDir/usr/lib/libvorbis"*.dll "$BUILD/build/AppDir/usr/lib/libvorbisfile"*.dll "$BUILD/build/AppDir/usr/lib/libopus"*.dll "$BUILD/build/AppDir/usr/lib/libopusfile"*.dll "$BUILD/build/AppDir/usr/lib/libogg"*.dll "$BUILD/build/AppDir/usr/lib/libmpg123"*.dll "$BUILD/build/AppDir/usr/lib/libmodplug"*.dll "$BUILD/build/AppDir/usr/lib/libFLAC"*.dll "$SRB2WINPATH"

        fi

        $PRINTF "@echo off\nstart $SRB2WINBIN -software" > "$SRB2WINPATH/$SRB2WINDIR (Software).bat"
        $PRINTF "@echo off\nstart $SRB2WINBIN -opengl" > "$SRB2WINPATH/$SRB2WINDIR (OpenGL).bat"

    elif [ "$BUILD" = "$BUILDPATH/wadcli" ]; then

        SRB2WINDIR="wadcli"
        SRB2WINMENUDIR="wadcli"
        SRB2WINBIN=$(find "$BUILD" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf "$BUILD/$SRB2WINBIN" "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN" > "$SRB2WINPATH/$SRB2WINDIR.bat"

    elif [ "$BUILD" = "$BUILDPATH/slade" ]; then

        SRB2WINDIR="slade"
        SRB2WINMENUDIR="slade"
        SRB2WINBIN=$(find "$BUILD" -name "*.exe" -type f 2> /dev/null | gawk -F'/' '{print $NF}' | head -n1)
        SRB2WINPATH="$HOME/$SRB2WINDIR"
        SRB2WINMENUPATH="$HOME/Start Menu/Programs/$SRB2WINMENUDIR"
        DEPS=$(while read -r FILE; do
            find "$BUILD/build/AppDir/usr/lib" -name "$FILE"
        done < "$BUILD/deps")
        mkdir -p "$SRB2WINPATH"
        cp -rf "$BUILD/$SRB2WINBIN" "$SRB2WINPATH"
        cp -rf $DEPS "$SRB2WINPATH"
        $PRINTF "@echo off\nstart $SRB2WINBIN" > "$SRB2WINPATH/$SRB2WINDIR.bat"

    fi

    # Using VBScript to create menu entry for Windows.
    if [ "$BUILD" = "$BUILDPATH/wadcli" ] || [ "$BUILD" = "$BUILDPATH/slade" ]; then

        cat > "$BUILD/build/CreateShortcut.vbs" << WINMENUSHORTCUT
Set oWS = CreateObject("WScript.Shell")
strHomeFolder = oWS.ExpandEnvironmentStrings("%USERPROFILE%")

Set oFSO = CreateObject("Scripting.FileSystemObject")
oFSO.CreateFolder strHomeFolder & "\\Start Menu\\Programs\\$SRB2WINMENUDIR"

Set oWS = WScript.CreateObject("WScript.Shell")
sLinkFile = strHomeFolder & "\\Start Menu\\Programs\\$SRB2WINMENUDIR\\$SRB2WINDIR.bat.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR\\$SRB2WINDIR.bat"
oLink.WorkingDirectory = strHomeFolder & "\\$SRB2WINDIR"
oLink.IconLocation = strHomeFolder & "\\$SRB2WINDIR\\$SRB2WINBIN"
oLink.Save
WINMENUSHORTCUT

    else

        cat > "$BUILD/build/CreateShortcut.vbs" << WINMENUSHORTCUT
Set oWS = CreateObject("WScript.Shell")
strHomeFolder = oWS.ExpandEnvironmentStrings("%USERPROFILE%")

Set oFSO = CreateObject("Scripting.FileSystemObject")
oFSO.CreateFolder strHomeFolder & "\\Start Menu\\Programs\\$SRB2WINMENUDIR"

Set oWS = WScript.CreateObject("WScript.Shell")
sLinkFile = strHomeFolder & "\\Start Menu\\Programs\\$SRB2WINMENUDIR\\$SRB2WINDIR (Software).bat.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR\\$SRB2WINDIR (Software).bat"
oLink.WorkingDirectory = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR"
oLink.IconLocation = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR\\$SRB2WINBIN"
oLink.Save

sLinkFile = strHomeFolder & "\\Start Menu\\Programs\\$SRB2WINMENUDIR\\$SRB2WINDIR (OpenGL).bat.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR\\$SRB2WINDIR (OpenGL).bat"
oLink.WorkingDirectory = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR"
oLink.IconLocation = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR\\$SRB2WINBIN"
oLink.Save
WINMENUSHORTCUT

    fi

    if [ "$BUILD" = "$BUILDPATH/srb2-vr" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]; then

        cat >> "$BUILD/build/CreateShortcut.vbs" << WINMENUSHORTCUT
sLinkFile = strHomeFolder & "\\Start Menu\\Programs\\$SRB2WINMENUDIR\\$SRB2WINDIR (OpenVR).bat.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR\\$SRB2WINDIR (OpenVR).bat"
oLink.WorkingDirectory = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR"
oLink.IconLocation = strHomeFolder & "\\SRB2 Games\\$SRB2WINDIR\\$SRB2WINBIN"
oLink.Save
WINMENUSHORTCUT

    fi

    cscript "$BUILD/build/CreateShortcut.vbs" 2> /dev/null
}

listasset() {
    clear

    if [ -z "$(find "$SRB2BLDROOT/assets" -mindepth 1 -maxdepth 1 -type f 2> /dev/null | sort)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find downloaded assets."
        exit

    fi

    # List downloaded assets.
    find "$SRB2BLDROOT/assets" -mindepth 1 -maxdepth 1 -type f -printf "\033[1;97m%P\n\033[0m" 2> /dev/null | gawk -F'/' '{print $NF}' | sort
}

listbuild() {
    clear

    if [ -z "$(find "$SRB2BLDROOT/builds" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | sort)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find downloaded builds."
        exit

    fi

    # List downloaded source code.
    find "$SRB2BLDROOT/builds" ! -iname srb2-custom -mindepth 1 -maxdepth 1 -type d -printf "\033[1;97m%P\n\033[0m" 2> /dev/null | sort
    $PRINTF "\e[1;97msrb2-custom\e[0m$(find "$SRB2BLDROOT/builds/srb2-custom" -mindepth 1 -maxdepth 1 -type d -printf "\n├%P" 2> /dev/null)\n"

}

listconfig() {
    clear

    if [ -z "$(find "$SRB2BLDROOT/installed" -mindepth 1 -maxdepth 1 -type f 2> /dev/null | sort)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find installed builds."
        exit

    fi

    # List configuration flags for installed build.
    $PRINTF "$MESSAGE%s\n\e[0m" "Please choose installed build by typing number and then pressing enter. Press enter or ctrl+c to quit."
    array=$(find "$SRB2BLDROOT/installed" -mindepth 1 -maxdepth 1 -type f 2> /dev/null | sort)
    arrayname=$($PRINTF "%s\n" "$array" | gawk -F'/' '{print $NF}')
    count="$($PRINTF "%s\n" "$array" | wc -l)"
    n=""
    $PRINTF "%s\n" "$arrayname" | gawk '{print NR")", $0}'
    while true; do

        $PRINTF "#? "
        read -r n

        if [ -n "$n" ] && [ "$n" -eq "$n" ] && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then

            CONF=$($PRINTF "%s\n" "$array" | gawk NR=="${n}")
            $PRINTF "%s\n" ""
            $PRINTF "$PROMPT%s\n\e[0m" "$(gawk '/---------------/ {gsub("---------------","");getline;print}' "$CONF")"
            break

        else

            $PRINTF "$NOTICE\n%s\n\e[0m" "No option has been chosen."
            exit

        fi

    done
}

listinstalled() {
    clear

    if [ -z "$(find "$SRB2BLDROOT/installed" -mindepth 1 -maxdepth 1 -type f 2> /dev/null | sort)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find installed builds."
        exit

    fi

    # List files for installed build.
    $PRINTF "$MESSAGE%s\n\e[0m" "Please choose installed build by typing number and then pressing enter. Press enter or ctrl+c to quit."
    array=$(find "$SRB2BLDROOT/installed" -mindepth 1 -maxdepth 1 -type f 2> /dev/null | sort)
    arrayname=$($PRINTF "%s\n" "$array" | gawk -F'/' '{print $NF}')
    count="$($PRINTF "%s\n" "$array" | wc -l)"
    n=""
    $PRINTF "%s\n" "$arrayname" | gawk '{print NR")", $0}'
    while true; do

        $PRINTF "#? "
        read -r n

        if [ -n "$n" ] && [ "$n" -eq "$n" ] && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then

            CONF=$($PRINTF "%s\n" "$array" | gawk NR=="${n}")
            $PRINTF "%s\n" ""
            $PRINTF "$PROMPT%s\n\e[0m" "$(gawk '/^/,/---------------/ {gsub("---------------","");print}' "$CONF")"
            break

        else

            $PRINTF "$NOTICE\n%s\n\e[0m" "No option has been chosen."
            exit

        fi

    done
}

preparebuild() {
    # Make directories for storing essential files.
    $PRINTF "$MESSAGE\n%s\n\e[0m" "Preparing directories to store $BUILDNAME's source code, assets and libraries. Please wait..."
    if [ "$OS" = "Darwin" ]; then

        mkdir -p "$SRB2BLDROOT/builds" "$SRB2BLDROOT/assets" "$SRB2BLDROOT/libraries" "$BUILD/assets/installer"

    else

        mkdir -p "$SRB2BLDROOT/builds" "$SRB2BLDROOT/assets" "$SRB2BLDROOT/libraries" "$BUILD/build/AppDir/usr/bin" "$BUILD/build/AppDir/usr/games" "$BUILD/build/AppDir/usr/lib" "$BUILD/build/AppDir/usr/share/applications"

        if [ "$BUILD" = "$BUILDPATH/srb2-kart" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-moe-mansion" ] || [ "$BUILD" = "$BUILDPATH/srb2-kart-vr" ]; then

            ASSETAPPDIR="SRB2Kart"
            mkdir -p "$BUILD/build/AppDir/usr/games/$ASSETAPPDIR"

        elif [ "$BUILD" != "$BUILDPATH/wadcli" ] && [ "$BUILD" != "$BUILDPATH/slade" ]; then

            ASSETAPPDIR="SRB2"
            mkdir -p "$BUILD/build/AppDir/usr/games/$ASSETAPPDIR"

        fi

    fi

    cd "$BUILD" || exit

    if [ "$BUILD" != "$BUILDPATH/wadcli" ] && [ "$BUILD" != "$BUILDPATH/slade" ]; then

        if [ "$GITVER" != "$GITDEFVER" ]; then

            # Set branch in build's configuration directory name.
            GITVERCONF="$GITVER"

            # Set asset's path, if branch was set to other than default.
            if [ -z "$SRB2BLDASSETPATH" ] || [ "$(dirname $BUILD)" != "$BUILDPATH/srb2-custom" ]; then

                $PRINTF "$MESSAGE\n%s\e[0m" "Please enter $BUILDNAME's assets path, or just press enter to download and extract the latest SRB2/SRB2Kart stable release assets. Supported links/paths:
	- websites with direct link to file, for example, \"https://github.com/STJr/SRB2/releases/download/SRB2_release_2.2.10/SRB2-v2210-Full.zip\",
	- mega.nz,
	- drive.google.com,
	- dropbox.com,
	- full path to downloaded archived file in formats supported by p7zip (https://www.7-zip.org) or full path to directory with build's assets, for example $HOME/Downloads/SRB2.zip for Linux and macOS or C:\Downloads\SRB2.zip for Windows.
"
                $PRINTF "$PROMPT\n%s\e[0m" "> "
                read -r SRB2BLDASSETPATH

            fi

            # Assume default branch and latest SRB2/SRB2Kart assets, if entered nothing in prompt.
            if [ -z "$SRB2BLDASSETPATH" ] && [ -z "$UPGRADE" ]; then

                $PRINTF "$MESSAGE\n%s\n\e[0m" "Assuming the latest SRB2/SRB2Kart release assets for $BUILDNAME."
                GITVER="$GITDEFVER"

            # Set to custom asset's path locally or remotely.
            else

                # Fixing Windows path to source code to be found by script.
                if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

                    SRB2BLDASSETPATH=$($PRINTF "%s\n" "$SRB2BLDASSETPATH" | gawk 'gsub("\\\\","\\\\");{print}' | gawk '!a[$0]++ {print}')

                fi

                if [ -n "$(find "$SRB2BLDASSETPATH" 2> /dev/null | head -n1)" ]; then

                    FILETYPE=$(find "$SRB2BLDASSETPATH" 2> /dev/null | gawk -F'.' '{print $NF}' | head -n1)
                    $PRINTF "$MESSAGE\n%s\n\e[0m" "Copying assets. Please wait..."
                    sleep 1

                    # Copy directory with assets to script's data path.
                    if [ "$(file -b "$SRB2BLDASSETPATH" 2> /dev/null)" = "directory" ]; then

                        if [ "$OS" = "Darwin" ]; then

                            cp -rf "$SRB2BLDASSETPATH/"* "$BUILD/build/assets/installer/$ASSETAPPDIR"

                        else

                            cp -rf "$SRB2BLDASSETPATH/"* "$BUILD/build/AppDir/usr/games/$ASSETAPPDIR"

                        fi

                    # Copy archived file of assets to script's data path.
                    else

                        cp -rf "$SRB2BLDASSETPATH" "$SRB2BLDROOT/assets/$($PRINTF "%s\n" "$BUILD" | gawk -F'/' '{print $NF}')-$GITVER.$FILETYPE"

                    fi

                fi

            fi

        fi

    fi
}

settrap() {
    # Trigger certain commands with trap signals.
    if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

        if [ "$SRB2BLDDEVMODE" = 1 ]; then

            trap '$PRINTF "$SUCCESS\n\n%s\n\e[0m" "Exiting shell script. Please wait..." ; exit' 0 1 2 3 6 15

        else

            trap '$PRINTF "$SUCCESS\n\n%s\n\e[0m" "Cleaning up source code and exiting shell script. Please wait..." ; cleansource ; exit' 0 1 2 3 6 15

        fi

    else

        if [ "$SRB2BLDDEVMODE" = 1 ]; then

            trap '$PRINTF "$SUCCESS\n\n%s\n\e[0m" "Exiting shell script. Please wait..." ; sudo_ping stop ; exit' 0 1 2 3 6 15

        else

            trap '$PRINTF "$SUCCESS\n\n%s\n\e[0m" "Cleaning up source code and exiting shell script. Please wait..." ; cleansource ; sudo_ping stop ; exit' 0 1 2 3 6 15

        fi

    fi
}

sudo_ping() {
    # Make sudo to extend password timeout.
    if [ -n "$SUDO_PID" ]; then

        if [ "$1" = stop ]; then

            kill "$SUDO_PID"
            return

        else

            return

        fi

    fi

    sudo -v

    if [ $? -eq 1 ]; then

        return

    fi

    while true; do

        sudo -v
        sleep 30

    done &
    SUDO_PID=$!
}

removeduplicate() {
    # Removing previously installed files before installing the latest one.
    if [ "$($PRINTF "%s\n" "$SRB2BLDPREFIX" | gawk 'match($0, /\/usr\/local|\/home\/'$USER'\/.local|\/home\/'$USER'\/Local|\/home\/'$USER'\/SRB2 Games|\/Start Menu\/Programs/) {print substr($0, RSTART, RLENGTH)}')" != "$(gawk 'match($0, /\/usr\/local|\/home\/'$USER'\/.local|\/home\/'$USER'\/Local|\/home\/'$USER'\/SRB2 Games|\/Start Menu\/Programs/) {print substr($0, RSTART, RLENGTH)}' "$SRB2BLDROOT/installed/$($PRINTF "%s\n" "$BUILD" | gawk -F'/' '{print $NF}')" | head -n1)" ] && [ -f "$SRB2BLDROOT/installed/$($PRINTF "%s\n" "$BUILD" | gawk -F'/' '{print $NF}')" ] && [ -z "$UPGRADE" ]; then

        BUILDINSTALLED="$SRB2BLDROOT/installed/$($PRINTF "%s\n" "$BUILD" | gawk -F'/' '{print $NF}')"
        $PRINTF "$MESSAGE\n%s\n\e[0m" "Removing previously installed build in other path. Please wait..."
        sleep 1
        gawk -i inplace -v RS= '{gsub("---------------\n[A-Z]*=1|---------------","");print}' "$BUILDINSTALLED"

        if [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]; then

            while read -r FILE; do
                rm -rfv "$FILE"
            done < "$BUILDINSTALLED"

        else

            while read -r FILE; do
                $SUDO rm -rfv "$FILE"
            done < "$BUILDINSTALLED"

        fi

        rm -rfv "$BUILDINSTALLED"

    fi

}

upgrade() {
    clear

    checkuserid

    if [ -z "$(find "$BUILDPATH" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | gawk -F'/' '{print $NF}' | sort)" ]; then

        $PRINTF "$FAILURE%s\n\e[0m" "ERROR: Can't find installed builds."
        exit

    fi

    ISNET=$(curl -vI https://github.com 2>&1 | gawk '/> Host:/ {gsub("\r","");print $NF}')

    # Make a loop to find the SRB2 source code directories and then update them one by one.
    for u in $(find "$BUILDPATH" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | gawk -F'/' '{print $NF}' | sort -u); do

        if [ "$u" = "srb2-custom" ]; then

            for d in $(find "$BUILDPATH/$u" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | gawk -F'/' '{print $NF}' | sort -u); do

                export BUILD="$BUILDPATH/$u/$d"
                export GITVER=$(tail -n+2 "$BUILD/.comrev" 2> /dev/null)
                export CUSTOMDIR="$d"
                upgradetasks

            done

        else

            export BUILD="$BUILDPATH/$u"
            export GITVER=$(tail -n+2 "$BUILD/.comrev" 2> /dev/null)
            upgradetasks

        fi

    done && $PRINTF "$SUCCESS\n%s\n\e[0m\a" "Upgrading is successful."
}

upgradetasks() {
    buildname

    if [ "$SRB2BLDDEVMODE" != 1 ]; then

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Cleaning up $BUILDNAME's source code. Please wait..."
        cleansource

    fi

    $PRINTF "$MESSAGE\n%s\n\e[0m" "Updating $BUILDNAME's source code. Please wait..."
    git -C "$BUILD" pull --recurse-submodules --rebase --autostash

    if [ -f "$BUILD/.comrev" ] && [ "$(git -C "$BUILD" rev-parse --short HEAD)" != "$(head -n1 "$BUILD/.comrev")" ]; then

        export UPGRADE="$u"

        # Checking installation prefix for to be upgraded build.
        if [ -n "$UPGRADE" ] && [ -z "$CUSTOMDIR" ]; then

            SRB2BLDPREFIX="$(gawk 'match($0, /\/usr\/local|\/home\/'$USER'\/.local|\/home\/'$USER'\/Local/) {print substr($0, RSTART, RLENGTH)}' "$SRB2BLDROOT/installed/$UPGRADE" | head -n1)"

        elif [ -n "$UPGRADE" ] && [ -n "$CUSTOMDIR" ]; then

            SRB2BLDPREFIX="$(gawk 'match($0, /\/usr\/local|\/home\/'$USER'\/.local|\/home\/'$USER'\/Local/) {print substr($0, RSTART, RLENGTH)}' "$SRB2BLDROOT/installed/$CUSTOMDIR" | head -n1)"

        fi

        if [ -z "$SRB2BLDPREFIX" ]; then

            SRB2BLDPREFIX="/usr/local"

        fi

        $PRINTF "$MESSAGE\n%s\n\e[0m" "Upgrading $BUILDNAME. Please wait..."

        buildname

        preparebuild

        if [ "$OS" = "Darwin" ]; then

            settrap

            installtomacos

            installtolist

        else

            if [ "$OS" = "Linux" ]; then

                sudo_ping

            fi

            dockerentry

            settrap

            dockerrun

        fi

        if ([ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW64" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW32" ] || [ "$($PRINTF "%s\n" "$OS" | gawk -F'_' '{print $1}')" = "MINGW" ]) && ([ -f "$(find "$BUILD/bin" -name "*.exe" 2> /dev/null | head -n1)" ] || [ -f "$(find "$BUILD/build" -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ] || [ -f "$(find "$BUILD" -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ]); then

            installtowindows

            installtolist

        elif [ "$OS" = "Linux" ] && ([ -f "$(find "$BUILD/build/AppDir/usr/bin" -mindepth 1 -maxdepth 1 2> /dev/null | head -n1)" ] || [ -f "$(find $BUILD/build -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ] || [ -f "$(find "$BUILD" -mindepth 1 -maxdepth 1 -executable -type f | head -n1)" ]); then

            installtolinux

        fi

    fi
}

usage() {
    clear

    $PRINTF "%s\n" "
Build and install SRB2/SRB2Kart from source.

Usage: srb2bld [OPTIONS]
  OPTIONS:
     -h, --help                             Show this help text.
     -ab, --appbundle                       Compile and create distributable App Bundle of SRB2/SRB2Kart build, which is packaged in DMG file (macOS only).
     -ai, --appimage                        Compile and create distributable AppImage of SRB2/SRB2Kart build (Linux only).
     -c, --compatibility                    Display compatibility table of compiling SRB2/SRB2Kart builds for each operating system.
     -i, --install                          Compile and install SRB2/SRB2Kart build.
     -la, --listasset                       List downloaded SRB2/SRB2Kart assets.
     -lb, --listbuild                       List downloaded SRB2/SRB2Kart builds.
     -lc, --listconfig                      List compilation flags of installed SRB2/SRB2Kart builds.
     -li, --listinstalled                   List installed SRB2/SRB2Kart builds.
     -ra, --removeasset                     Remove downloaded asset for SRB2/SRB2Kart build.
     -rb, --removebuild                     Remove downloaded source code for SRB2/SRB2Kart build.
     -u, --user                             Install build to user's home directory (only works with -i/--install).
     -ui, --uninstall                       Uninstall SRB2/SRB2Kart build.
     -up, --upgrade                         Upgrade installed SRB2/SRB2Kart build.

  EXAMPLES:
     1. Compile and install SRB2/SRB2Kart build globally:
            srb2bld --install

     2. Compile and install SRB2/SRB2Kart build to user's home directory:
            srb2bld --install --user

     3. Compile and create AppImage of SRB2/SRB2Kart build (Linux only):
            srb2bld --appimage

     4. List installed SRB2/SRB2Kart builds:
            srb2bld --listinstalled

     5. Uninstall SRB2/SRB2Kart build:
            srb2bld --uninstall

     6. Display compatibility table of compiling SRB2/SRB2Kart builds for each operating system:
            srb2bld --compatibility

  NOTES:
     1. Old builds like SRB2 v2.0 and SRB2 Final Demo may not build/run properly on modern Linux distributions/macOS/Windows.

     2. WARNING for macOS users! This script makes changes from rpath to absolute paths within some libraries installed from Homebrew, MacPorts or compiled (mostly should affects libraries compiled by user), that are associated with SRB2 binary, so installing or making App Bundles would be successful. In the future this could make unexpected results with apps or SRB2 builds, that depend on those libraries.

     3. If you want to compile some builds with DiscordRPC support (SRB2 Uncapped Plus, SRB2 NetPlus, SRB2 Kart, SRB2 Kart Moe Mansion and SRB2 Kart VR), then type \"HAVE_DISCORDRPC=1\" (Linux/Windows) or \"-DSRB2_CONFIG_HAVE_DISCORDRPC=ON\" (macOS), when the script asks about optional compilation flags (using \"srb2bld --install\" command).

     4. If on Linux you get error with \"/dev/fuse\" or FUSE when running script, then load fuse module with \"sudo modprobe fuse\". You can write \"fuse\" in configuration file, usually in file \"/etc/modules\" or \"/etc/modules-load.d/fuse.conf\" or \"/etc/conf.d/modules/fuse.conf\", to automatically load this module at boot.

     5. If 64-bit Linux system has issues with creating or loading \"Sonic Robo Blast 2 Final Demo\" (AppImage or installed), make sure you have installed 32-bit versions of FUSE and glibc:

         - Debian/Ubuntu/Debian based/Ubuntu based: \"sudo dpkg --add-architecture i386 && sudo apt update && sudo apt install fuse:i386 libc6:i386 zlib1g:i386\",

         - Arch/Arch based: uncomment the [multilib] section in /etc/pacman.conf and do \"sudo pacman -Syu --needed\" and then use one of the AUR helpers that you have installed - \"pikaur -S --needed lib32-fuse2 lib32-glibc\" or \"paru -S --needed lib32-fuse2 lib32-glibc\" or \"yay -S --needed lib32-fuse2 lib32-glibc\",

         - Gentoo/Gentoo based: \"ABI_X86=32 sudo -E emerge -av sys-fs/fuse sys-libs/glibc\",

         - Fedora/Fedora based: \"sudo dnf install fuse-libs.i686 glibc.i686\" for Fedora Workstation/Server or \"rpm-ostree install -A --allow-inactive fuse-libs.i686 glibc.i686\" for Fedora Silverblue/Kinoite,

         - OpenSUSE/OpenSUSE based: \"sudo zypper in libfuse2-32bit glibc-32bit\",

         - Void: \"sudo xbps-install -S void-repo-multilib && sudo xbps-install -Su && sudo xbps-install -S fuse-32bit glibc-32bit\".

     6. If Linux system has issue with running build because of not found compiled libraries, even though they are installed, set: export LD_LIBRARY_PATH=\"/usr/local/lib:\$LD_LIBRARY_PATH\" in \"~/.bash_profile\" or \"~/.zshrc\".

     7. There are couple of patches applied within source code of games. Their purpose is to prevent conflicts of installing/running of multiple builds overlapping each other with the same names of directories for storing assets and configuration/saves. Other patches include fixing compilation for some builds on particular systems.

     8. If you choose branch other than default, configuration directory's name will be changed, for example \".srb2\" will become \".srb2udmf\", if \"udmf\" was chosen. Still remember to make backup of configuration/save files, before upgrading to next release of SRB2/SRB2Kart build, if you chose default branch or kept previously chosen different branch.

     9. In order to compile and install custom SRB2/SRB2Kart build (assuming it is not a very old one) from local or remote repository, write environment variables in shell's configuration file, like \".bash_profile\" or \".zshrc\", which are:

          - SRB2BLDGITPATH - path to local or remote repository,

          - SRB2BLDGITVER - chosen branch to download build from remote repository,

          - SRB2BLDASSETPATH - path to assets from local or remote path (supported links/paths:
               - websites with direct link to file, for example, \"https://github.com/STJr/SRB2/releases/download/SRB2_release_2.2.10/SRB2-v2210-Full.zip\",
               - mega.nz,
               - drive.google.com,
               - dropbox.com,
               - full path to downloaded archived file in formats supported by p7zip (https://www.7-zip.org) or full path to directory with build's assets, fo
r example $HOME/Downloads/SRB2.zip for Linux and macOS or C:\Downloads\SRB2.zip for Windows.)

          EXAMPLES:
               1. export SRB2BLDGITPATH=\"https://github.com/STJr/SRB2\"

               2. export SRB2BLDGITPATH=\"https://git.do.srb2.org/TehRealSalt/SRB2\"

               3. export SRB2BLDGITPATH=\"\$HOME/Builds/SRB2\"

               4. export SRB2BLDGITPATH=\"C:\Builds\SRB2\"

               5. export SRB2BLDGITVER=\"udmf\"

               6. export SRB2BLDGITVER=\"master\"

               7. export SRB2BLDASSETPATH=\"https://github.com/STJr/SRB2/releases/download/SRB2_release_2.2.10/SRB2-v2210-Full.zip\"

               8. export SRB2BLDASSETPATH=\"https://mega.nz/file/JQswBDAA#IPXWeTmrXrI9YZx6zUznJQ2uIAHryv_WP1JxWfnKbts\"

               9. export SRB2BLDASSETPATH=\"https://drive.google.com/file/d/1Vc-lHph8MxlnfaBZnv0NNpoFKhehmce6\"

               10. export SRB2BLDASSETPATH=\"https://www.dropbox.com/s/5neoderzan6mbh3/SRB2PERSONA%20v1.3.3%20Full%20Installer.exe\"

               11. export SRB2BLDASSETPATH=\"\$HOME/Downloads/SRB2-Full.zip\"

               12. export SRB2BLDASSETPATH=\"C:\Downloads\SRB2-Full.zip\"

               13. export SRB2BLDASSETPATH=\"\$HOME/Downloads/SRB2-Full\"

               14. export SRB2BLDASSETPATH=\"C:\Downloads\SRB2-Full\"

          Then choose \"Build SRB2 Custom\", when running script.

     10. Other environment variables to use. To activate them with value \"1\", do for example \"export SRB2BLDDEBUG=1\":

         - SRB2BLDDEBUG - Getting verbose output from script. Useful for reporting issues at https://github.com/bijman/srb2bld/issues.

         - SRB2BLDDEVMODE - For developers, that want to modify build's source code. Disables cleaning and resetting changes to build's source code.
"
}

case "$1" in

    -h | --help)

        usage

        ;;

    "")

        defaultmessage

        ;;

    -ab | --appbundle)

        appbundle

        ;;

    -ai | --appimage)

        appimage

        ;;

    -c | --compatibility)

        compatibility

        ;;

    -i | --install)

        chooseinstall

        ;;

    -la | --listasset)

        listasset

        ;;

    -lb | --listbuild)

        listbuild

        ;;

    -lc | --listconfig)

        listconfig

        ;;

    -li | --listinstalled)

        listinstalled

        ;;

    -ra | --removeasset)

        chooseremoveasset

        ;;

    -rb | --removebuild)

        chooseremovebuild

        ;;

    -ui | --uninstall)

        chooseuninstall

        ;;

    -up | --upgrade)

        upgrade

        ;;

esac
